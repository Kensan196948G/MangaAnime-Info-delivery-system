name: ğŸš¨ å¤±æ•—æ™‚è‡ªå‹•Issueä½œæˆ

# ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ãŸæ™‚ã«è‡ªå‹•ã§Issueä½œæˆ
on:
  workflow_run:
    workflows:
      - "CI Pipeline"
    types:
      - completed

permissions:
  issues: write
  contents: read

jobs:
  create-issue-on-failure:
    name: å¤±æ•—æ™‚Issueä½œæˆ
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸš¨ å¤±æ•—Issueä½œæˆ
        uses: actions/github-script@v7
        with:
          script: |
            const workflow = context.payload.workflow_run;
            const title = `ğŸš¨ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—: ${workflow.name}`;
            const body = `## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ

**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${workflow.name}
**å®Ÿè¡ŒID**: ${workflow.id}
**ã‚³ãƒŸãƒƒãƒˆ**: ${workflow.head_sha}
**ãƒ–ãƒ©ãƒ³ãƒ**: ${workflow.head_branch}
**å®Ÿè¡Œæ™‚åˆ»**: ${workflow.created_at}
**å®Ÿè¡ŒURL**: ${workflow.html_url}

### å¯¾å¿œãŒå¿…è¦ã§ã™

ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

cc: @${context.repo.owner}
`;

            // æ—¢å­˜ã®åŒã˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—Issueã‚’ç¢ºèª
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure,auto-generated',
              per_page: 10
            });

            const duplicateIssue = existingIssues.data.find(issue =>
              issue.title.includes(workflow.name)
            );

            if (duplicateIssue) {
              // æ—¢å­˜Issueã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: duplicateIssue.number,
                body: `### ğŸ”„ å†åº¦å¤±æ•—ã—ã¾ã—ãŸ

**å®Ÿè¡ŒID**: ${workflow.id}
**å®Ÿè¡Œæ™‚åˆ»**: ${workflow.created_at}
**å®Ÿè¡ŒURL**: ${workflow.html_url}

å¼•ãç¶šãå¯¾å¿œãŒå¿…è¦ã§ã™ã€‚`
              });

              console.log(`æ—¢å­˜Issue #${duplicateIssue.number} ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã—ã¾ã—ãŸ`);
            } else {
              // æ–°è¦Issueä½œæˆ
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['workflow-failure', 'auto-generated', 'bug']
              });

              console.log(`æ–°è¦Issue #${issue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
            }
