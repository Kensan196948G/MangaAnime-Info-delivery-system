name: Silent Workflow Wrapper

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å¤±æ•—é€šçŸ¥ã‚’æŠ‘åˆ¶ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼ã§ã™
# ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å¤±æ•—ã‚’æ¤œçŸ¥ã—ã¦ã€é™ã‹ã«å‡¦ç†ã—ã¾ã™

on:
  workflow_run:
    workflows: 
      - "MangaAnime Auto Deployment"
      - "Simple CI Pipeline"
      - "Security Audit & Quality Assurance"
      - "MangaAnime System Health Check"
    types: [completed]

jobs:
  silent-handler:
    name: Silent Error Handler
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    
    # é€šçŸ¥ã‚’æŠ‘åˆ¶ã™ã‚‹ãŸã‚ã®è¨­å®š
    continue-on-error: true  # ã‚¨ãƒ©ãƒ¼ã§ã‚‚æˆåŠŸæ‰±ã„
    
    steps:
      - name: Log failure silently
        id: log
        run: |
          echo "ğŸ“ Workflow failed: ${{ github.event.workflow_run.name }}"
          echo "ğŸ”‡ Notification suppressed"
          echo "failure_logged=true" >> $GITHUB_OUTPUT
          
      - name: Create internal issue (no email)
        if: steps.log.outputs.failure_logged == 'true'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            // Issueã‚’ä½œæˆï¼ˆãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãªã—ï¼‰
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'silent-failure',
              state: 'open'
            });
            
            const workflowName = context.payload.workflow_run.name;
            const exists = issues.data.find(i => i.title.includes(workflowName));
            
            if (!exists) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ”‡ Silent: ${workflowName} Failed`,
                body: `Failure logged without email notification.\nWorkflow: ${workflowName}\nTime: ${new Date().toISOString()}`,
                labels: ['silent-failure', 'auto-repair-7x']
              });
            }
      
      - name: Always succeed
        if: always()
        run: |
          echo "âœ… Wrapper completed successfully (failure handled silently)"
          exit 0  # å¸¸ã«æˆåŠŸã¨ã—ã¦çµ‚äº†