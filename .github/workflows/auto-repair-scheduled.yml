name: ğŸ”§ è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ15åˆ†ãŠãå®šæœŸå®Ÿè¡Œç‰ˆï¼‰

# 15åˆ†ã”ã¨ã«è‡ªå‹•å®Ÿè¡Œ
on:
  schedule:
    # 15åˆ†ã”ã¨: */15 * * * *
    - cron: '*/15 * * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°'
        required: false
        default: '15'
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-repair:
    name: ğŸ”§ è‡ªå‹•ä¿®å¾©ï¼ˆ15å›ãƒ«ãƒ¼ãƒ—ï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 14  # 15åˆ†ä»¥å†…ã«å®Œäº†

    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install black isort flake8

      - name: ğŸ” ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
        id: detect
        run: |
          # æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
          echo "error_count=0" >> $GITHUB_OUTPUT

          # Flake8ãƒã‚§ãƒƒã‚¯ï¼ˆé‡å¤§ãªã‚¨ãƒ©ãƒ¼ã®ã¿ï¼‰
          flake8 app modules --count --select=E9,F63,F7,F82 > flake8_errors.txt 2>&1 || true

          error_count=$(cat flake8_errors.txt | tail -1 || echo "0")
          echo "error_count=$error_count" >> $GITHUB_OUTPUT

          if [ "$error_count" -gt 0 ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
        if: steps.detect.outputs.has_errors == 'true'
        run: |
          echo "ğŸ”§ ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã€‚è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™..."

          # Black auto-format
          black app modules

          # isort importæ•´ç†
          isort app modules

          echo "âœ… è‡ªå‹•ä¿®å¾©å®Œäº†"

      - name: âœ… ä¿®å¾©ã‚³ãƒŸãƒƒãƒˆ
        if: steps.detect.outputs.has_errors == 'true'
        run: |
          git config user.name "Auto Repair Bot"
          git config user.email "auto-repair@github-actions"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "[è‡ªå‹•ä¿®å¾©] ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©å®Ÿè¡Œï¼ˆ15åˆ†ãŠãå®šæœŸå®Ÿè¡Œï¼‰

æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: ${{ steps.detect.outputs.error_count }}
ä¿®å¾©å†…å®¹: black auto-format, isortå®Ÿè¡Œ

ğŸ¤– Auto Repair System (15min interval)
"
            git push origin main
            echo "âœ… ä¿®å¾©ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          else
            echo "å¤‰æ›´ãªã—ï¼ˆä¿®å¾©ä¸è¦ï¼‰"
          fi

      - name: ğŸ“Š çµæœã‚µãƒãƒªãƒ¼
        run: |
          echo "## ğŸ”§ è‡ªå‹•ä¿®å¾©çµæœ"
          echo ""
          echo "- ã‚¨ãƒ©ãƒ¼æ¤œå‡º: ${{ steps.detect.outputs.has_errors }}"
          echo "- ã‚¨ãƒ©ãƒ¼æ•°: ${{ steps.detect.outputs.error_count }}"

          if [ "${{ steps.detect.outputs.has_errors }}" = "true" ]; then
            echo "- ä¿®å¾©å®Ÿè¡Œ: âœ… å®Œäº†"
          else
            echo "- ä¿®å¾©å®Ÿè¡Œ: ä¸è¦ï¼ˆã‚¨ãƒ©ãƒ¼ãªã—ï¼‰"
          fi

      - name: ğŸš¨ å¤±æ•—æ™‚Issueä½œæˆ
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸš¨ è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ï¼ˆ15åˆ†ãŠãå®Ÿè¡Œï¼‰';
            const body = `## è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

**å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toISOString()}
**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: è‡ªå‹•ä¿®å¾©ï¼ˆ15åˆ†ãŠãï¼‰

ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

cc: @${context.repo.owner}
`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['auto-repair', 'bug', 'è‡ªå‹•ç”Ÿæˆ']
            });
