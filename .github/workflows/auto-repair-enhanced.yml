name: Auto Repair System Enhanced

on:
  schedule:
    - cron: '*/15 * * * *'
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'modules/**'
      - 'tests/**'
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run tests'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.12'

jobs:
  detect-errors:
    name: Detect Errors
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      error_summary: ${{ steps.summary.outputs.summary }}
      total_errors: ${{ steps.summary.outputs.total }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install flake8 black isort bandit
          pip install -r requirements.txt || true

      - name: Check syntax errors
        id: syntax
        continue-on-error: true
        run: |
          flake8 app modules --count --select=E9,F63,F7,F82 --show-source --statistics > syntax_errors.txt 2>&1 || true
          error_count=$(tail -1 syntax_errors.txt | grep -oE '^[0-9]+' || echo "0")
          echo "count=$error_count" >> $GITHUB_OUTPUT

      - name: Check import errors
        id: imports
        continue-on-error: true
        run: |
          import_errors=0
          for file in $(find app modules -name "*.py" -type f 2>/dev/null); do
            python3 -c "import ast; ast.parse(open('$file').read())" 2>/dev/null || ((import_errors++)) || true
          done
          echo "count=$import_errors" >> $GITHUB_OUTPUT

      - name: Security scan
        id: security
        continue-on-error: true
        run: |
          bandit -r app modules -ll -ii -f txt > security_report.txt 2>&1 || true
          high_issues=$(grep -c "Severity: High" security_report.txt 2>/dev/null || echo "0")
          echo "high=$high_issues" >> $GITHUB_OUTPUT

      - name: Create summary
        id: summary
        run: |
          syntax_errors="${{ steps.syntax.outputs.count }}"
          import_errors="${{ steps.imports.outputs.count }}"
          security_high="${{ steps.security.outputs.high }}"

          syntax_errors=${syntax_errors:-0}
          import_errors=${import_errors:-0}
          security_high=${security_high:-0}

          total=$((syntax_errors + import_errors + security_high))
          summary="Syntax:${syntax_errors} Import:${import_errors} Security:${security_high}"

          echo "summary=$summary" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT

          echo "## Error Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax | $syntax_errors |" >> $GITHUB_STEP_SUMMARY
          echo "| Import | $import_errors |" >> $GITHUB_STEP_SUMMARY
          echo "| Security (High) | $security_high |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$total** |" >> $GITHUB_STEP_SUMMARY

      - name: Upload error reports
        if: steps.summary.outputs.total != '0'
        uses: actions/upload-artifact@v4
        with:
          name: error-reports
          path: |
            syntax_errors.txt
            security_report.txt
          retention-days: 7

  auto-repair:
    name: Auto Repair
    needs: detect-errors
    runs-on: ubuntu-latest
    if: needs.detect-errors.outputs.total_errors != '0'
    timeout-minutes: 10
    outputs:
      repair_status: ${{ steps.repair.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install repair tools
        run: pip install black isort autoflake

      - name: Run auto repair
        id: repair
        run: |
          autoflake --in-place --remove-all-unused-imports --recursive app modules || true
          black app modules --quiet || true
          isort app modules --quiet || true

          flake8 app modules --count --select=E9,F63,F7,F82 > post_repair.txt 2>&1 || true
          remaining=$(tail -1 post_repair.txt | grep -oE '^[0-9]+' || echo "0")

          if [ "$remaining" -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=partial" >> $GITHUB_OUTPUT
          fi

      - name: Commit repairs
        run: |
          git config user.name "Auto Repair Bot"
          git config user.email "auto-repair@github-actions"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "[Auto Repair] ${{ needs.detect-errors.outputs.error_summary }}"
            git push
          fi

  create-issue:
    name: Create Issue
    needs: [detect-errors, auto-repair]
    runs-on: ubuntu-latest
    if: always() && needs.detect-errors.outputs.total_errors != '0' && needs.auto-repair.outputs.repair_status == 'partial'
    timeout-minutes: 5

    steps:
      - name: Create issue for manual fix
        uses: actions/github-script@v7
        with:
          script: |
            const errorSummary = '${{ needs.detect-errors.outputs.error_summary }}';
            const totalErrors = '${{ needs.detect-errors.outputs.total_errors }}';
            const today = new Date().toISOString().split('T')[0];

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-repair'
            });

            const existingIssue = issues.data.find(i => i.title.includes(today));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[Auto Detect] Errors ' + totalErrors + ' - ' + today,
                body: '## Error Detection Report\n\n' + errorSummary + '\n\nManual fix required.\n\n---\nAuto Repair System',
                labels: ['auto-repair', 'bug']
              });
            }

  run-tests:
    name: Run Tests
    needs: [detect-errors, auto-repair]
    runs-on: ubuntu-latest
    if: always() && (github.event.inputs.run_tests == 'true' || github.event_name == 'push')
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov
          pip install -r requirements.txt || true

      - name: Run tests
        continue-on-error: true
        run: |
          pytest tests/ --tb=short -x --timeout=60 2>&1 | tee test_output.txt || true

          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          if grep -q "passed" test_output.txt; then
            passed=$(grep -oE '[0-9]+ passed' test_output.txt | grep -oE '[0-9]+' || echo "0")
            failed=$(grep -oE '[0-9]+ failed' test_output.txt | grep -oE '[0-9]+' || echo "0")
            echo "Passed: $passed, Failed: $failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Test execution error" >> $GITHUB_STEP_SUMMARY
          fi

  notify-success:
    name: Notify Success
    needs: [detect-errors]
    runs-on: ubuntu-latest
    if: always() && needs.detect-errors.outputs.total_errors == '0'
    timeout-minutes: 2

    steps:
      - name: Success message
        run: |
          echo "## Auto Repair System - OK" >> $GITHUB_STEP_SUMMARY
          echo "No errors detected." >> $GITHUB_STEP_SUMMARY
