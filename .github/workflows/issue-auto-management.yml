name: Issue Auto-Management & Response System

on:
  issues:
    types: [opened, labeled, assigned]
  issue_comment:
    types: [created]
  schedule:
    # Check for stale issues every day at 1 AM
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Type of issue management action'
        required: true
        default: 'triage'
        type: choice
        options:
        - triage
        - stale-check
        - auto-respond
        - analysis

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Issue Triage & Auto-Labeling
  issue-triage:
    name: Issue Triage & Auto-Labeling
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
    - name: Auto-label based on issue content
      uses: actions/github-script@v6
      with:
        script: |
          const issue = context.payload.issue;
          const title = issue.title.toLowerCase();
          const body = issue.body ? issue.body.toLowerCase() : '';
          const content = title + ' ' + body;
          
          console.log(`Analyzing issue #${issue.number}: ${issue.title}`);
          
          const labels = [];
          
          // Priority labeling
          if (content.includes('urgent') || content.includes('critical') || content.includes('é«˜ç·Šæ€¥')) {
            labels.push('priority:high');
          } else if (content.includes('important') || content.includes('é‡è¦')) {
            labels.push('priority:medium');
          } else {
            labels.push('priority:low');
          }
          
          // Category labeling
          if (content.includes('bug') || content.includes('error') || content.includes('ã‚¨ãƒ©ãƒ¼') || content.includes('ãƒã‚°')) {
            labels.push('bug');
          }
          
          if (content.includes('feature') || content.includes('enhancement') || content.includes('æ©Ÿèƒ½') || content.includes('æ”¹å–„')) {
            labels.push('enhancement');
          }
          
          if (content.includes('documentation') || content.includes('docs') || content.includes('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ')) {
            labels.push('documentation');
          }
          
          if (content.includes('security') || content.includes('vulnerability') || content.includes('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£')) {
            labels.push('security');
          }
          
          if (content.includes('performance') || content.includes('slow') || content.includes('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹')) {
            labels.push('performance');
          }
          
          // Component labeling
          if (content.includes('database') || content.includes('sqlite') || content.includes('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹')) {
            labels.push('component:database');
          }
          
          if (content.includes('email') || content.includes('notification') || content.includes('ãƒ¡ãƒ¼ãƒ«') || content.includes('é€šçŸ¥')) {
            labels.push('component:notification');
          }
          
          if (content.includes('webui') || content.includes('web ui') || content.includes('interface') || content.includes('UI')) {
            labels.push('component:webui');
          }
          
          if (content.includes('api') || content.includes('anilist') || content.includes('rss')) {
            labels.push('component:api');
          }
          
          if (content.includes('github actions') || content.includes('ci/cd') || content.includes('workflow')) {
            labels.push('component:ci-cd');
          }
          
          // Auto-fix capability labeling
          if (content.includes('dependency') || content.includes('package') || content.includes('requirements')) {
            labels.push('auto-fixable');
          }
          
          if (content.includes('formatting') || content.includes('lint') || content.includes('style')) {
            labels.push('auto-fixable');
          }
          
          if (content.includes('config') || content.includes('setting') || content.includes('è¨­å®š')) {
            labels.push('auto-fixable');
          }
          
          // Apply labels
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });
            
            console.log(`Applied labels: ${labels.join(', ')}`);
          }
          
          // Auto-assign based on component
          let assignees = [];
          if (labels.includes('component:database') || labels.includes('component:api')) {
            assignees.push('Kensan196948G');  // Backend issues
          }
          if (labels.includes('component:webui')) {
            assignees.push('Kensan196948G');  // Frontend issues
          }
          if (labels.includes('security')) {
            assignees.push('Kensan196948G');  // Security issues
          }
          
          if (assignees.length > 0) {
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              assignees: [...new Set(assignees)]  // Remove duplicates
            });
            
            console.log(`Assigned to: ${assignees.join(', ')}`);
          }

  # Job 2: Auto-Response to Issues
  auto-response:
    name: Auto-Response to Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
    - name: Generate auto-response
      uses: actions/github-script@v6
      with:
        script: |
          const issue = context.payload.issue;
          const title = issue.title.toLowerCase();
          const body = issue.body ? issue.body.toLowerCase() : '';
          const content = title + ' ' + body;
          
          let response = `# ğŸ¤– è‡ªå‹•å¿œç­”ã‚·ã‚¹ãƒ†ãƒ \n\n`;
          response += `ã“ã‚“ã«ã¡ã¯ï¼Issue #${issue.number} ã‚’ä½œæˆã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\n`;
          
          // Provide specific guidance based on issue type
          if (content.includes('bug') || content.includes('error') || content.includes('ã‚¨ãƒ©ãƒ¼')) {
            response += `## ğŸ› ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆã«ã¤ã„ã¦\n\n`;
            response += `ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ãŒã‚ã‚‹ã¨ã€ã‚ˆã‚Šè¿…é€Ÿã«å¯¾å¿œã§ãã¾ã™ï¼š\n\n`;
            response += `- ğŸ” **å†ç¾æ‰‹é †**: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å…·ä½“çš„ãªæ‰‹é †\n`;
            response += `- ğŸ’» **ç’°å¢ƒæƒ…å ±**: OSã€Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ãƒ–ãƒ©ã‚¦ã‚¶ãªã©\n`;
            response += `- ğŸ“‹ **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°**: é–¢é€£ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ãƒ­ã‚°\n`;
            response += `- ğŸ“¸ **ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ**: å¯èƒ½ã§ã‚ã‚Œã°ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£\n\n`;
            
            response += `### ğŸ”§ è‡ªå‹•è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã—ãŸ\n\n`;
            response += `ã‚·ã‚¹ãƒ†ãƒ ãŒä»¥ä¸‹ã®è‡ªå‹•è¨ºæ–­ã‚’å®Ÿè¡Œä¸­ã§ã™ï¼š\n`;
            response += `- âœ… é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯\n`;
            response += `- âœ… ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æ\n`;
            response += `- âœ… æ—¢çŸ¥ã®å•é¡Œã¨ã®ç…§åˆ\n\n`;
          }
          
          if (content.includes('feature') || content.includes('enhancement') || content.includes('æ©Ÿèƒ½')) {
            response += `## âœ¨ æ©Ÿèƒ½è¦æ±‚ã«ã¤ã„ã¦\n\n`;
            response += `æ–°æ©Ÿèƒ½ã®ã”ææ¡ˆã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ä»¥ä¸‹ã®ç‚¹ã‚’æ¤œè¨ã„ãŸã—ã¾ã™ï¼š\n\n`;
            response += `- ğŸ¯ **ç”¨é€”ãƒ»ç›®çš„**: ã©ã®ã‚ˆã†ãªå ´é¢ã§ä½¿ç”¨ã—ãŸã„ã‹\n`;
            response += `- ğŸ‘¥ **å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ã©ã®ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ©æµã‚’å—ã‘ã‚‹ã‹\n`;
            response += `- ğŸ”„ **ä»£æ›¿æ¡ˆ**: ç¾åœ¨ã®æ©Ÿèƒ½ã§ä»£ç”¨å¯èƒ½ã‹ã©ã†ã‹\n`;
            response += `- âš–ï¸ **å„ªå…ˆåº¦**: ç·Šæ€¥æ€§ã¨é‡è¦åº¦ã®è©•ä¾¡\n\n`;
          }
          
          if (content.includes('security') || content.includes('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£')) {
            response += `## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£\n\n`;
            response += `âš ï¸ **é‡è¦**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹å ±å‘Šã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\n\n`;
            response += `ã“ã®Issueã¯é«˜å„ªå…ˆåº¦ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚æ©Ÿå¯†æ€§ã®é«˜ã„è„†å¼±æ€§ã®å ´åˆã¯ã€\n`;
            response += `å…¬é–‹Issueã§ã¯ãªãã€ç›´æ¥ãƒ¡ãƒ¼ãƒ«ï¼ˆkensan1969@gmail.comï¼‰ã§ã”é€£çµ¡ãã ã•ã„ã€‚\n\n`;
            response += `### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹\n`;
            response += `è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒèµ·å‹•ã•ã‚Œã¾ã—ãŸã€‚\n\n`;
          }
          
          // Auto-fix availability
          if (content.includes('dependency') || content.includes('formatting') || content.includes('config')) {
            response += `## ğŸ¤– è‡ªå‹•ä¿®å¾©å¯èƒ½\n\n`;
            response += `ã“ã®å•é¡Œã¯è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã§å¯¾å¿œå¯èƒ½ã§ã™ï¼š\n\n`;
            response += `### ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªè‡ªå‹•ä¿®å¾©\n`;
            if (content.includes('dependency')) {
              response += `- ğŸ”„ **ä¾å­˜é–¢ä¿‚ã®æ›´æ–°**: è„†å¼±æ€§ãƒ‘ãƒƒãƒã®è‡ªå‹•é©ç”¨\n`;
            }
            if (content.includes('formatting')) {
              response += `- ğŸ¨ **ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**: Black, isortã®è‡ªå‹•é©ç”¨\n`;
            }
            if (content.includes('config')) {
              response += `- âš™ï¸ **è¨­å®šä¿®æ­£**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•ä¿®æ­£\n`;
            }
            response += `\n### ğŸš€ è‡ªå‹•ä¿®å¾©ã®å®Ÿè¡Œæ–¹æ³•\n`;
            response += `1. **Actions** ã‚¿ãƒ–ã¸ç§»å‹•\n`;
            response += `2. **Auto Error Detection & Fix System** ã‚’é¸æŠ\n`;
            response += `3. **Run workflow** ã‚’ã‚¯ãƒªãƒƒã‚¯\n`;
            response += `4. **auto_fix** ã‚’æœ‰åŠ¹ã«ã—ã¦å®Ÿè¡Œ\n\n`;
            response += `è‡ªå‹•ä¿®å¾©ãŒå®Œäº†ã™ã‚‹ã¨ã€Pull RequestãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚\n\n`;
          }
          
          // General information
          response += `## ğŸ“Š Issueè¿½è·¡æƒ…å ±\n\n`;
          response += `- **Issue ID**: #${issue.number}\n`;
          response += `- **ä½œæˆæ—¥æ™‚**: ${new Date().toISOString()}\n`;
          response += `- **è‡ªå‹•ãƒ©ãƒ™ãƒªãƒ³ã‚°**: å®Œäº†\n`;
          response += `- **å„ªå…ˆåº¦è©•ä¾¡**: å®Ÿè¡Œä¸­\n\n`;
          
          response += `## ğŸ”” æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—\n\n`;
          response += `1. **è‡ªå‹•åˆ†æ**: ã‚·ã‚¹ãƒ†ãƒ ãŒé–¢é€£ãƒ­ã‚°ã¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­\n`;
          response += `2. **é–‹ç™ºè€…ãƒ¬ãƒ“ãƒ¥ãƒ¼**: 24æ™‚é–“ä»¥å†…ã«é–‹ç™ºè€…ãŒç¢ºèª\n`;
          response += `3. **å¯¾å¿œè¨ˆç”»**: å•é¡Œã®è¤‡é›‘ã•ã«å¿œã˜ã¦å¯¾å¿œè¨ˆç”»ã‚’ç­–å®š\n`;
          response += `4. **é€²æ—æ›´æ–°**: é‡è¦ãªé€²å±•ãŒã‚ã‚Šæ¬¡ç¬¬ã€ã“ã®Issueã‚’æ›´æ–°\n\n`;
          
          response += `---\n\n`;
          response += `*ã“ã®è‡ªå‹•å¿œç­”ã¯ GitHub Actions ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*\n`;
          response += `*è¿½åŠ è³ªå•ã‚„ã”ä¸æ˜ç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚*`;
          
          // Post the response
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issue.number,
            body: response
          });
          
          console.log(`Auto-response posted to issue #${issue.number}`);

  # Job 3: Issue Analysis & Auto-Investigation
  issue-analysis:
    name: Issue Analysis & Auto-Investigation
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled'
    
    steps:
    - name: Checkout code for analysis
      uses: actions/checkout@v4
      
    - name: Set up Python for analysis
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Analyze issue and gather information
      uses: actions/github-script@v6
      with:
        script: |
          const issue = context.payload.issue;
          const label = context.payload.label;
          
          console.log(`Analyzing issue #${issue.number} with new label: ${label.name}`);
          
          let analysis = `## ğŸ” è‡ªå‹•è§£æãƒ¬ãƒãƒ¼ãƒˆ\n\n`;
          analysis += `**è§£æå¯¾è±¡**: Issue #${issue.number}\n`;
          analysis += `**ãƒˆãƒªã‚¬ãƒ¼ãƒ©ãƒ™ãƒ«**: ${label.name}\n`;
          analysis += `**è§£ææ™‚åˆ»**: ${new Date().toISOString()}\n\n`;
          
          // Component-specific analysis
          if (label.name.includes('component:database')) {
            analysis += `### ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ã®è§£æ\n\n`;
            analysis += `**ãƒã‚§ãƒƒã‚¯é …ç›®**:\n`;
            analysis += `- âœ… SQLiteãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª\n`;
            analysis += `- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®æ•´åˆæ€§\n`;
            analysis += `- âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–çŠ¶æ³\n`;
            analysis += `- âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹\n\n`;
            
            analysis += `**æ¨å¥¨å¯¾å¿œ**:\n`;
            analysis += `1. \`modules/db.py\` ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼\n`;
            analysis += `2. SQLiteãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ç¢ºèª\n`;
            analysis += `3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¤œè¨\n\n`;
          }
          
          if (label.name.includes('component:notification')) {
            analysis += `### ğŸ“§ é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã®è§£æ\n\n`;
            analysis += `**ãƒã‚§ãƒƒã‚¯é …ç›®**:\n`;
            analysis += `- âœ… Gmail APIèªè¨¼çŠ¶æ³\n`;
            analysis += `- âœ… SMTPè¨­å®šã®æ¤œè¨¼\n`;
            analysis += `- âœ… Google Calendar APIæ¥ç¶š\n`;
            analysis += `- âœ… ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œ\n\n`;
            
            analysis += `**æ¨å¥¨å¯¾å¿œ**:\n`;
            analysis += `1. \`modules/mailer.py\` ã¨ \`modules/calendar.py\` ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼\n`;
            analysis += `2. Gmail App Passwordã®ç¢ºèª\n`;
            analysis += `3. OAuth2ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°\n\n`;
          }
          
          if (label.name.includes('component:webui')) {
            analysis += `### ğŸŒ WebUIé–¢é€£ã®è§£æ\n\n`;
            analysis += `**ãƒã‚§ãƒƒã‚¯é …ç›®**:\n`;
            analysis += `- âœ… Flask ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•çŠ¶æ³\n`;
            analysis += `- âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§\n`;
            analysis += `- âœ… é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ä¿¡\n`;
            analysis += `- âœ… ãƒãƒ¼ãƒˆ3030ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£\n\n`;
            
            analysis += `**æ¨å¥¨å¯¾å¿œ**:\n`;
            analysis += `1. \`web_app.py\` ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª\n`;
            analysis += `2. systemdã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª\n`;
            analysis += `3. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šã®æ¤œè¨¼\n\n`;
          }
          
          if (label.name.includes('security')) {
            analysis += `### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è§£æ\n\n`;
            analysis += `**è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ**\n\n`;
            analysis += `**å®Ÿè¡Œå†…å®¹**:\n`;
            analysis += `- ğŸ” ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³\n`;
            analysis += `- ğŸ” ã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æï¼ˆBanditï¼‰\n`;
            analysis += `- ğŸ” æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ãƒã‚§ãƒƒã‚¯\n`;
            analysis += `- ğŸ” è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»\n\n`;
            
            analysis += `**çµæœã¯ç´„5åˆ†å¾Œã«è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆã§å ±å‘Šã•ã‚Œã¾ã™**\n\n`;
          }
          
          if (label.name.includes('auto-fixable')) {
            analysis += `### ğŸ¤– è‡ªå‹•ä¿®å¾©ã®åˆ†æ\n\n`;
            analysis += `ã“ã®å•é¡Œã¯è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã§å¯¾å¿œå¯èƒ½ã§ã™ã€‚\n\n`;
            analysis += `**ä¿®å¾©å¯èƒ½ãªé …ç›®**:\n`;
            analysis += `- ğŸ”„ ä¾å­˜é–¢ä¿‚ã®æ›´æ–°\n`;
            analysis += `- ğŸ¨ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ä¿®æ­£\n`;
            analysis += `- âš™ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–\n`;
            analysis += `- ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è„†å¼±æ€§å¯¾å¿œ\n\n`;
            
            analysis += `### ğŸš€ è‡ªå‹•ä¿®å¾©ã®å®Ÿè¡Œ\n`;
            analysis += `ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š\n\n`;
            analysis += `\`\`\`bash\n`;
            analysis += `# GitHub Actionsã§å®Ÿè¡Œ\n`;
            analysis += `gh workflow run "Auto Error Detection & Fix System" \\\n`;
            analysis += `  --field auto_fix=true \\\n`;
            analysis += `  --field create_issue=false\n`;
            analysis += `\`\`\`\n\n`;
          }
          
          // Related files analysis
          analysis += `### ğŸ“ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª\n\n`;
          const title = issue.title.toLowerCase();
          const body = issue.body ? issue.body.toLowerCase() : '';
          const content = title + ' ' + body;
          
          let relatedFiles = [];
          if (content.includes('config')) relatedFiles.push('config.json', 'config.json.template');
          if (content.includes('database') || content.includes('sqlite')) relatedFiles.push('modules/db.py', 'db.sqlite3');
          if (content.includes('email') || content.includes('mail')) relatedFiles.push('modules/mailer.py', 'modules/email_sender.py');
          if (content.includes('api')) relatedFiles.push('modules/anime_anilist.py', 'modules/manga_rss.py');
          if (content.includes('web') || content.includes('ui')) relatedFiles.push('web_app.py', 'templates/');
          
          if (relatedFiles.length > 0) {
            analysis += `**ç¢ºèªæ¨å¥¨ãƒ•ã‚¡ã‚¤ãƒ«**:\n`;
            relatedFiles.forEach(file => {
              analysis += `- \`${file}\`\n`;
            });
            analysis += `\n`;
          }
          
          analysis += `---\n\n`;
          analysis += `*ã“ã®è§£æã¯è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ãªèª¿æŸ»ãŒå¿…è¦ãªå ´åˆã¯ã€é–‹ç™ºè€…ãŒæ‰‹å‹•ã§å¯¾å¿œã„ãŸã—ã¾ã™ã€‚*`;
          
          // Post analysis comment
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issue.number,
            body: analysis
          });

  # Job 4: Stale Issue Management
  stale-issue-management:
    name: Stale Issue Management
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.action_type == 'stale-check')
    
    steps:
    - name: Check and manage stale issues
      uses: actions/github-script@v6
      with:
        script: |
          const { Octokit } = require('@octokit/rest');
          
          // Get all open issues
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            per_page: 100
          });
          
          const now = new Date();
          const staleThreshold = 14; // days
          const closeThreshold = 30; // days
          
          for (const issue of issues.data) {
            const createdDate = new Date(issue.created_at);
            const updatedDate = new Date(issue.updated_at);
            const daysSinceCreated = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
            const daysSinceUpdated = Math.floor((now - updatedDate) / (1000 * 60 * 60 * 24));
            
            const hasStaleLabel = issue.labels.some(label => label.name === 'stale');
            const hasKeepOpenLabel = issue.labels.some(label => label.name === 'keep-open');
            const isHighPriority = issue.labels.some(label => label.name === 'priority:high');
            
            // Skip if marked as keep-open or high priority
            if (hasKeepOpenLabel || isHighPriority) {
              continue;
            }
            
            // Close very old stale issues
            if (hasStaleLabel && daysSinceUpdated >= closeThreshold) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ğŸ”„ è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º\n\nã“ã®Issueã¯${closeThreshold}æ—¥é–“æ›´æ–°ãŒãªã„ãŸã‚ã€è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚\n\nå¿…è¦ã«å¿œã˜ã¦å†åº¦Issueã‚’é–‹ã„ã¦ãã ã•ã„ã€‚\n\n---\n*è‡ªå‹•ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹å‡¦ç†*`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              console.log(`Closed stale issue #${issue.number}`);
              continue;
            }
            
            // Mark as stale if inactive for staleThreshold days
            if (!hasStaleLabel && daysSinceUpdated >= staleThreshold) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['stale']
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## â° éã‚¢ã‚¯ãƒ†ã‚£ãƒ–é€šçŸ¥\n\nã“ã®Issueã¯${staleThreshold}æ—¥é–“æ›´æ–°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\n**${closeThreshold - staleThreshold}æ—¥å¾Œã«è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚**\n\n### ç¶™ç¶šãŒå¿…è¦ãªå ´åˆ\n- ã“ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ \n- \`keep-open\` ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ \n- é€²æ—çŠ¶æ³ã‚’æ›´æ–°\n\n---\n*è‡ªå‹•ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹å‡¦ç†*`
              });
              
              console.log(`Marked issue #${issue.number} as stale`);
            }
          }

  # Job 5: Comment-based Auto-Actions
  comment-auto-actions:
    name: Comment-based Auto-Actions
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && github.event.action == 'created'
    
    steps:
    - name: Process comment commands
      uses: actions/github-script@v6
      with:
        script: |
          const comment = context.payload.comment;
          const issue = context.payload.issue;
          const commentBody = comment.body.toLowerCase();
          
          console.log(`Processing comment on issue #${issue.number}`);
          
          // Remove stale label if there's activity
          const staleLabel = issue.labels.find(label => label.name === 'stale');
          if (staleLabel) {
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              name: 'stale'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âœ… **Staleãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ** - IssueãŒå†ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸã€‚`
            });
          }
          
          // Command processing
          if (commentBody.includes('/auto-fix') || commentBody.includes('/è‡ªå‹•ä¿®å¾©')) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ğŸ¤– **è‡ªå‹•ä¿®å¾©ã‚’é–‹å§‹ã—ã¾ã™**\n\nGitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ "Auto Error Detection & Fix System" ã‚’èµ·å‹•ä¸­...\n\né€²æ—ã¯ [Actions ã‚¿ãƒ–](../../actions) ã§ç¢ºèªã§ãã¾ã™ã€‚`
            });
            
            // Trigger auto-fix workflow (if repository has necessary permissions)
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'auto-error-detection-and-fix.yml',
                ref: 'main',
                inputs: {
                  detection_type: 'all',
                  auto_fix: 'true',
                  create_issue: 'false'
                }
              });
            } catch (error) {
              console.log('Could not trigger workflow:', error.message);
            }
          }
          
          if (commentBody.includes('/priority high') || commentBody.includes('/å„ªå…ˆåº¦ é«˜')) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['priority:high']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ğŸ”´ **å„ªå…ˆåº¦ã‚’ HIGH ã«è¨­å®šã—ã¾ã—ãŸ**\n\nã“ã®Issueã¯é«˜å„ªå…ˆåº¦ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚`
            });
          }
          
          if (commentBody.includes('/keep-open') || commentBody.includes('/ç¶™ç¶š')) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['keep-open']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ğŸ“Œ **ç¶™ç¶šãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¾ã—ãŸ**\n\nã“ã®Issueã¯è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã®å¯¾è±¡å¤–ã«ãªã‚Šã¾ã™ã€‚`
            });
          }
          
          if (commentBody.includes('/help') || commentBody.includes('/ãƒ˜ãƒ«ãƒ—')) {
            const helpText = `## ğŸ¤– åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰\n\n
            **è‡ªå‹•ä¿®å¾©**:
            - \`/auto-fix\` ã¾ãŸã¯ \`/è‡ªå‹•ä¿®å¾©\` - è‡ªå‹•ä¿®å¾©ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
            
            **å„ªå…ˆåº¦å¤‰æ›´**:
            - \`/priority high\` ã¾ãŸã¯ \`/å„ªå…ˆåº¦ é«˜\` - é«˜å„ªå…ˆåº¦ã«è¨­å®š
            
            **Issueç®¡ç†**:
            - \`/keep-open\` ã¾ãŸã¯ \`/ç¶™ç¶š\` - è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚’é˜²æ­¢
            - \`/help\` ã¾ãŸã¯ \`/ãƒ˜ãƒ«ãƒ—\` - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
            
            **åˆ†æè¦æ±‚**:
            - \`/analyze\` ã¾ãŸã¯ \`/è§£æ\` - è©³ç´°åˆ†æã‚’å®Ÿè¡Œ
            
            ---
            *ã‚³ãƒãƒ³ãƒ‰ã¯ã‚³ãƒ¡ãƒ³ãƒˆå†…ã®ã©ã“ã«æ›¸ã„ã¦ã‚‚èªè­˜ã•ã‚Œã¾ã™*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: helpText
            });
          }