name: Issue Auto-Management & Response System
true:
  issues:
    types:
    - opened
    - labeled
    - assigned
  issue_comment:
    types:
    - created
  schedule:
  - cron: 0 1 * * *
  workflow_dispatch:
    inputs:
      action_type:
        description: Type of issue management action
        required: true
        default: triage
        type: choice
        options:
        - triage
        - stale-check
        - auto-respond
        - analysis
env:
  PYTHON_VERSION: '3.11'
jobs:
  issue-triage:
    name: Issue Triage & Auto-Labeling
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
    - name: Auto-label based on issue content
      uses: actions/github-script@v6
      with:
        script: "const issue = context.payload.issue;\nconst title = issue.title.toLowerCase();\n\
          const body = issue.body ? issue.body.toLowerCase() : '';\nconst content\
          \ = title + ' ' + body;\n\nconsole.log(`Analyzing issue #${issue.number}:\
          \ ${issue.title}`);\n\nconst labels = [];\n\n// Priority labeling\nif (content.includes('urgent')\
          \ || content.includes('critical') || content.includes('\u9AD8\u7DCA\u6025\
          ')) {\n  labels.push('priority:high');\n} else if (content.includes('important')\
          \ || content.includes('\u91CD\u8981')) {\n  labels.push('priority:medium');\n\
          } else {\n  labels.push('priority:low');\n}\n\n// Category labeling\nif\
          \ (content.includes('bug') || content.includes('error') || content.includes('\u30A8\
          \u30E9\u30FC') || content.includes('\u30D0\u30B0')) {\n  labels.push('bug');\n\
          }\n\nif (content.includes('feature') || content.includes('enhancement')\
          \ || content.includes('\u6A5F\u80FD') || content.includes('\u6539\u5584\
          ')) {\n  labels.push('enhancement');\n}\n\nif (content.includes('documentation')\
          \ || content.includes('docs') || content.includes('\u30C9\u30AD\u30E5\u30E1\
          \u30F3\u30C8')) {\n  labels.push('documentation');\n}\n\nif (content.includes('security')\
          \ || content.includes('vulnerability') || content.includes('\u30BB\u30AD\
          \u30E5\u30EA\u30C6\u30A3')) {\n  labels.push('security');\n}\n\nif (content.includes('performance')\
          \ || content.includes('slow') || content.includes('\u30D1\u30D5\u30A9\u30FC\
          \u30DE\u30F3\u30B9')) {\n  labels.push('performance');\n}\n\n// Component\
          \ labeling\nif (content.includes('database') || content.includes('sqlite')\
          \ || content.includes('\u30C7\u30FC\u30BF\u30D9\u30FC\u30B9')) {\n  labels.push('component:database');\n\
          }\n\nif (content.includes('email') || content.includes('notification') ||\
          \ content.includes('\u30E1\u30FC\u30EB') || content.includes('\u901A\u77E5\
          ')) {\n  labels.push('component:notification');\n}\n\nif (content.includes('webui')\
          \ || content.includes('web ui') || content.includes('interface') || content.includes('UI'))\
          \ {\n  labels.push('component:webui');\n}\n\nif (content.includes('api')\
          \ || content.includes('anilist') || content.includes('rss')) {\n  labels.push('component:api');\n\
          }\n\nif (content.includes('github actions') || content.includes('ci/cd')\
          \ || content.includes('workflow')) {\n  labels.push('component:ci-cd');\n\
          }\n\n// Auto-fix capability labeling\nif (content.includes('dependency')\
          \ || content.includes('package') || content.includes('requirements')) {\n\
          \  labels.push('auto-fixable');\n}\n\nif (content.includes('formatting')\
          \ || content.includes('lint') || content.includes('style')) {\n  labels.push('auto-fixable');\n\
          }\n\nif (content.includes('config') || content.includes('setting') || content.includes('\u8A2D\
          \u5B9A')) {\n  labels.push('auto-fixable');\n}\n\n// Apply labels\nif (labels.length\
          \ > 0) {\n  await github.rest.issues.addLabels({\n    owner: context.repo.owner,\n\
          \    repo: context.repo.repo,\n    issue_number: issue.number,\n    labels:\
          \ labels\n  });\n  \n  console.log(`Applied labels: ${labels.join(', ')}`);\n\
          }\n\n// Auto-assign based on component\nlet assignees = [];\nif (labels.includes('component:database')\
          \ || labels.includes('component:api')) {\n  assignees.push('Kensan196948G');\
          \  // Backend issues\n}\nif (labels.includes('component:webui')) {\n  assignees.push('Kensan196948G');\
          \  // Frontend issues\n}\nif (labels.includes('security')) {\n  assignees.push('Kensan196948G');\
          \  // Security issues\n}\n\nif (assignees.length > 0) {\n  await github.rest.issues.addAssignees({\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    issue_number:\
          \ issue.number,\n    assignees: [...new Set(assignees)]  // Remove duplicates\n\
          \  });\n  \n  console.log(`Assigned to: ${assignees.join(', ')}`);\n}\n"
  auto-response:
    name: Auto-Response to Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
    - name: Generate auto-response
      uses: actions/github-script@v6
      with:
        script: "const issue = context.payload.issue;\nconst title = issue.title.toLowerCase();\n\
          const body = issue.body ? issue.body.toLowerCase() : '';\nconst content\
          \ = title + ' ' + body;\n\nlet response = `# \U0001F916 \u81EA\u52D5\u5FDC\
          \u7B54\u30B7\u30B9\u30C6\u30E0\\n\\n`;\nresponse += `\u3053\u3093\u306B\u3061\
          \u306F\uFF01Issue #${issue.number} \u3092\u4F5C\u6210\u3044\u305F\u3060\u304D\
          \u3001\u3042\u308A\u304C\u3068\u3046\u3054\u3056\u3044\u307E\u3059\u3002\
          \\n\\n`;\n\n// Provide specific guidance based on issue type\nif (content.includes('bug')\
          \ || content.includes('error') || content.includes('\u30A8\u30E9\u30FC'))\
          \ {\n  response += `## \U0001F41B \u30D0\u30B0\u30EC\u30DD\u30FC\u30C8\u306B\
          \u3064\u3044\u3066\\n\\n`;\n  response += `\u30D0\u30B0\u30EC\u30DD\u30FC\
          \u30C8\u3092\u3042\u308A\u304C\u3068\u3046\u3054\u3056\u3044\u307E\u3059\
          \u3002\u4EE5\u4E0B\u306E\u60C5\u5831\u304C\u3042\u308B\u3068\u3001\u3088\
          \u308A\u8FC5\u901F\u306B\u5BFE\u5FDC\u3067\u304D\u307E\u3059\uFF1A\\n\\\
          n`;\n  response += `- \U0001F50D **\u518D\u73FE\u624B\u9806**: \u30A8\u30E9\
          \u30FC\u304C\u767A\u751F\u3059\u308B\u5177\u4F53\u7684\u306A\u624B\u9806\
          \\n`;\n  response += `- \U0001F4BB **\u74B0\u5883\u60C5\u5831**: OS\u3001\
          Python\u30D0\u30FC\u30B8\u30E7\u30F3\u3001\u30D6\u30E9\u30A6\u30B6\u306A\
          \u3069\\n`;\n  response += `- \U0001F4CB **\u30A8\u30E9\u30FC\u30ED\u30B0\
          **: \u95A2\u9023\u3059\u308B\u30A8\u30E9\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\
          \u3084\u30ED\u30B0\\n`;\n  response += `- \U0001F4F8 **\u30B9\u30AF\u30EA\
          \u30FC\u30F3\u30B7\u30E7\u30C3\u30C8**: \u53EF\u80FD\u3067\u3042\u308C\u3070\
          \u753B\u9762\u30AD\u30E3\u30D7\u30C1\u30E3\\n\\n`;\n  \n  response += `###\
          \ \U0001F527 \u81EA\u52D5\u8A3A\u65AD\u3092\u958B\u59CB\u3057\u307E\u3057\
          \u305F\\n\\n`;\n  response += `\u30B7\u30B9\u30C6\u30E0\u304C\u4EE5\u4E0B\
          \u306E\u81EA\u52D5\u8A3A\u65AD\u3092\u5B9F\u884C\u4E2D\u3067\u3059\uFF1A\
          \\n`;\n  response += `- \u2705 \u95A2\u9023\u30B3\u30F3\u30DD\u30FC\u30CD\
          \u30F3\u30C8\u306E\u30D8\u30EB\u30B9\u30C1\u30A7\u30C3\u30AF\\n`;\n  response\
          \ += `- \u2705 \u30ED\u30B0\u30D5\u30A1\u30A4\u30EB\u306E\u89E3\u6790\\\
          n`;\n  response += `- \u2705 \u65E2\u77E5\u306E\u554F\u984C\u3068\u306E\u7167\
          \u5408\\n\\n`;\n}\n\nif (content.includes('feature') || content.includes('enhancement')\
          \ || content.includes('\u6A5F\u80FD')) {\n  response += `## \u2728 \u6A5F\
          \u80FD\u8981\u6C42\u306B\u3064\u3044\u3066\\n\\n`;\n  response += `\u65B0\
          \u6A5F\u80FD\u306E\u3054\u63D0\u6848\u3092\u3042\u308A\u304C\u3068\u3046\
          \u3054\u3056\u3044\u307E\u3059\uFF01\u4EE5\u4E0B\u306E\u70B9\u3092\u691C\
          \u8A0E\u3044\u305F\u3057\u307E\u3059\uFF1A\\n\\n`;\n  response += `- \U0001F3AF\
          \ **\u7528\u9014\u30FB\u76EE\u7684**: \u3069\u306E\u3088\u3046\u306A\u5834\
          \u9762\u3067\u4F7F\u7528\u3057\u305F\u3044\u304B\\n`;\n  response += `-\
          \ \U0001F465 **\u5BFE\u8C61\u30E6\u30FC\u30B6\u30FC**: \u3069\u306E\u3088\
          \u3046\u306A\u30E6\u30FC\u30B6\u30FC\u304C\u6069\u6075\u3092\u53D7\u3051\
          \u308B\u304B\\n`;\n  response += `- \U0001F504 **\u4EE3\u66FF\u6848**: \u73FE\
          \u5728\u306E\u6A5F\u80FD\u3067\u4EE3\u7528\u53EF\u80FD\u304B\u3069\u3046\
          \u304B\\n`;\n  response += `- \u2696\uFE0F **\u512A\u5148\u5EA6**: \u7DCA\
          \u6025\u6027\u3068\u91CD\u8981\u5EA6\u306E\u8A55\u4FA1\\n\\n`;\n}\n\nif\
          \ (content.includes('security') || content.includes('\u30BB\u30AD\u30E5\u30EA\
          \u30C6\u30A3')) {\n  response += `## \U0001F512 \u30BB\u30AD\u30E5\u30EA\
          \u30C6\u30A3\u95A2\u9023\\n\\n`;\n  response += `\u26A0\uFE0F **\u91CD\u8981\
          **: \u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u306B\u95A2\u3059\u308B\u5831\u544A\
          \u3092\u3042\u308A\u304C\u3068\u3046\u3054\u3056\u3044\u307E\u3059\u3002\
          \\n\\n`;\n  response += `\u3053\u306EIssue\u306F\u9AD8\u512A\u5148\u5EA6\
          \u3068\u3057\u3066\u51E6\u7406\u3055\u308C\u307E\u3059\u3002\u6A5F\u5BC6\
          \u6027\u306E\u9AD8\u3044\u8106\u5F31\u6027\u306E\u5834\u5408\u306F\u3001\
          \\n`;\n  response += `\u516C\u958BIssue\u3067\u306F\u306A\u304F\u3001\u76F4\
          \u63A5\u30E1\u30FC\u30EB\uFF08kensan1969@gmail.com\uFF09\u3067\u3054\u9023\
          \u7D61\u304F\u3060\u3055\u3044\u3002\\n\\n`;\n  response += `### \U0001F6E1\
          \uFE0F \u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u30B9\u30AD\u30E3\u30F3\u3092\
          \u958B\u59CB\\n`;\n  response += `\u81EA\u52D5\u30BB\u30AD\u30E5\u30EA\u30C6\
          \u30A3\u76E3\u67FB\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u304C\u8D77\u52D5\
          \u3055\u308C\u307E\u3057\u305F\u3002\\n\\n`;\n}\n\n// Auto-fix availability\n\
          if (content.includes('dependency') || content.includes('formatting') ||\
          \ content.includes('config')) {\n  response += `## \U0001F916 \u81EA\u52D5\
          \u4FEE\u5FA9\u53EF\u80FD\\n\\n`;\n  response += `\u3053\u306E\u554F\u984C\
          \u306F\u81EA\u52D5\u4FEE\u5FA9\u30B7\u30B9\u30C6\u30E0\u3067\u5BFE\u5FDC\
          \u53EF\u80FD\u3067\u3059\uFF1A\\n\\n`;\n  response += `### \U0001F4CB \u5229\
          \u7528\u53EF\u80FD\u306A\u81EA\u52D5\u4FEE\u5FA9\\n`;\n  if (content.includes('dependency'))\
          \ {\n    response += `- \U0001F504 **\u4F9D\u5B58\u95A2\u4FC2\u306E\u66F4\
          \u65B0**: \u8106\u5F31\u6027\u30D1\u30C3\u30C1\u306E\u81EA\u52D5\u9069\u7528\
          \\n`;\n  }\n  if (content.includes('formatting')) {\n    response += `-\
          \ \U0001F3A8 **\u30B3\u30FC\u30C9\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8**:\
          \ Black, isort\u306E\u81EA\u52D5\u9069\u7528\\n`;\n  }\n  if (content.includes('config'))\
          \ {\n    response += `- \u2699\uFE0F **\u8A2D\u5B9A\u4FEE\u6B63**: \u8A2D\
          \u5B9A\u30D5\u30A1\u30A4\u30EB\u306E\u81EA\u52D5\u4FEE\u6B63\\n`;\n  }\n\
          \  response += `\\n### \U0001F680 \u81EA\u52D5\u4FEE\u5FA9\u306E\u5B9F\u884C\
          \u65B9\u6CD5\\n`;\n  response += `1. **Actions** \u30BF\u30D6\u3078\u79FB\
          \u52D5\\n`;\n  response += `2. **Auto Error Detection & Fix System** \u3092\
          \u9078\u629E\\n`;\n  response += `3. **Run workflow** \u3092\u30AF\u30EA\
          \u30C3\u30AF\\n`;\n  response += `4. **auto_fix** \u3092\u6709\u52B9\u306B\
          \u3057\u3066\u5B9F\u884C\\n\\n`;\n  response += `\u81EA\u52D5\u4FEE\u5FA9\
          \u304C\u5B8C\u4E86\u3059\u308B\u3068\u3001Pull Request\u304C\u81EA\u52D5\
          \u4F5C\u6210\u3055\u308C\u307E\u3059\u3002\\n\\n`;\n}\n\n// General information\n\
          response += `## \U0001F4CA Issue\u8FFD\u8DE1\u60C5\u5831\\n\\n`;\nresponse\
          \ += `- **Issue ID**: #${issue.number}\\n`;\nresponse += `- **\u4F5C\u6210\
          \u65E5\u6642**: ${new Date().toISOString()}\\n`;\nresponse += `- **\u81EA\
          \u52D5\u30E9\u30D9\u30EA\u30F3\u30B0**: \u5B8C\u4E86\\n`;\nresponse += `-\
          \ **\u512A\u5148\u5EA6\u8A55\u4FA1**: \u5B9F\u884C\u4E2D\\n\\n`;\n\nresponse\
          \ += `## \U0001F514 \u6B21\u306E\u30B9\u30C6\u30C3\u30D7\\n\\n`;\nresponse\
          \ += `1. **\u81EA\u52D5\u5206\u6790**: \u30B7\u30B9\u30C6\u30E0\u304C\u95A2\
          \u9023\u30ED\u30B0\u3068\u30C7\u30FC\u30BF\u3092\u5206\u6790\u4E2D\\n`;\n\
          response += `2. **\u958B\u767A\u8005\u30EC\u30D3\u30E5\u30FC**: 24\u6642\
          \u9593\u4EE5\u5185\u306B\u958B\u767A\u8005\u304C\u78BA\u8A8D\\n`;\nresponse\
          \ += `3. **\u5BFE\u5FDC\u8A08\u753B**: \u554F\u984C\u306E\u8907\u96D1\u3055\
          \u306B\u5FDC\u3058\u3066\u5BFE\u5FDC\u8A08\u753B\u3092\u7B56\u5B9A\\n`;\n\
          response += `4. **\u9032\u6357\u66F4\u65B0**: \u91CD\u8981\u306A\u9032\u5C55\
          \u304C\u3042\u308A\u6B21\u7B2C\u3001\u3053\u306EIssue\u3092\u66F4\u65B0\\\
          n\\n`;\n\nresponse += `---\\n\\n`;\nresponse += `*\u3053\u306E\u81EA\u52D5\
          \u5FDC\u7B54\u306F GitHub Actions \u306B\u3088\u308A\u751F\u6210\u3055\u308C\
          \u307E\u3057\u305F\u3002*\\n`;\nresponse += `*\u8FFD\u52A0\u8CEA\u554F\u3084\
          \u3054\u4E0D\u660E\u70B9\u304C\u3054\u3056\u3044\u307E\u3057\u305F\u3089\
          \u3001\u304A\u6C17\u8EFD\u306B\u30B3\u30E1\u30F3\u30C8\u3057\u3066\u304F\
          \u3060\u3055\u3044\u3002*`;\n\n// Post the response\nawait github.rest.issues.createComment({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  issue_number:\
          \ issue.number,\n  body: response\n});\n\nconsole.log(`Auto-response posted\
          \ to issue #${issue.number}`);\n"
  issue-analysis:
    name: Issue Analysis & Auto-Investigation
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled'
    steps:
    - name: Checkout code for analysis
      uses: actions/checkout@v4
    - name: Set up Python for analysis
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Analyze issue and gather information
      uses: actions/github-script@v6
      with:
        script: "const issue = context.payload.issue;\nconst label = context.payload.label;\n\
          \nconsole.log(`Analyzing issue #${issue.number} with new label: ${label.name}`);\n\
          \nlet analysis = `## \U0001F50D \u81EA\u52D5\u89E3\u6790\u30EC\u30DD\u30FC\
          \u30C8\\n\\n`;\nanalysis += `**\u89E3\u6790\u5BFE\u8C61**: Issue #${issue.number}\\\
          n`;\nanalysis += `**\u30C8\u30EA\u30AC\u30FC\u30E9\u30D9\u30EB**: ${label.name}\\\
          n`;\nanalysis += `**\u89E3\u6790\u6642\u523B**: ${new Date().toISOString()}\\\
          n\\n`;\n\n// Component-specific analysis\nif (label.name.includes('component:database'))\
          \ {\n  analysis += `### \U0001F4CA \u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u95A2\
          \u9023\u306E\u89E3\u6790\\n\\n`;\n  analysis += `**\u30C1\u30A7\u30C3\u30AF\
          \u9805\u76EE**:\\n`;\n  analysis += `- \u2705 SQLite\u30D5\u30A1\u30A4\u30EB\
          \u306E\u5B58\u5728\u78BA\u8A8D\\n`;\n  analysis += `- \u2705 \u30C7\u30FC\
          \u30BF\u30D9\u30FC\u30B9\u30B9\u30AD\u30FC\u30DE\u306E\u6574\u5408\u6027\
          \\n`;\n  analysis += `- \u2705 \u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u306E\
          \u6700\u9069\u5316\u72B6\u6CC1\\n`;\n  analysis += `- \u2705 \u30D0\u30C3\
          \u30AF\u30A2\u30C3\u30D7\u30D5\u30A1\u30A4\u30EB\u306E\u72B6\u614B\\n\\\
          n`;\n  \n  analysis += `**\u63A8\u5968\u5BFE\u5FDC**:\\n`;\n  analysis +=\
          \ `1. \\`modules/db.py\\` \u306E\u30EC\u30D3\u30E5\u30FC\\n`;\n  analysis\
          \ += `2. SQLite\u30D5\u30A1\u30A4\u30EB\u306E\u6A29\u9650\u78BA\u8A8D\\\
          n`;\n  analysis += `3. \u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u30DE\u30A4\u30B0\
          \u30EC\u30FC\u30B7\u30E7\u30F3\u306E\u691C\u8A0E\\n\\n`;\n}\n\nif (label.name.includes('component:notification'))\
          \ {\n  analysis += `### \U0001F4E7 \u901A\u77E5\u30B7\u30B9\u30C6\u30E0\u95A2\
          \u9023\u306E\u89E3\u6790\\n\\n`;\n  analysis += `**\u30C1\u30A7\u30C3\u30AF\
          \u9805\u76EE**:\\n`;\n  analysis += `- \u2705 Gmail API\u8A8D\u8A3C\u72B6\
          \u6CC1\\n`;\n  analysis += `- \u2705 SMTP\u8A2D\u5B9A\u306E\u691C\u8A3C\\\
          n`;\n  analysis += `- \u2705 Google Calendar API\u63A5\u7D9A\\n`;\n  analysis\
          \ += `- \u2705 \u30A8\u30E9\u30FC\u901A\u77E5\u30B7\u30B9\u30C6\u30E0\u306E\
          \u52D5\u4F5C\\n\\n`;\n  \n  analysis += `**\u63A8\u5968\u5BFE\u5FDC**:\\\
          n`;\n  analysis += `1. \\`modules/mailer.py\\` \u3068 \\`modules/calendar.py\\\
          ` \u306E\u30EC\u30D3\u30E5\u30FC\\n`;\n  analysis += `2. Gmail App Password\u306E\
          \u78BA\u8A8D\\n`;\n  analysis += `3. OAuth2\u30C8\u30FC\u30AF\u30F3\u306E\
          \u66F4\u65B0\\n\\n`;\n}\n\nif (label.name.includes('component:webui')) {\n\
          \  analysis += `### \U0001F310 WebUI\u95A2\u9023\u306E\u89E3\u6790\\n\\\
          n`;\n  analysis += `**\u30C1\u30A7\u30C3\u30AF\u9805\u76EE**:\\n`;\n  analysis\
          \ += `- \u2705 Flask \u30A2\u30D7\u30EA\u30B1\u30FC\u30B7\u30E7\u30F3\u306E\
          \u8D77\u52D5\u72B6\u6CC1\\n`;\n  analysis += `- \u2705 \u30C6\u30F3\u30D7\
          \u30EC\u30FC\u30C8\u30D5\u30A1\u30A4\u30EB\u306E\u6574\u5408\u6027\\n`;\n\
          \  analysis += `- \u2705 \u9759\u7684\u30D5\u30A1\u30A4\u30EB\u306E\u914D\
          \u4FE1\\n`;\n  analysis += `- \u2705 \u30DD\u30FC\u30C83030\u306E\u30A2\u30AF\
          \u30BB\u30B7\u30D3\u30EA\u30C6\u30A3\\n\\n`;\n  \n  analysis += `**\u63A8\
          \u5968\u5BFE\u5FDC**:\\n`;\n  analysis += `1. \\`web_app.py\\` \u306E\u30A8\
          \u30E9\u30FC\u30ED\u30B0\u78BA\u8A8D\\n`;\n  analysis += `2. systemd\u30B5\
          \u30FC\u30D3\u30B9\u306E\u72B6\u614B\u78BA\u8A8D\\n`;\n  analysis += `3.\
          \ \u30D5\u30A1\u30A4\u30A2\u30A6\u30A9\u30FC\u30EB\u8A2D\u5B9A\u306E\u691C\
          \u8A3C\\n\\n`;\n}\n\nif (label.name.includes('security')) {\n  analysis\
          \ += `### \U0001F512 \u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u89E3\u6790\\\
          n\\n`;\n  analysis += `**\u81EA\u52D5\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\
          \u30B9\u30AD\u30E3\u30F3\u3092\u958B\u59CB\u3057\u307E\u3057\u305F**\\n\\\
          n`;\n  analysis += `**\u5B9F\u884C\u5185\u5BB9**:\\n`;\n  analysis += `-\
          \ \U0001F50D \u4F9D\u5B58\u95A2\u4FC2\u306E\u8106\u5F31\u6027\u30B9\u30AD\
          \u30E3\u30F3\\n`;\n  analysis += `- \U0001F50D \u30B3\u30FC\u30C9\u306E\u9759\
          \u7684\u89E3\u6790\uFF08Bandit\uFF09\\n`;\n  analysis += `- \U0001F50D \u6A5F\
          \u5BC6\u60C5\u5831\u306E\u6F0F\u6D29\u30C1\u30A7\u30C3\u30AF\\n`;\n  analysis\
          \ += `- \U0001F50D \u8A2D\u5B9A\u30D5\u30A1\u30A4\u30EB\u306E\u30BB\u30AD\
          \u30E5\u30EA\u30C6\u30A3\u76E3\u67FB\\n\\n`;\n  \n  analysis += `**\u7D50\
          \u679C\u306F\u7D045\u5206\u5F8C\u306B\u8FFD\u52A0\u30B3\u30E1\u30F3\u30C8\
          \u3067\u5831\u544A\u3055\u308C\u307E\u3059**\\n\\n`;\n}\n\nif (label.name.includes('auto-fixable'))\
          \ {\n  analysis += `### \U0001F916 \u81EA\u52D5\u4FEE\u5FA9\u306E\u5206\u6790\
          \\n\\n`;\n  analysis += `\u3053\u306E\u554F\u984C\u306F\u81EA\u52D5\u4FEE\
          \u5FA9\u30B7\u30B9\u30C6\u30E0\u3067\u5BFE\u5FDC\u53EF\u80FD\u3067\u3059\
          \u3002\\n\\n`;\n  analysis += `**\u4FEE\u5FA9\u53EF\u80FD\u306A\u9805\u76EE\
          **:\\n`;\n  analysis += `- \U0001F504 \u4F9D\u5B58\u95A2\u4FC2\u306E\u66F4\
          \u65B0\\n`;\n  analysis += `- \U0001F3A8 \u30B3\u30FC\u30C9\u30D5\u30A9\u30FC\
          \u30DE\u30C3\u30C8\u306E\u4FEE\u6B63\\n`;\n  analysis += `- \u2699\uFE0F\
          \ \u8A2D\u5B9A\u30D5\u30A1\u30A4\u30EB\u306E\u6700\u9069\u5316\\n`;\n  analysis\
          \ += `- \U0001F4E6 \u30D1\u30C3\u30B1\u30FC\u30B8\u306E\u8106\u5F31\u6027\
          \u5BFE\u5FDC\\n\\n`;\n  \n  analysis += `### \U0001F680 \u81EA\u52D5\u4FEE\
          \u5FA9\u306E\u5B9F\u884C\\n`;\n  analysis += `\u4EE5\u4E0B\u306E\u30B3\u30DE\
          \u30F3\u30C9\u3067\u81EA\u52D5\u4FEE\u5FA9\u3092\u5B9F\u884C\u3067\u304D\
          \u307E\u3059\uFF1A\\n\\n`;\n  analysis += `\\`\\`\\`bash\\n`;\n  analysis\
          \ += `# GitHub Actions\u3067\u5B9F\u884C\\n`;\n  analysis += `gh workflow\
          \ run \"Auto Error Detection & Fix System\" \\\\\\n`;\n  analysis += ` \
          \ --field auto_fix=true \\\\\\n`;\n  analysis += `  --field create_issue=false\\\
          n`;\n  analysis += `\\`\\`\\`\\n\\n`;\n}\n\n// Related files analysis\n\
          analysis += `### \U0001F4C1 \u95A2\u9023\u30D5\u30A1\u30A4\u30EB\u306E\u78BA\
          \u8A8D\\n\\n`;\nconst title = issue.title.toLowerCase();\nconst body = issue.body\
          \ ? issue.body.toLowerCase() : '';\nconst content = title + ' ' + body;\n\
          \nlet relatedFiles = [];\nif (content.includes('config')) relatedFiles.push('config.json',\
          \ 'config.json.template');\nif (content.includes('database') || content.includes('sqlite'))\
          \ relatedFiles.push('modules/db.py', 'db.sqlite3');\nif (content.includes('email')\
          \ || content.includes('mail')) relatedFiles.push('modules/mailer.py', 'modules/email_sender.py');\n\
          if (content.includes('api')) relatedFiles.push('modules/anime_anilist.py',\
          \ 'modules/manga_rss.py');\nif (content.includes('web') || content.includes('ui'))\
          \ relatedFiles.push('web_app.py', 'templates/');\n\nif (relatedFiles.length\
          \ > 0) {\n  analysis += `**\u78BA\u8A8D\u63A8\u5968\u30D5\u30A1\u30A4\u30EB\
          **:\\n`;\n  relatedFiles.forEach(file => {\n    analysis += `- \\`${file}\\\
          `\\n`;\n  });\n  analysis += `\\n`;\n}\n\nanalysis += `---\\n\\n`;\nanalysis\
          \ += `*\u3053\u306E\u89E3\u6790\u306F\u81EA\u52D5\u5B9F\u884C\u3055\u308C\
          \u307E\u3057\u305F\u3002\u8A73\u7D30\u306A\u8ABF\u67FB\u304C\u5FC5\u8981\
          \u306A\u5834\u5408\u306F\u3001\u958B\u767A\u8005\u304C\u624B\u52D5\u3067\
          \u5BFE\u5FDC\u3044\u305F\u3057\u307E\u3059\u3002*`;\n\n// Post analysis\
          \ comment\nawait github.rest.issues.createComment({\n  owner: context.repo.owner,\n\
          \  repo: context.repo.repo,\n  issue_number: issue.number,\n  body: analysis\n\
          });\n"
  stale-issue-management:
    name: Stale Issue Management
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch'
      && inputs.action_type == 'stale-check')
    steps:
    - name: Check and manage stale issues
      uses: actions/github-script@v6
      with:
        script: "const { Octokit } = require('@octokit/rest');\n\n// Get all open\
          \ issues\nconst issues = await github.rest.issues.listForRepo({\n  owner:\
          \ context.repo.owner,\n  repo: context.repo.repo,\n  state: 'open',\n  per_page:\
          \ 100\n});\n\nconst now = new Date();\nconst staleThreshold = 14; // days\n\
          const closeThreshold = 30; // days\n\nfor (const issue of issues.data) {\n\
          \  const createdDate = new Date(issue.created_at);\n  const updatedDate\
          \ = new Date(issue.updated_at);\n  const daysSinceCreated = Math.floor((now\
          \ - createdDate) / (1000 * 60 * 60 * 24));\n  const daysSinceUpdated = Math.floor((now\
          \ - updatedDate) / (1000 * 60 * 60 * 24));\n  \n  const hasStaleLabel =\
          \ issue.labels.some(label => label.name === 'stale');\n  const hasKeepOpenLabel\
          \ = issue.labels.some(label => label.name === 'keep-open');\n  const isHighPriority\
          \ = issue.labels.some(label => label.name === 'priority:high');\n  \n  //\
          \ Skip if marked as keep-open or high priority\n  if (hasKeepOpenLabel ||\
          \ isHighPriority) {\n    continue;\n  }\n  \n  // Close very old stale issues\n\
          \  if (hasStaleLabel && daysSinceUpdated >= closeThreshold) {\n    await\
          \ github.rest.issues.createComment({\n      owner: context.repo.owner,\n\
          \      repo: context.repo.repo,\n      issue_number: issue.number,\n   \
          \   body: `## \U0001F504 \u81EA\u52D5\u30AF\u30ED\u30FC\u30BA\\n\\n\u3053\
          \u306EIssue\u306F${closeThreshold}\u65E5\u9593\u66F4\u65B0\u304C\u306A\u3044\
          \u305F\u3081\u3001\u81EA\u52D5\u7684\u306B\u30AF\u30ED\u30FC\u30BA\u3055\
          \u308C\u307E\u3059\u3002\\n\\n\u5FC5\u8981\u306B\u5FDC\u3058\u3066\u518D\
          \u5EA6Issue\u3092\u958B\u3044\u3066\u304F\u3060\u3055\u3044\u3002\\n\\n---\\\
          n*\u81EA\u52D5\u7BA1\u7406\u30B7\u30B9\u30C6\u30E0\u306B\u3088\u308B\u51E6\
          \u7406*`\n    });\n    \n    await github.rest.issues.update({\n      owner:\
          \ context.repo.owner,\n      repo: context.repo.repo,\n      issue_number:\
          \ issue.number,\n      state: 'closed'\n    });\n    \n    console.log(`Closed\
          \ stale issue #${issue.number}`);\n    continue;\n  }\n  \n  // Mark as\
          \ stale if inactive for staleThreshold days\n  if (!hasStaleLabel && daysSinceUpdated\
          \ >= staleThreshold) {\n    await github.rest.issues.addLabels({\n     \
          \ owner: context.repo.owner,\n      repo: context.repo.repo,\n      issue_number:\
          \ issue.number,\n      labels: ['stale']\n    });\n    \n    await github.rest.issues.createComment({\n\
          \      owner: context.repo.owner,\n      repo: context.repo.repo,\n    \
          \  issue_number: issue.number,\n      body: `## \u23F0 \u975E\u30A2\u30AF\
          \u30C6\u30A3\u30D6\u901A\u77E5\\n\\n\u3053\u306EIssue\u306F${staleThreshold}\u65E5\
          \u9593\u66F4\u65B0\u304C\u3042\u308A\u307E\u305B\u3093\u3002\\n\\n**${closeThreshold\
          \ - staleThreshold}\u65E5\u5F8C\u306B\u81EA\u52D5\u7684\u306B\u30AF\u30ED\
          \u30FC\u30BA\u3055\u308C\u307E\u3059\u3002**\\n\\n### \u7D99\u7D9A\u304C\
          \u5FC5\u8981\u306A\u5834\u5408\\n- \u3053\u306EIssue\u306B\u30B3\u30E1\u30F3\
          \u30C8\u3092\u8FFD\u52A0\\n- \\`keep-open\\` \u30E9\u30D9\u30EB\u3092\u8FFD\
          \u52A0\\n- \u9032\u6357\u72B6\u6CC1\u3092\u66F4\u65B0\\n\\n---\\n*\u81EA\
          \u52D5\u7BA1\u7406\u30B7\u30B9\u30C6\u30E0\u306B\u3088\u308B\u51E6\u7406\
          *`\n    });\n    \n    console.log(`Marked issue #${issue.number} as stale`);\n\
          \  }\n}\n"
  comment-auto-actions:
    name: Comment-based Auto-Actions
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && github.event.action == 'created'
    steps:
    - name: Process comment commands
      uses: actions/github-script@v6
      with:
        script: "const comment = context.payload.comment;\nconst issue = context.payload.issue;\n\
          const commentBody = comment.body.toLowerCase();\n\nconsole.log(`Processing\
          \ comment on issue #${issue.number}`);\n\n// Remove stale label if there's\
          \ activity\nconst staleLabel = issue.labels.find(label => label.name ===\
          \ 'stale');\nif (staleLabel) {\n  await github.rest.issues.removeLabel({\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    issue_number:\
          \ issue.number,\n    name: 'stale'\n  });\n  \n  await github.rest.issues.createComment({\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    issue_number:\
          \ issue.number,\n    body: `\u2705 **Stale\u30E9\u30D9\u30EB\u3092\u524A\
          \u9664\u3057\u307E\u3057\u305F** - Issue\u304C\u518D\u30A2\u30AF\u30C6\u30A3\
          \u30D6\u306B\u306A\u308A\u307E\u3057\u305F\u3002`\n  });\n}\n\n// Command\
          \ processing\nif (commentBody.includes('/auto-fix') || commentBody.includes('/\u81EA\
          \u52D5\u4FEE\u5FA9')) {\n  await github.rest.issues.createComment({\n  \
          \  owner: context.repo.owner,\n    repo: context.repo.repo,\n    issue_number:\
          \ issue.number,\n    body: `\U0001F916 **\u81EA\u52D5\u4FEE\u5FA9\u3092\u958B\
          \u59CB\u3057\u307E\u3059**\\n\\nGitHub Actions\u30EF\u30FC\u30AF\u30D5\u30ED\
          \u30FC \"Auto Error Detection & Fix System\" \u3092\u8D77\u52D5\u4E2D...\\\
          n\\n\u9032\u6357\u306F [Actions \u30BF\u30D6](../../actions) \u3067\u78BA\
          \u8A8D\u3067\u304D\u307E\u3059\u3002`\n  });\n  \n  // Trigger auto-fix\
          \ workflow (if repository has necessary permissions)\n  try {\n    await\
          \ github.rest.actions.createWorkflowDispatch({\n      owner: context.repo.owner,\n\
          \      repo: context.repo.repo,\n      workflow_id: 'auto-error-detection-and-fix.yml',\n\
          \      ref: 'main',\n      inputs: {\n        detection_type: 'all',\n \
          \       auto_fix: 'true',\n        create_issue: 'false'\n      }\n    });\n\
          \  } catch (error) {\n    console.log('Could not trigger workflow:', error.message);\n\
          \  }\n}\n\nif (commentBody.includes('/priority high') || commentBody.includes('/\u512A\
          \u5148\u5EA6 \u9AD8')) {\n  await github.rest.issues.addLabels({\n    owner:\
          \ context.repo.owner,\n    repo: context.repo.repo,\n    issue_number: issue.number,\n\
          \    labels: ['priority:high']\n  });\n  \n  await github.rest.issues.createComment({\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    issue_number:\
          \ issue.number,\n    body: `\U0001F534 **\u512A\u5148\u5EA6\u3092 HIGH \u306B\
          \u8A2D\u5B9A\u3057\u307E\u3057\u305F**\\n\\n\u3053\u306EIssue\u306F\u9AD8\
          \u512A\u5148\u5EA6\u3068\u3057\u3066\u51E6\u7406\u3055\u308C\u307E\u3059\
          \u3002`\n  });\n}\n\nif (commentBody.includes('/keep-open') || commentBody.includes('/\u7D99\
          \u7D9A')) {\n  await github.rest.issues.addLabels({\n    owner: context.repo.owner,\n\
          \    repo: context.repo.repo,\n    issue_number: issue.number,\n    labels:\
          \ ['keep-open']\n  });\n  \n  await github.rest.issues.createComment({\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    issue_number:\
          \ issue.number,\n    body: `\U0001F4CC **\u7D99\u7D9A\u30D5\u30E9\u30B0\u3092\
          \u8A2D\u5B9A\u3057\u307E\u3057\u305F**\\n\\n\u3053\u306EIssue\u306F\u81EA\
          \u52D5\u30AF\u30ED\u30FC\u30BA\u306E\u5BFE\u8C61\u5916\u306B\u306A\u308A\
          \u307E\u3059\u3002`\n  });\n}\n\nif (commentBody.includes('/help') || commentBody.includes('/\u30D8\
          \u30EB\u30D7')) {\n  const helpText = `## \U0001F916 \u5229\u7528\u53EF\u80FD\
          \u306A\u30B3\u30DE\u30F3\u30C9\\n\\n\n  **\u81EA\u52D5\u4FEE\u5FA9**:\n\
          \  - \\`/auto-fix\\` \u307E\u305F\u306F \\`/\u81EA\u52D5\u4FEE\u5FA9\\`\
          \ - \u81EA\u52D5\u4FEE\u5FA9\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u5B9F\
          \u884C\n  \n  **\u512A\u5148\u5EA6\u5909\u66F4**:\n  - \\`/priority high\\\
          ` \u307E\u305F\u306F \\`/\u512A\u5148\u5EA6 \u9AD8\\` - \u9AD8\u512A\u5148\
          \u5EA6\u306B\u8A2D\u5B9A\n  \n  **Issue\u7BA1\u7406**:\n  - \\`/keep-open\\\
          ` \u307E\u305F\u306F \\`/\u7D99\u7D9A\\` - \u81EA\u52D5\u30AF\u30ED\u30FC\
          \u30BA\u3092\u9632\u6B62\n  - \\`/help\\` \u307E\u305F\u306F \\`/\u30D8\u30EB\
          \u30D7\\` - \u3053\u306E\u30D8\u30EB\u30D7\u3092\u8868\u793A\n  \n  **\u5206\
          \u6790\u8981\u6C42**:\n  - \\`/analyze\\` \u307E\u305F\u306F \\`/\u89E3\u6790\
          \\` - \u8A73\u7D30\u5206\u6790\u3092\u5B9F\u884C\n  \n  ---\n  *\u30B3\u30DE\
          \u30F3\u30C9\u306F\u30B3\u30E1\u30F3\u30C8\u5185\u306E\u3069\u3053\u306B\
          \u66F8\u3044\u3066\u3082\u8A8D\u8B58\u3055\u308C\u307E\u3059*`;\n  \n  await\
          \ github.rest.issues.createComment({\n    owner: context.repo.owner,\n \
          \   repo: context.repo.repo,\n    issue_number: issue.number,\n    body:\
          \ helpText\n  });\n}"
permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: write
