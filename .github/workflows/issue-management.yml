name: Issueè‡ªå‹•ç®¡ç†

on:
  # æ¯æ—¥0æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      close_old_days:
        description: 'ä½•æ—¥ä»¥ä¸Šå¤ã„Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚‹ã‹'
        required: false
        default: '7'
      consolidate:
        description: 'é‡è¤‡Issueã‚’çµ±åˆã™ã‚‹ã‹'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  issues: write

jobs:
  manage-issues:
    name: Issueè‡ªå‹•ç®¡ç†å®Ÿè¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install PyYAML

      - name: Issueè‡ªå‹•ç®¡ç†å®Ÿè¡Œ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/issue_manager.py \
            --close-old ${{ github.event.inputs.close_old_days || '7' }} \
            --consolidate-duplicates \
            --check-threshold 10 \
            --close-on-success 3

      - name: å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          echo "## ğŸ—‚ï¸ Issueè‡ªå‹•ç®¡ç†çµæœ" >> $GITHUB_STEP_SUMMARY

          if [ -f issue_management_summary.json ]; then
            CLOSED_OLD=$(jq -r '.results.closed_old // 0' issue_management_summary.json)
            CONSOLIDATED=$(jq -r '.results.consolidated // 0' issue_management_summary.json)
            CLOSED_SUCCESS=$(jq -r '.results.closed_success // 0' issue_management_summary.json)

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| é …ç›® | ä»¶æ•° |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| ã‚¯ãƒ­ãƒ¼ã‚ºã—ãŸå¤ã„Issue | $CLOSED_OLD |" >> $GITHUB_STEP_SUMMARY
            echo "| çµ±åˆã—ãŸé‡è¤‡Issue | $CONSOLIDATED |" >> $GITHUB_STEP_SUMMARY
            echo "| æˆåŠŸã«ã‚ˆã‚Šã‚¯ãƒ­ãƒ¼ã‚º | $CLOSED_SUCCESS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ ã‚µãƒãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: å®Ÿè¡Œãƒ­ã‚°ã‚’ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: issue-management-logs-${{ github.run_number }}
          path: |
            issue_management_summary.json
          retention-days: 30
