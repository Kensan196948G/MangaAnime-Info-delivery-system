name: ğŸ”§ è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ å¼·åŒ–ç‰ˆï¼ˆ15å›ãƒ«ãƒ¼ãƒ—ãƒ»15åˆ†å¾…æ©Ÿï¼‰

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆå€‹äººé–‹ç™ºç”¨ï¼‰
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°'
        required: false
        default: '15'
        type: string
      target:
        description: 'ä¿®å¾©å¯¾è±¡ï¼ˆsyntax/test/lint/allï¼‰'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - syntax
          - test
          - lint
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆä¿®å¾©ã›ãšæ¤œçŸ¥ã®ã¿ï¼‰'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-repair:
    name: ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || echo "requirements-dev.txt ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—"

      - name: ğŸ”§ è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
        id: repair
        run: |
          # auto_repair_loop.py ã‚’å®Ÿè¡Œ
          python3 scripts/auto_repair_loop.py \
            --max-loops ${{ github.event.inputs.max_loops || 15 }} \
            --wait 300 \
            --once

          # çµæœã‚’å‡ºåŠ›
          echo "repair_status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“Š çµæœã‚µãƒãƒªãƒ¼
        run: |
          echo "## ğŸ”§ è‡ªå‹•ä¿®å¾©çµæœ"
          echo ""
          echo "- æœ€å¤§ãƒ«ãƒ¼ãƒ—æ•°: ${{ github.event.inputs.max_loops || 15 }}"
          echo "- ä¿®å¾©å¯¾è±¡: ${{ github.event.inputs.target || 'all' }}"
          echo "- ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³: ${{ github.event.inputs.dry_run || 'false' }}"
          echo ""

          if [ -f "logs/auto_repair_*.log" ]; then
            echo "### ãƒ­ã‚°å‡ºåŠ›"
            tail -50 logs/auto_repair_*.log
          fi

      - name: ğŸ’¾ ãƒ­ã‚°ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-repair-logs
          path: |
            logs/auto_repair_*.log
          retention-days: 7

      - name: âœ… æˆåŠŸæ™‚ã®å‡¦ç†
        if: steps.repair.outputs.repair_status == 'success'
        run: |
          echo "âœ… è‡ªå‹•ä¿®å¾©ãŒæˆåŠŸã—ã¾ã—ãŸ"

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "Auto Repair Bot"
            git config user.email "auto-repair@github-actions"
            git add -A
            git commit -m "[è‡ªå‹•ä¿®å¾©] ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©å®Ÿè¡Œ

è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šæ¤œçŸ¥ãƒ»ä¿®å¾©ã•ã‚Œã¾ã—ãŸã€‚

ğŸ¤– Generated by Auto Repair Enhanced System"
            git push origin main
          fi
