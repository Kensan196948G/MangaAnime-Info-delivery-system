name: ğŸ”§ çµ±åˆè‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ  (Unified Auto-Repair System)

# 3ã¤ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆv2ã€æœ¬ç•ªç‰ˆã€7xãƒ«ãƒ¼ãƒ—ï¼‰ã‚’çµ±åˆã—æœ€é©åŒ–ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³
# - ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªä¿®å¾©æˆ¦ç•¥
# - æ®µéšçš„ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
# - ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡åŒ–
# - åŒ…æ‹¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

on:
  # å®šæœŸå®Ÿè¡Œ: 30åˆ†ã”ã¨ï¼ˆæœ¬ç•ªç¨¼åƒæ™‚ï¼‰
  schedule:
    - cron: '*/30 * * * *'

  # æ‰‹å‹•å®Ÿè¡Œ: ã‚«ã‚¹ã‚¿ãƒ è¨­å®šå¯èƒ½
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°'
        required: false
        default: '10'
        type: string
      repair_mode:
        description: 'ä¿®å¾©ãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard      # æ¨™æº–ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã®ã¿ï¼‰
          - aggressive    # ã‚¢ã‚°ãƒ¬ãƒƒã‚·ãƒ–ï¼ˆè­¦å‘Šã‚‚å«ã‚€ï¼‰
          - conservative  # ä¿å®ˆçš„ï¼ˆã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ã®ã¿ï¼‰
      target_issue:
        description: 'å¯¾è±¡Issueç•ªå·ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰'
        required: false
        type: string
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå®Ÿéš›ã®ä¿®å¾©ã‚’å®Ÿè¡Œã—ãªã„ï¼‰'
        required: false
        default: false
        type: boolean

  # Issueã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼: @auto-repair ã§ãƒˆãƒªã‚¬ãƒ¼
  issue_comment:
    types: [created]

  # ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—æ™‚ã«è‡ªå‹•èµ·å‹•
  workflow_run:
    workflows:
      - "CI Pipeline"
      - "Security Check"
      - "Test Suite"
    types: [completed]

# æ¨©é™è¨­å®š
permissions:
  contents: write
  issues: write
  actions: write
  pull-requests: write
  checks: read

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡: 1ã¤ã®ã¿å®Ÿè¡Œ
concurrency:
  group: auto-repair-unified
  cancel-in-progress: false

env:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
  DEFAULT_MAX_LOOPS: 10
  REPAIR_INTERVAL_SECONDS: 30
  RETRY_MAX_ATTEMPTS: 3
  RETRY_DELAY_SECONDS: 10

  # ãƒ©ãƒ™ãƒ«è¨­å®š
  LABEL_AUTO_REPAIR: 'auto-repair'
  LABEL_IN_PROGRESS: 'repair-in-progress'
  LABEL_COMPLETED: 'repair-completed'
  LABEL_FAILED: 'repair-failed'
  LABEL_CRITICAL: 'critical'

  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
  TIMEOUT_CHECKOUT: 5
  TIMEOUT_SETUP: 8
  TIMEOUT_INSTALL: 10
  TIMEOUT_REPAIR: 20

jobs:
  # ã‚¸ãƒ§ãƒ–1: äº‹å‰ãƒã‚§ãƒƒã‚¯ã¨åˆæœŸåŒ–
  pre-check:
    name: ğŸ” äº‹å‰ãƒã‚§ãƒƒã‚¯ã¨åˆæœŸåŒ–
    runs-on: ubuntu-latest
    timeout-minutes: 5

    # å®Ÿè¡Œæ¡ä»¶ã®è©³ç´°åˆ¶å¾¡
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@auto-repair')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure')

    outputs:
      should_repair: ${{ steps.decision.outputs.should_repair }}
      repair_mode: ${{ steps.decision.outputs.repair_mode }}
      target_issue: ${{ steps.decision.outputs.target_issue }}
      max_loops: ${{ steps.decision.outputs.max_loops }}
      is_dry_run: ${{ steps.decision.outputs.is_dry_run }}

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        timeout-minutes: ${{ fromJSON(env.TIMEOUT_CHECKOUT) }}
        with:
          fetch-depth: 0

      - name: ğŸ” æ—¢å­˜ä¿®å¾©Issueãƒã‚§ãƒƒã‚¯
        id: check-existing
        run: |
          # é€²è¡Œä¸­ã®ä¿®å¾©Issueã‚’æ¤œç´¢
          EXISTING_ISSUES=$(gh issue list \
            --label "${{ env.LABEL_AUTO_REPAIR }}" \
            --label "${{ env.LABEL_IN_PROGRESS }}" \
            --state open \
            --json number,createdAt \
            --jq 'length')

          echo "existing_count=$EXISTING_ISSUES" >> $GITHUB_OUTPUT

          if [ "$EXISTING_ISSUES" -gt 0 ]; then
            echo "âš ï¸ $EXISTING_ISSUES å€‹ã®é€²è¡Œä¸­ä¿®å¾©IssueãŒå­˜åœ¨ã—ã¾ã™"
            OLDEST_ISSUE=$(gh issue list \
              --label "${{ env.LABEL_AUTO_REPAIR }}" \
              --label "${{ env.LABEL_IN_PROGRESS }}" \
              --state open \
              --json number,createdAt \
              --jq 'sort_by(.createdAt) | .[0].number')
            echo "oldest_issue=$OLDEST_ISSUE" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¯ ä¿®å¾©æˆ¦ç•¥æ±ºå®š
        id: decision
        run: |
          # ä¿®å¾©ãƒ¢ãƒ¼ãƒ‰æ±ºå®š
          if [ "${{ github.event.inputs.repair_mode }}" != "" ]; then
            REPAIR_MODE="${{ github.event.inputs.repair_mode }}"
          else
            REPAIR_MODE="standard"
          fi
          echo "repair_mode=$REPAIR_MODE" >> $GITHUB_OUTPUT

          # æœ€å¤§ãƒ«ãƒ¼ãƒ—æ•°æ±ºå®š
          MAX_LOOPS="${{ github.event.inputs.max_loops || env.DEFAULT_MAX_LOOPS }}"
          echo "max_loops=$MAX_LOOPS" >> $GITHUB_OUTPUT

          # ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³è¨­å®š
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          echo "is_dry_run=$DRY_RUN" >> $GITHUB_OUTPUT

          # å¯¾è±¡Issueæ±ºå®š
          if [ "${{ github.event.inputs.target_issue }}" != "" ]; then
            TARGET_ISSUE="${{ github.event.inputs.target_issue }}"
          elif [ "${{ steps.check-existing.outputs.oldest_issue }}" != "" ]; then
            TARGET_ISSUE="${{ steps.check-existing.outputs.oldest_issue }}"
          else
            TARGET_ISSUE=""
          fi
          echo "target_issue=$TARGET_ISSUE" >> $GITHUB_OUTPUT

          # ä¿®å¾©å®Ÿè¡Œåˆ¤å®š
          EXISTING_COUNT="${{ steps.check-existing.outputs.existing_count }}"

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯å¸¸ã«å®Ÿè¡Œ
            echo "should_repair=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹å‹•å®Ÿè¡Œ: ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™"
          elif [ "$EXISTING_COUNT" -ge 3 ]; then
            # æ—¢å­˜IssueãŒ3å€‹ä»¥ä¸Šã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            echo "should_repair=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æ—¢å­˜Issueå¤šæ•°: ä¿®å¾©ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          else
            echo "should_repair=true" >> $GITHUB_OUTPUT
            echo "âœ… ä¿®å¾©æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™"
          fi

      - name: ğŸ“Š å®Ÿè¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼
        run: |
          echo "## ğŸ”§ çµ±åˆè‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ  - å®Ÿè¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¿®å¾©ãƒ¢ãƒ¼ãƒ‰ | ${{ steps.decision.outputs.repair_mode }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æœ€å¤§ãƒ«ãƒ¼ãƒ—æ•° | ${{ steps.decision.outputs.max_loops }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ | ${{ steps.decision.outputs.is_dry_run }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯¾è±¡Issue | ${{ steps.decision.outputs.target_issue || 'ãªã—ï¼ˆæ–°è¦ä½œæˆï¼‰' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å®Ÿè¡Œåˆ¤å®š | ${{ steps.decision.outputs.should_repair == 'true' && 'âœ… å®Ÿè¡Œ' || 'â¸ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} |" >> $GITHUB_STEP_SUMMARY

  # ã‚¸ãƒ§ãƒ–2: ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
  repair-loop:
    name: ğŸ”§ ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
    runs-on: ubuntu-latest
    needs: [pre-check]
    if: needs.pre-check.outputs.should_repair == 'true'
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        timeout-minutes: ${{ fromJSON(env.TIMEOUT_CHECKOUT) }}
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        timeout-minutes: ${{ fromJSON(env.TIMEOUT_SETUP) }}
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ãƒªãƒˆãƒ©ã‚¤ä»˜ã)
        timeout-minutes: ${{ fromJSON(env.TIMEOUT_INSTALL) }}
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 8
          max_attempts: ${{ fromJSON(env.RETRY_MAX_ATTEMPTS) }}
          retry_wait_seconds: ${{ fromJSON(env.RETRY_DELAY_SECONDS) }}
          command: |
            python -m pip install --upgrade pip setuptools wheel
            pip install -r requirements.txt
            pip install -r requirements-dev.txt

      - name: ğŸ” ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆå­˜åœ¨ç¢ºèª
        id: check-scripts
        run: |
          SCRIPTS_FOUND=0

          if [ -f "scripts/auto_error_repair_loop.py" ]; then
            echo "âœ… auto_error_repair_loop.py ç™ºè¦‹"
            echo "has_main_script=true" >> $GITHUB_OUTPUT
            SCRIPTS_FOUND=$((SCRIPTS_FOUND + 1))
          else
            echo "âš ï¸ auto_error_repair_loop.py æœªæ¤œå‡º"
            echo "has_main_script=false" >> $GITHUB_OUTPUT
          fi

          if [ -f "scripts/repair-loop-executor.py" ]; then
            echo "âœ… repair-loop-executor.py ç™ºè¦‹"
            echo "has_executor_script=true" >> $GITHUB_OUTPUT
            SCRIPTS_FOUND=$((SCRIPTS_FOUND + 1))
          else
            echo "âš ï¸ repair-loop-executor.py æœªæ¤œå‡º"
            echo "has_executor_script=false" >> $GITHUB_OUTPUT
          fi

          if [ "$SCRIPTS_FOUND" -eq 0 ]; then
            echo "âŒ ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: ğŸ”§ ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
        id: repair
        timeout-minutes: ${{ fromJSON(env.TIMEOUT_REPAIR) }}
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPAIR_MODE: ${{ needs.pre-check.outputs.repair_mode }}
          MAX_LOOPS: ${{ needs.pre-check.outputs.max_loops }}
          TARGET_ISSUE: ${{ needs.pre-check.outputs.target_issue }}
          DRY_RUN: ${{ needs.pre-check.outputs.is_dry_run }}
        run: |
          # ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          SCRIPT_ARGS="--max-loops $MAX_LOOPS --interval $REPAIR_INTERVAL_SECONDS"

          if [ "$DRY_RUN" == "true" ]; then
            SCRIPT_ARGS="$SCRIPT_ARGS --dry-run"
          fi

          if [ "$REPAIR_MODE" == "aggressive" ]; then
            SCRIPT_ARGS="$SCRIPT_ARGS --force-full-repair"
          fi

          if [ -n "$TARGET_ISSUE" ]; then
            SCRIPT_ARGS="$SCRIPT_ARGS --issue-number $TARGET_ISSUE"
          else
            SCRIPT_ARGS="$SCRIPT_ARGS --create-issue-on-failure"
          fi

          if [ "${{ steps.check-scripts.outputs.has_main_script }}" == "true" ]; then
            echo "ğŸš€ ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ: auto_error_repair_loop.py"
            python scripts/auto_error_repair_loop.py $SCRIPT_ARGS
            EXIT_CODE=$?
          elif [ "${{ steps.check-scripts.outputs.has_executor_script }}" == "true" ]; then
            echo "ğŸš€ ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ: repair-loop-executor.py"
            python scripts/repair-loop-executor.py $SCRIPT_ARGS
            EXIT_CODE=$?
          else
            echo "âŒ å®Ÿè¡Œå¯èƒ½ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

      - name: ğŸ“Š ä¿®å¾©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
        id: status
        if: always()
        run: |
          if [ -f repair_summary.json ]; then
            # JSONã‹ã‚‰æƒ…å ±æŠ½å‡º
            FINAL_STATUS=$(jq -r '.final_status // "unknown"' repair_summary.json)
            ERROR_REDUCTION=$(jq -r '.error_reduction_rate // 0' repair_summary.json)
            CRITICAL_ERRORS=$(jq -r '.critical_errors // 999' repair_summary.json)
            WARNING_ERRORS=$(jq -r '.warning_errors // 0' repair_summary.json)
            TOTAL_LOOPS=$(jq -r '.total_loops // 0' repair_summary.json)
            SUCCESS_COUNT=$(jq -r '.successful_repairs // 0' repair_summary.json)
            FAILED_COUNT=$(jq -r '.failed_repairs // 0' repair_summary.json)

            # å‡ºåŠ›
            echo "final_status=$FINAL_STATUS" >> $GITHUB_OUTPUT
            echo "error_reduction=$ERROR_REDUCTION" >> $GITHUB_OUTPUT
            echo "critical_errors=$CRITICAL_ERRORS" >> $GITHUB_OUTPUT
            echo "warning_errors=$WARNING_ERRORS" >> $GITHUB_OUTPUT
            echo "total_loops=$TOTAL_LOOPS" >> $GITHUB_OUTPUT
            echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT

            # æˆåŠŸåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ®µéšçš„ï¼‰
            if [ "$FINAL_STATUS" = "success" ]; then
              echo "result=success" >> $GITHUB_OUTPUT
              echo "result_emoji=âœ…" >> $GITHUB_OUTPUT
              echo "result_text=å®Œå…¨æˆåŠŸ" >> $GITHUB_OUTPUT
            elif [ "$FINAL_STATUS" = "partial_success" ] && [ "$CRITICAL_ERRORS" -eq 0 ]; then
              echo "result=success" >> $GITHUB_OUTPUT
              echo "result_emoji=âš ï¸" >> $GITHUB_OUTPUT
              echo "result_text=éƒ¨åˆ†çš„æˆåŠŸï¼ˆè­¦å‘Šã®ã¿æ®‹å­˜ï¼‰" >> $GITHUB_OUTPUT
            elif [ "$FINAL_STATUS" = "improved" ] && [ "$CRITICAL_ERRORS" -eq 0 ]; then
              echo "result=partial" >> $GITHUB_OUTPUT
              echo "result_emoji=ğŸ“ˆ" >> $GITHUB_OUTPUT
              echo "result_text=æ”¹å–„ï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼è§£æ¶ˆï¼‰" >> $GITHUB_OUTPUT
            elif [ "$FINAL_STATUS" = "attempted" ]; then
              echo "result=attempted" >> $GITHUB_OUTPUT
              echo "result_emoji=ğŸ”§" >> $GITHUB_OUTPUT
              echo "result_text=ä¿®å¾©è©¦è¡Œæ¸ˆã¿" >> $GITHUB_OUTPUT
            else
              echo "result=failed" >> $GITHUB_OUTPUT
              echo "result_emoji=âŒ" >> $GITHUB_OUTPUT
              echo "result_text=ä¿®å¾©å¤±æ•—" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ repair_summary.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "final_status=error" >> $GITHUB_OUTPUT
            echo "result=failed" >> $GITHUB_OUTPUT
            echo "result_emoji=â“" >> $GITHUB_OUTPUT
            echo "result_text=ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸æ˜" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ ä¿®å¾©çµæœã‚µãƒãƒªãƒ¼ä½œæˆ
        if: always()
        run: |
          echo "## ğŸ”§ çµ±åˆè‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ  - å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ${{ steps.status.outputs.result_emoji }} ${{ steps.status.outputs.result_text }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f repair_summary.json ]; then
            echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ${{ steps.status.outputs.final_status }} |" >> $GITHUB_STEP_SUMMARY
            echo "| å®Ÿè¡Œãƒ«ãƒ¼ãƒ—æ•° | ${{ steps.status.outputs.total_loops }} / ${{ needs.pre-check.outputs.max_loops }} |" >> $GITHUB_STEP_SUMMARY
            echo "| æˆåŠŸã—ãŸä¿®å¾© | ${{ steps.status.outputs.success_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "| å¤±æ•—ã—ãŸä¿®å¾© | ${{ steps.status.outputs.failed_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ã‚¨ãƒ©ãƒ¼å‰Šæ¸›ç‡ | ${{ steps.status.outputs.error_reduction }}% |" >> $GITHUB_STEP_SUMMARY
            echo "| ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ | ${{ steps.status.outputs.critical_errors }} |" >> $GITHUB_STEP_SUMMARY
            echo "| è­¦å‘Šãƒ¬ãƒ™ãƒ«ã‚¨ãƒ©ãƒ¼ | ${{ steps.status.outputs.warning_errors }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            if [ -f repair_summary.json ]; then
              RECOMMENDATIONS=$(jq -r '.recommendations[]? // empty' repair_summary.json)
              if [ -n "$RECOMMENDATIONS" ]; then
                echo "### ğŸ“ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
                echo "$RECOMMENDATIONS" | while read -r line; do
                  echo "- $line" >> $GITHUB_STEP_SUMMARY
                done
              fi
            fi
          else
            echo "âš ï¸ è©³ç´°ãªã‚µãƒãƒªãƒ¼æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¾ ãƒ­ã‚°ã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            repair_summary.json
            logs/auto_repair_*.log
            logs/repair_*.log
            *.log
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«å¤±æ•—æ™‚ã«Issueä½œæˆ
        if: |
          always() &&
          steps.status.outputs.result == 'failed' &&
          steps.status.outputs.critical_errors != '0' &&
          needs.pre-check.outputs.target_issue == ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summaryData = {
              final_status: 'unknown',
              total_loops: 0,
              successful_repairs: 0,
              failed_repairs: 0,
              error_reduction_rate: 0,
              critical_errors: 999,
              warning_errors: 0,
              detected_errors: [],
              recommendations: ['æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™']
            };

            try {
              if (fs.existsSync('repair_summary.json')) {
                summaryData = JSON.parse(fs.readFileSync('repair_summary.json', 'utf8'));
              }
            } catch (error) {
              console.error('ä¿®å¾©ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }

            const statusEmojis = {
              'success': 'âœ…',
              'partial_success': 'âš ï¸',
              'improved': 'ğŸ“ˆ',
              'attempted': 'ğŸ”§',
              'failed': 'âŒ',
              'unknown': 'â“'
            };

            const emoji = statusEmojis[summaryData.final_status] || 'â“';
            const timestamp = new Date().toISOString();

            const eventName = '${{ github.event_name }}';
            const runNumber = '${{ github.run_number }}';
            const maxLoops = '${{ needs.pre-check.outputs.max_loops }}';

            const issueBody = `
            ## ${emoji} è‡ªå‹•ä¿®å¾©å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ

            **å®Ÿè¡Œæ—¥æ™‚**: ${timestamp}
            **ãƒˆãƒªã‚¬ãƒ¼**: ${eventName}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œç•ªå·**: ${runNumber}

            ### ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼

            | é …ç›® | å€¤ |
            |------|-----|
            | æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ${summaryData.final_status} |
            | å®Ÿè¡Œãƒ«ãƒ¼ãƒ—æ•° | ${summaryData.total_loops || 0} / ${maxLoops} |
            | æˆåŠŸã—ãŸä¿®å¾© | ${summaryData.successful_repairs || 0} |
            | å¤±æ•—ã—ãŸä¿®å¾© | ${summaryData.failed_repairs || 0} |
            | ã‚¨ãƒ©ãƒ¼å‰Šæ¸›ç‡ | ${(summaryData.error_reduction_rate || 0).toFixed(1)}% |

            ### ğŸš¨ æ®‹å­˜ã‚¨ãƒ©ãƒ¼

            - **ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«**: ${summaryData.critical_errors || 0}
            - **è­¦å‘Š**: ${summaryData.warning_errors || 0}

            ### ğŸ” æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰

            ${summaryData.detected_errors?.filter(e => e.severity === 'high').map(e =>
              \`- **\${e.type}**: \${e.message}\`
            ).join('\\n') || 'ãªã—'}

            ### ğŸ“ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

            ${summaryData.recommendations?.map(r => \`- \${r}\`).join('\\n') || '- æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™'}

            ### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯

            - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ã‚³ãƒŸãƒƒãƒˆ](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

            ---

            ğŸ¤– ã“ã®Issueã¯çµ±åˆè‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ

            **å†å®Ÿè¡Œæ–¹æ³•**: ã“ã®Issueã« \`@auto-repair\` ã¨ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„
            `;

            // æ—¢å­˜ã®æœªè§£æ±ºauto-repair Issueã‚’ãƒã‚§ãƒƒã‚¯
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: '${{ env.LABEL_AUTO_REPAIR }},${{ env.LABEL_FAILED }}',
              state: 'open'
            });

            // æ—¢å­˜IssueãŒ5å€‹æœªæº€ãªã‚‰æ–°è¦ä½œæˆ
            if (existingIssues.data.length < 5) {
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: \`ğŸš¨ è‡ªå‹•ä¿®å¾©å¤±æ•— - \${new Date().toISOString().split('T')[0]} (\${summaryData.final_status})\`,
                body: issueBody,
                labels: [
                  '${{ env.LABEL_AUTO_REPAIR }}',
                  '${{ env.LABEL_FAILED }}',
                  '${{ env.LABEL_CRITICAL }}',
                  'bug',
                  'è¦ç¢ºèª'
                ],
                assignees: ['${{ github.repository_owner }}']
              });

              console.log(\`âœ… Issue #\${newIssue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ\`);
            } else {
              console.log('âš ï¸ æ—¢å­˜ã®IssueãŒ5å€‹ä»¥ä¸Šã‚ã‚‹ãŸã‚ã€æ–°è¦ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
            }

      - name: âœ… æˆåŠŸæ™‚ã«Issueã‚³ãƒ¡ãƒ³ãƒˆ
        if: |
          always() &&
          steps.status.outputs.result == 'success' &&
          needs.pre-check.outputs.target_issue != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let commentText = 'âœ… è‡ªå‹•ä¿®å¾©ãŒå®Œäº†ã—ã¾ã—ãŸ';

            try {
              if (fs.existsSync('repair_summary.json')) {
                const data = JSON.parse(fs.readFileSync('repair_summary.json', 'utf8'));
                commentText = \`
            ## âœ… è‡ªå‹•ä¿®å¾©å®Œäº†

            **æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${data.final_status}
            **å®Ÿè¡Œãƒ«ãƒ¼ãƒ—æ•°**: ${data.total_loops || 0} / ${{ needs.pre-check.outputs.max_loops }}
            **æˆåŠŸã—ãŸä¿®å¾©**: ${data.successful_repairs || 0}
            **ã‚¨ãƒ©ãƒ¼å‰Šæ¸›ç‡**: ${(data.error_reduction_rate || 0).toFixed(1)}%
            **æ®‹å­˜ã‚¨ãƒ©ãƒ¼**: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«=${data.critical_errors || 0}, è­¦å‘Š=${data.warning_errors || 0}

            ã™ã¹ã¦ã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ãŒä¿®å¾©ã•ã‚Œã¾ã—ãŸ ğŸ‰

            [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œè©³ç´°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            \`;
              }
            } catch (error) {
              console.error('ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-check.outputs.target_issue }},
              body: commentText
            });

            // ãƒ©ãƒ™ãƒ«æ›´æ–°
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-check.outputs.target_issue }},
              name: '${{ env.LABEL_IN_PROGRESS }}'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-check.outputs.target_issue }},
              labels: ['${{ env.LABEL_COMPLETED }}']
            });

            // Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-check.outputs.target_issue }},
              state: 'closed'
            });

      - name: ğŸ¯ ä¿®å¾©çµæœã«åŸºã¥ãçµ‚äº†åˆ¤å®š
        if: always()
        run: |
          RESULT="${{ steps.status.outputs.result }}"

          echo "ğŸ“Š æœ€çµ‚åˆ¤å®š: $RESULT"

          if [ "$RESULT" = "success" ]; then
            echo "âœ… ä¿®å¾©æˆåŠŸ - æ­£å¸¸çµ‚äº†"
            exit 0
          elif [ "$RESULT" = "partial" ]; then
            echo "âš ï¸ éƒ¨åˆ†çš„æˆåŠŸ - æ­£å¸¸çµ‚äº†ï¼ˆæ”¹å–„ã‚ã‚Šï¼‰"
            exit 0
          elif [ "$RESULT" = "attempted" ]; then
            echo "ğŸ”§ ä¿®å¾©è©¦è¡Œæ¸ˆã¿ - è­¦å‘Šä»˜ãçµ‚äº†"
            exit 0
          else
            echo "âŒ ä¿®å¾©å¤±æ•— - ã‚¨ãƒ©ãƒ¼çµ‚äº†"
            exit 1
          fi

  # ã‚¸ãƒ§ãƒ–3: å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ã®ã¿ï¼‰
  cleanup:
    name: ğŸ§¹ å¤ã„Issueã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ§¹ å¤ã„ä¿®å¾©Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
        run: |
          # 30æ—¥ä»¥ä¸Šæ›´æ–°ã•ã‚Œã¦ã„ãªã„ä¿®å¾©Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
          STALE_DATE=$(date -u -d '30 days ago' +%Y-%m-%dT%H:%M:%SZ)

          gh issue list \
            --label "${{ env.LABEL_AUTO_REPAIR }}" \
            --state open \
            --json number,updatedAt,labels \
            --jq ".[] | select(.updatedAt < \"$STALE_DATE\") | .number" | \
          while read -r ISSUE_NUMBER; do
            if [ -n "$ISSUE_NUMBER" ]; then
              echo "ğŸ§¹ Issue #$ISSUE_NUMBER ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ï¼ˆ30æ—¥ä»¥ä¸Šæ›´æ–°ãªã—ï¼‰"

              gh issue close $ISSUE_NUMBER \
                --comment "â° 30æ—¥é–“æ›´æ–°ãŒãªã„ãŸã‚ã€è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸã€‚å•é¡ŒãŒç¶™ç¶šã™ã‚‹å ´åˆã¯æ–°ã—ã„Issueã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚"

              gh issue edit $ISSUE_NUMBER \
                --remove-label "${{ env.LABEL_IN_PROGRESS }}" \
                --add-label "auto-closed-stale" || true
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚µãƒãƒªãƒ¼
        run: |
          TOTAL_OPEN=$(gh issue list --label "${{ env.LABEL_AUTO_REPAIR }}" --state open --json number --jq 'length')
          TOTAL_CLOSED=$(gh issue list --label "${{ env.LABEL_AUTO_REPAIR }}" --state closed --json number --jq 'length')

          echo "## ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ…‹ | ä»¶æ•° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚ªãƒ¼ãƒ—ãƒ³ | $TOTAL_OPEN |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¯ãƒ­ãƒ¼ã‚ºæ¸ˆã¿ | $TOTAL_CLOSED |" >> $GITHUB_STEP_SUMMARY
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
