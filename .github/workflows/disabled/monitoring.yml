name: CI/CDç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

on:
  # 6æ™‚é–“ã”ã¨ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 */6 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      send_alerts:
        description: 'ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡ã™ã‚‹ã‹'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  issues: write

jobs:
  monitoring:
    name: CI/CDç›£è¦–å®Ÿè¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # å±¥æ­´ã‚’å–å¾—

      - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install requests PyYAML

      - name: éå»ã®ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: repair-logs-*
          path: logs/

      - name: ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆå®Ÿè¡Œ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python scripts/monitoring_alert.py \
            --collect-metrics \
            --detect-anomalies \
            ${{ github.event.inputs.send_alerts == 'true' && '--send-alerts' || '' }}

      - name: ç›£è¦–çµæœã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          echo "## ğŸ“Š CI/CDç›£è¦–çµæœ" >> $GITHUB_STEP_SUMMARY

          if [ -f monitoring_report.json ]; then
            # ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
            SUCCESS_RATE=$(jq -r '.metrics.success_rate // 0' monitoring_report.json)
            TOTAL_REPAIRS=$(jq -r '.metrics.total_repairs // 0' monitoring_report.json)
            AVG_LOOPS=$(jq -r '.metrics.average_loops // 0' monitoring_report.json)
            ERROR_REDUCTION=$(jq -r '.metrics.error_reduction_rate // 0' monitoring_report.json)

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ˆ ãƒ¡ãƒˆãƒªã‚¯ã‚¹" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| æŒ‡æ¨™ | å€¤ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| ä¿®å¾©æˆåŠŸç‡ | ${SUCCESS_RATE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| ç·ä¿®å¾©å›æ•° | $TOTAL_REPAIRS |" >> $GITHUB_STEP_SUMMARY
            echo "| å¹³å‡ãƒ«ãƒ¼ãƒ—å›æ•° | $AVG_LOOPS |" >> $GITHUB_STEP_SUMMARY
            echo "| ã‚¨ãƒ©ãƒ¼å‰Šæ¸›ç‡ | ${ERROR_REDUCTION}% |" >> $GITHUB_STEP_SUMMARY

            # ç•°å¸¸æ¤œçŸ¥çµæœ
            ANOMALY_COUNT=$(jq '.anomalies | length' monitoring_report.json)

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸš¨ ç•°å¸¸æ¤œçŸ¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$ANOMALY_COUNT" -gt 0 ]; then
              echo "**æ¤œå‡ºã•ã‚ŒãŸç•°å¸¸**: $ANOMALY_COUNT ä»¶" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              jq -r '.anomalies[] | "- **\(.type)**: \(.message) (é‡å¤§åº¦: \(.severity))"' \
                monitoring_report.json >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… ç•°å¸¸ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            fi

            # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            if [ "$ANOMALY_COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ“ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "1. ç•°å¸¸ã®åŸå› ã‚’èª¿æŸ»" >> $GITHUB_STEP_SUMMARY
              echo "2. ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¦‹ç›´ã—" >> $GITHUB_STEP_SUMMARY
              echo "3. é–¾å€¤ã®èª¿æ•´ã‚’æ¤œè¨" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-report-${{ github.run_number }}
          path: |
            monitoring_report.json
          retention-days: 90

      - name: é‡å¤§ãªç•°å¸¸ã‚’æ¤œå‡ºã—ãŸå ´åˆã¯å¤±æ•—
        if: always()
        run: |
          if [ -f monitoring_report.json ]; then
            CRITICAL_COUNT=$(jq '[.anomalies[] | select(.severity == "critical")] | length' monitoring_report.json)

            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "ğŸš¨ é‡å¤§ãªç•°å¸¸ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
              exit 1
            fi
          fi

          exit 0
