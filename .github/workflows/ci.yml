name: üõ†Ô∏è Continuous Integration
# „Ç¢„Éã„É°„Éª„Éû„É≥„Ç¨ÊÉÖÂ†±ÈÖç‰ø°„Ç∑„Çπ„ÉÜ„É† - Á∂ôÁ∂öÁöÑ„Ç§„É≥„ÉÜ„Ç∞„É¨„Éº„Ç∑„Éß„É≥
# Updated: 2025-08-17 15:40 - Force workflow_dispatch refresh
# GitHub API Sync: 2025-08-17 16:00 - Force workflow_dispatch recognition

on:
  workflow_dispatch:
    inputs:
      iteration_number:
        description: '„É´„Éº„ÉóÂèçÂæ©Áï™Âè∑ (Loop iteration number)'
        required: false
        default: '1'
        type: string
      loop_id:
        description: '„É´„Éº„ÉóID (Loop ID)'
        required: false
        default: 'manual'
        type: string
  repository_dispatch:
    types: [trigger-ci, start-ci, manual-trigger]
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write        # Repository write access for commits
  actions: read          # GitHub Actions read access
  pull-requests: write   # Pull request creation and management
  issues: write          # Issue creation and management
  checks: write          # Status checks and reports
  metadata: read         # Repository metadata access

env:
  ITERATION_NUMBER: ${{ github.event.inputs.iteration_number || github.event.client_payload.iteration_number || '0' }}
  LOOP_ID: ${{ github.event.inputs.loop_id || github.event.client_payload.loop_id || 'standalone' }}
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  setup:
    name: üèóÔ∏è Setup Environment
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ steps.setup-info.outputs.python-version }}
      node-version: ${{ steps.setup-info.outputs.node-version }}
      iteration: ${{ steps.setup-info.outputs.iteration }}
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üìä Display build information / „Éì„É´„ÉâÊÉÖÂ†±„ÇíË°®Á§∫
      id: setup-info
      run: |
        echo "üöÄ CI Pipeline Started / CI„Éë„Ç§„Éó„É©„Ç§„É≥ÈñãÂßã"
        echo "üî¢ Iteration / ÂèçÂæ©: ${{ env.ITERATION_NUMBER }}"
        echo "üÜî Loop ID / „É´„Éº„ÉóID: ${{ env.LOOP_ID }}"
        echo "üìÖ Timestamp / „Çø„Ç§„É†„Çπ„Çø„É≥„Éó: $(date)"
        echo "üîó Commit SHA: ${{ github.sha }}"
        echo "üåø Branch / „Éñ„É©„É≥„ÉÅ: ${{ github.ref_name }}"
        
        echo "python-version=${{ env.PYTHON_VERSION }}" >> $GITHUB_OUTPUT
        echo "node-version=${{ env.NODE_VERSION }}" >> $GITHUB_OUTPUT
        echo "iteration=${{ env.ITERATION_NUMBER }}" >> $GITHUB_OUTPUT

  lint-and-format:
    name: üîç Lint & Format Check
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üêç Setup Python ${{ needs.setup.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}

    - name: üì¶ Install Python dependencies / Python‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        
        # Install project dependencies if requirements.txt exists
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: üîç Run Python linting / Python„É™„É≥„ÉÜ„Ç£„É≥„Ç∞ÂÆüË°å
      run: |
        echo "üîç Running flake8 linting..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || {
          echo "‚ùå Flake8 linting failed / „É™„É≥„ÉÜ„Ç£„É≥„Ç∞„Ç®„É©„Éº"
          exit 1
        }
        
        echo "‚úÖ Flake8 linting passed / „É™„É≥„ÉÜ„Ç£„É≥„Ç∞ÊàêÂäü"

    - name: üé® Check code formatting / „Ç≥„Éº„Éâ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
      run: |
        echo "üé® Checking code formatting with black..."
        black --check . || {
          echo "‚ùå Code formatting issues found / „Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂïèÈ°åÁô∫Ë¶ã"
          echo "üí° Run 'black .' to fix formatting issues"
          exit 1
        }
        
        echo "‚úÖ Code formatting is correct / „Éï„Ç©„Éº„Éû„ÉÉ„ÉàÊ≠£Â∏∏"

    - name: üìã Check import sorting / „Ç§„É≥„Éù„Éº„ÉàÈ†ÜÂ∫è„ÉÅ„Çß„ÉÉ„ÇØ
      run: |
        echo "üìã Checking import sorting..."
        isort --check-only . || {
          echo "‚ùå Import sorting issues found / „Ç§„É≥„Éù„Éº„ÉàÈ†ÜÂ∫èÂïèÈ°åÁô∫Ë¶ã"
          echo "üí° Run 'isort .' to fix import sorting"
          exit 1
        }
        
        echo "‚úÖ Import sorting is correct / „Ç§„É≥„Éù„Éº„ÉàÈ†ÜÂ∫èÊ≠£Â∏∏"

  security-scan:
    name: üîí Security Scan
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üêç Setup Python ${{ needs.setup.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}

    - name: üîí Install security tools / „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÑ„Éº„É´„Ç§„É≥„Çπ„Éà„Éº„É´
      run: |
        pip install bandit safety

    - name: üîç Run security scan / „Çª„Ç≠„É•„É™„ÉÜ„Ç£„Çπ„Ç≠„É£„É≥ÂÆüË°å
      run: |
        echo "üîí Running bandit security scan..."
        bandit -r . -f json -o bandit-report.json || true
        
        echo "üì¶ Checking for known security vulnerabilities..."
        safety check --json --output safety-report.json || true
        
        echo "‚úÖ Security scan completed / „Çª„Ç≠„É•„É™„ÉÜ„Ç£„Çπ„Ç≠„É£„É≥ÂÆå‰∫Ü"

    - name: üìä Upload security reports / „Çª„Ç≠„É•„É™„ÉÜ„Ç£„É¨„Éù„Éº„Éà„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports-${{ needs.setup.outputs.iteration }}
        path: |
          bandit-report.json
          safety-report.json

  test-python:
    name: üß™ Python Tests
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üêç Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: üì¶ Install dependencies / ‰æùÂ≠òÈñ¢‰øÇ„Ç§„É≥„Çπ„Éà„Éº„É´
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-html
        
        # Install project dependencies
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        
        # Install test dependencies
        if [ -f requirements-test.txt ]; then
          pip install -r requirements-test.txt
        fi

    - name: üß™ Run tests with intentional failures / ÊÑèÂõ≥ÁöÑÂ§±Êïó„ÇíÂê´„ÇÄ„ÉÜ„Çπ„ÉàÂÆüË°å
      run: |
        echo "üß™ Running Python tests..."
        
        # Create a test directory if it doesn't exist
        mkdir -p tests
        
        # Create a test file with intentional failures for demonstration
        cat > tests/test_demo.py << 'EOF'
        import pytest
        import os
        
        def test_basic_functionality():
            """Basic test that should pass"""
            assert 1 + 1 == 2
        
        def test_environment_setup():
            """Test environment variables"""
            # This test will fail intentionally in early iterations
            iteration = int(os.getenv('ITERATION_NUMBER', '0'))
            if iteration <= 3:
                pytest.fail("Environment not properly configured (intentional failure for demo)")
            assert True
        
        def test_data_processing():
            """Test data processing logic"""
            # This test will fail in iterations 1-2
            iteration = int(os.getenv('ITERATION_NUMBER', '0'))
            if iteration <= 2:
                assert False, "Data processing logic incomplete (intentional failure)"
            assert True
        
        def test_api_integration():
            """Test API integration"""
            # This test will fail in iteration 1
            iteration = int(os.getenv('ITERATION_NUMBER', '0'))
            if iteration <= 1:
                raise Exception("API integration not implemented (intentional failure)")
            assert True
        
        def test_advanced_features():
            """Test advanced features"""
            # This test will always pass
            assert "anime" in "manga and anime system"
        EOF
        
        # Run tests with coverage
        pytest tests/ \
          --cov=. \
          --cov-report=html \
          --cov-report=xml \
          --html=test-report.html \
          --self-contained-html \
          -v || {
          echo "‚ùå Some tests failed / „ÉÜ„Çπ„ÉàÂ§±Êïó"
          echo "üìä Test results will be analyzed for auto-repair"
          exit 1
        }
        
        echo "‚úÖ All tests passed / ÂÖ®„ÉÜ„Çπ„ÉàÊàêÂäü"
      env:
        ITERATION_NUMBER: ${{ needs.setup.outputs.iteration }}

    - name: üìä Upload test reports / „ÉÜ„Çπ„Éà„É¨„Éù„Éº„Éà„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports-python-${{ matrix.python-version }}-${{ needs.setup.outputs.iteration }}
        path: |
          test-report.html
          htmlcov/
          coverage.xml

  build-and-validate:
    name: üèóÔ∏è Build & Validate
    needs: [setup, lint-and-format]
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üêç Setup Python ${{ needs.setup.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}

    - name: üîß Setup Node.js ${{ needs.setup.outputs.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ needs.setup.outputs.node-version }}

    - name: üì¶ Install build dependencies / „Éì„É´„Éâ‰æùÂ≠òÈñ¢‰øÇ„Ç§„É≥„Çπ„Éà„Éº„É´
      run: |
        python -m pip install --upgrade pip build wheel
        npm install -g npm@latest

    - name: üèóÔ∏è Build Python package / Python„Éë„ÉÉ„Ç±„Éº„Ç∏„Éì„É´„Éâ
      run: |
        echo "üèóÔ∏è Building Python package..."
        
        # Create setup.py if it doesn't exist
        if [ ! -f setup.py ] && [ ! -f pyproject.toml ]; then
          cat > setup.py << 'EOF'
        from setuptools import setup, find_packages
        
        setup(
            name="manga-anime-delivery-system",
            version="1.0.0",
            packages=find_packages(),
            install_requires=[
                "requests",
                "beautifulsoup4",
                "sqlite3",
            ],
            author="Auto-Repair System",
            description="Manga and Anime Information Delivery System",
        )
        EOF
        fi
        
        python -m build || {
          echo "‚ùå Python package build failed / „Éë„ÉÉ„Ç±„Éº„Ç∏„Éì„É´„ÉâÂ§±Êïó"
          exit 1
        }
        
        echo "‚úÖ Python package built successfully / „Éë„ÉÉ„Ç±„Éº„Ç∏„Éì„É´„ÉâÊàêÂäü"

    - name: üîç Validate build artifacts / „Éì„É´„ÉâÊàêÊûúÁâ©Ê§úË®º
      run: |
        echo "üîç Validating build artifacts..."
        
        # Check if build artifacts exist
        if [ -d "dist/" ]; then
          ls -la dist/
          echo "‚úÖ Build artifacts found / „Éì„É´„ÉâÊàêÊûúÁâ©Á¢∫Ë™ç"
        else
          echo "‚ùå No build artifacts found / „Éì„É´„ÉâÊàêÊûúÁâ©„Å™„Åó"
          exit 1
        fi

    - name: üìä Upload build artifacts / „Éì„É´„ÉâÊàêÊûúÁâ©„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts-${{ needs.setup.outputs.iteration }}
        path: dist/

  integration-test:
    name: üîó Integration Tests
    needs: [setup, build-and-validate]
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üêç Setup Python ${{ needs.setup.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}

    - name: üóÑÔ∏è Setup test database / „ÉÜ„Çπ„Éà„Éá„Éº„Çø„Éô„Éº„ÇπË®≠ÂÆö
      run: |
        echo "üóÑÔ∏è Setting up test database..."
        sqlite3 test.db "CREATE TABLE IF NOT EXISTS test_table (id INTEGER PRIMARY KEY, name TEXT);"
        echo "‚úÖ Test database ready / „ÉÜ„Çπ„Éà„Éá„Éº„Çø„Éô„Éº„ÇπÊ∫ñÂÇôÂÆå‰∫Ü"

    - name: üîó Run integration tests / Áµ±Âêà„ÉÜ„Çπ„ÉàÂÆüË°å
      run: |
        echo "üîó Running integration tests..."
        
        # Create integration test
        cat > integration_test.py << 'EOF'
        import sqlite3
        import os
        
        def test_database_connection():
            """Test database connectivity"""
            try:
                conn = sqlite3.connect('test.db')
                cursor = conn.cursor()
                cursor.execute("SELECT name FROM sqlite_master WHERE type='table';")
                tables = cursor.fetchall()
                conn.close()
                
                assert len(tables) > 0, "No tables found in database"
                print("‚úÖ Database connection successful")
                return True
            except Exception as e:
                print(f"‚ùå Database connection failed: {e}")
                return False
        
        def test_system_integration():
            """Test system integration"""
            iteration = int(os.getenv('ITERATION_NUMBER', '0'))
            
            # Simulate integration issues in early iterations
            if iteration <= 2:
                print(f"‚ùå Integration test failed for iteration {iteration}")
                return False
            
            print("‚úÖ System integration successful")
            return True
        
        if __name__ == "__main__":
            success = True
            success &= test_database_connection()
            success &= test_system_integration()
            
            if not success:
                exit(1)
        EOF
        
        python integration_test.py
      env:
        ITERATION_NUMBER: ${{ needs.setup.outputs.iteration }}

  deploy-staging:
    name: üöÄ Deploy to Staging
    needs: [setup, test-python, integration-test]
    if: success()
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4

    - name: üöÄ Simulate staging deployment / „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É„Éá„Éó„É≠„Ç§„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
      run: |
        echo "üöÄ Deploying to staging environment..."
        echo "üî¢ Iteration: ${{ needs.setup.outputs.iteration }}"
        echo "üÜî Loop ID: ${{ env.LOOP_ID }}"
        
        # Simulate deployment process
        sleep 10
        
        echo "‚úÖ Staging deployment completed / „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞„Éá„Éó„É≠„Ç§ÂÆå‰∫Ü"
        echo "üåê Staging URL: https://staging.manga-anime-system.example.com"

  report-status:
    name: üìä Report CI Status
    needs: [setup, lint-and-format, security-scan, test-python, build-and-validate, integration-test, deploy-staging]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: üìä Generate CI summary / CIÁµêÊûú„Çµ„Éû„É™„ÉºÁîüÊàê
      run: |
        echo "üìä CI Pipeline Summary / CI„Éë„Ç§„Éó„É©„Ç§„É≥ÁµêÊûú"
        echo "=================================="
        echo "üî¢ Iteration / ÂèçÂæ©: ${{ needs.setup.outputs.iteration }}"
        echo "üÜî Loop ID / „É´„Éº„ÉóID: ${{ env.LOOP_ID }}"
        echo "üìÖ Completed at / ÂÆå‰∫ÜÊôÇÂàª: $(date)"
        echo ""
        echo "üìã Job Results / „Ç∏„Éß„ÉñÁµêÊûú:"
        echo "- Setup: ${{ needs.setup.result }}"
        echo "- Lint & Format: ${{ needs.lint-and-format.result }}"
        echo "- Security Scan: ${{ needs.security-scan.result }}"
        echo "- Python Tests: ${{ needs.test-python.result }}"
        echo "- Build & Validate: ${{ needs.build-and-validate.result }}"
        echo "- Integration Tests: ${{ needs.integration-test.result }}"
        echo "- Deploy Staging: ${{ needs.deploy-staging.result }}"
        echo ""
        
        # Determine overall status
        if [ "${{ needs.test-python.result }}" == "success" ] && \
           [ "${{ needs.integration-test.result }}" == "success" ] && \
           [ "${{ needs.build-and-validate.result }}" == "success" ]; then
          echo "üéØ Overall Status: SUCCESS / ÂÖ®‰Ωì„Çπ„ÉÜ„Éº„Çø„Çπ: ÊàêÂäü"
          exit 0
        else
          echo "‚ùå Overall Status: FAILURE / ÂÖ®‰Ωì„Çπ„ÉÜ„Éº„Çø„Çπ: Â§±Êïó"
          echo "üîß Auto-repair will be triggered / Ëá™Âãï‰øÆÂæ©„ÅåÂÆüË°å„Åï„Çå„Åæ„Åô"
          exit 1
        fi