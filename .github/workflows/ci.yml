name: ğŸ› ï¸ Continuous Integration
# ã‚¢ãƒ‹ãƒ¡ãƒ»ãƒãƒ³ã‚¬æƒ…å ±é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ  - ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
# Updated: 2025-08-17 15:40 - Force workflow_dispatch refresh
# GitHub API Sync: 2025-08-17 16:00 - Force workflow_dispatch recognition

on:
  workflow_dispatch:
    inputs:
      iteration_number:
        description: 'ãƒ«ãƒ¼ãƒ—åå¾©ç•ªå· (Loop iteration number)'
        required: false
        default: '1'
        type: string
      loop_id:
        description: 'ãƒ«ãƒ¼ãƒ—ID (Loop ID)'
        required: false
        default: 'manual'
        type: string
  repository_dispatch:
    types: [trigger-ci, start-ci, manual-trigger]
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write        # Repository write access for commits
  actions: read          # GitHub Actions read access
  pull-requests: write   # Pull request creation and management
  issues: write          # Issue creation and management
  checks: write          # Status checks and reports
  metadata: read         # Repository metadata access

env:
  ITERATION_NUMBER: ${{ github.event.inputs.iteration_number || github.event.client_payload.iteration_number || '0' }}
  LOOP_ID: ${{ github.event.inputs.loop_id || github.event.client_payload.loop_id || 'standalone' }}
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  setup:
    name: ğŸ—ï¸ Setup Environment
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ steps.setup-info.outputs.python-version }}
      node-version: ${{ steps.setup-info.outputs.node-version }}
      iteration: ${{ steps.setup-info.outputs.iteration }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“Š Display build information / ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’è¡¨ç¤º
      id: setup-info
      run: |
        echo "ğŸš€ CI Pipeline Started / CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³é–‹å§‹"
        echo "ğŸ”¢ Iteration / åå¾©: ${{ env.ITERATION_NUMBER }}"
        echo "ğŸ†” Loop ID / ãƒ«ãƒ¼ãƒ—ID: ${{ env.LOOP_ID }}"
        echo "ğŸ“… Timestamp / ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: $(date)"
        echo "ğŸ”— Commit SHA: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch / ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        
        echo "python-version=${{ env.PYTHON_VERSION }}" >> $GITHUB_OUTPUT
        echo "node-version=${{ env.NODE_VERSION }}" >> $GITHUB_OUTPUT
        echo "iteration=${{ env.ITERATION_NUMBER }}" >> $GITHUB_OUTPUT

  lint-and-format:
    name: ğŸ” Lint & Format Check
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.setup.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}

    - name: ğŸ“¦ Install Python dependencies / Pythonä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        
        # Install project dependencies if requirements.txt exists
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: ğŸ” Run Python linting / Pythonãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°å®Ÿè¡Œ
      run: |
        echo "ğŸ” Running flake8 linting..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || {
          echo "âŒ Flake8 linting failed / ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼"
          exit 1
        }
        
        echo "âœ… Flake8 linting passed / ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°æˆåŠŸ"

    - name: ğŸ¨ Check code formatting / ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      run: |
        echo "ğŸ¨ Checking code formatting with black..."
        black --check . || {
          echo "âŒ Code formatting issues found / ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå•é¡Œç™ºè¦‹"
          echo "ğŸ’¡ Run 'black .' to fix formatting issues"
          exit 1
        }
        
        echo "âœ… Code formatting is correct / ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ­£å¸¸"

    - name: ğŸ“‹ Check import sorting / ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºãƒã‚§ãƒƒã‚¯
      run: |
        echo "ğŸ“‹ Checking import sorting..."
        isort --check-only . || {
          echo "âŒ Import sorting issues found / ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºå•é¡Œç™ºè¦‹"
          echo "ğŸ’¡ Run 'isort .' to fix import sorting"
          exit 1
        }
        
        echo "âœ… Import sorting is correct / ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºæ­£å¸¸"

  security-scan:
    name: ğŸ”’ Security Scan
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.setup.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}

    - name: ğŸ”’ Install security tools / ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install bandit safety

    - name: ğŸ” Run security scan / ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
      run: |
        echo "ğŸ”’ Running bandit security scan..."
        bandit -r . -f json -o bandit-report.json || true
        
        echo "ğŸ“¦ Checking for known security vulnerabilities..."
        safety check --json --output safety-report.json || true
        
        echo "âœ… Security scan completed / ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

    - name: ğŸ“Š Upload security reports / ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports-${{ needs.setup.outputs.iteration }}
        path: |
          bandit-report.json
          safety-report.json

  test-python:
    name: ğŸ§ª Python Tests
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ Install dependencies / ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-html
        
        # Install project dependencies
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        
        # Install test dependencies
        if [ -f requirements-test.txt ]; then
          pip install -r requirements-test.txt
        fi

    - name: ğŸ§ª Run tests with intentional failures / æ„å›³çš„å¤±æ•—ã‚’å«ã‚€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "ğŸ§ª Running Python tests..."
        
        # Create a test directory if it doesn't exist
        mkdir -p tests
        
        # Create a test file with intentional failures for demonstration
        cat > tests/test_demo.py << 'EOF'
import pytest
import os

def test_basic_functionality():
    """Basic test that should pass"""
    assert 1 + 1 == 2

def test_environment_setup():
    """Test environment variables"""
    # This test will fail intentionally in early iterations
    iteration = int(os.getenv('ITERATION_NUMBER', '0'))
    if iteration <= 3:
        pytest.fail("Environment not properly configured (intentional failure for demo)")
    assert True

def test_data_processing():
    """Test data processing logic"""
    # This test will fail in iterations 1-2
    iteration = int(os.getenv('ITERATION_NUMBER', '0'))
    if iteration <= 2:
        assert False, "Data processing logic incomplete (intentional failure)"
    assert True

def test_api_integration():
    """Test API integration"""
    # This test will fail in iteration 1
    iteration = int(os.getenv('ITERATION_NUMBER', '0'))
    if iteration <= 1:
        raise Exception("API integration not implemented (intentional failure)")
    assert True

def test_advanced_features():
    """Test advanced features"""
    # This test will always pass
    assert "anime" in "manga and anime system"
EOF
        
        # Run tests with coverage
        pytest tests/ \
          --cov=. \
          --cov-report=html \
          --cov-report=xml \
          --html=test-report.html \
          --self-contained-html \
          -v || {
          echo "âŒ Some tests failed / ãƒ†ã‚¹ãƒˆå¤±æ•—"
          echo "ğŸ“Š Test results will be analyzed for auto-repair"
          exit 1
        }
        
        echo "âœ… All tests passed / å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸ"
      env:
        ITERATION_NUMBER: ${{ needs.setup.outputs.iteration }}

    - name: ğŸ“Š Upload test reports / ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports-python-${{ matrix.python-version }}-${{ needs.setup.outputs.iteration }}
        path: |
          test-report.html
          htmlcov/
          coverage.xml

  build-and-validate:
    name: ğŸ—ï¸ Build & Validate
    needs: [setup, lint-and-format]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.setup.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}

    - name: ğŸ”§ Setup Node.js ${{ needs.setup.outputs.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ needs.setup.outputs.node-version }}

    - name: ğŸ“¦ Install build dependencies / ãƒ“ãƒ«ãƒ‰ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip build wheel
        npm install -g npm@latest

    - name: ğŸ—ï¸ Build Python package / Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
      run: |
        echo "ğŸ—ï¸ Building Python package..."
        
        # Create setup.py if it doesn't exist
        if [ ! -f setup.py ] && [ ! -f pyproject.toml ]; then
          cat > setup.py << 'EOF'
from setuptools import setup, find_packages

setup(
    name="manga-anime-delivery-system",
    version="1.0.0",
    packages=find_packages(),
    install_requires=[
        "requests",
        "beautifulsoup4",
        "sqlite3",
    ],
    author="Auto-Repair System",
    description="Manga and Anime Information Delivery System",
)
EOF
        fi
        
        python -m build || {
          echo "âŒ Python package build failed / ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰å¤±æ•—"
          exit 1
        }
        
        echo "âœ… Python package built successfully / ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰æˆåŠŸ"

    - name: ğŸ” Validate build artifacts / ãƒ“ãƒ«ãƒ‰æˆæœç‰©æ¤œè¨¼
      run: |
        echo "ğŸ” Validating build artifacts..."
        
        # Check if build artifacts exist
        if [ -d "dist/" ]; then
          ls -la dist/
          echo "âœ… Build artifacts found / ãƒ“ãƒ«ãƒ‰æˆæœç‰©ç¢ºèª"
        else
          echo "âŒ No build artifacts found / ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãªã—"
          exit 1
        fi

    - name: ğŸ“Š Upload build artifacts / ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts-${{ needs.setup.outputs.iteration }}
        path: dist/

  integration-test:
    name: ğŸ”— Integration Tests
    needs: [setup, build-and-validate]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.setup.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.setup.outputs.python-version }}

    - name: ğŸ—„ï¸ Setup test database / ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
      run: |
        echo "ğŸ—„ï¸ Setting up test database..."
        sqlite3 test.db "CREATE TABLE IF NOT EXISTS test_table (id INTEGER PRIMARY KEY, name TEXT);"
        echo "âœ… Test database ready / ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™å®Œäº†"

    - name: ğŸ”— Run integration tests / çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "ğŸ”— Running integration tests..."
        
        # Create integration test
        cat > integration_test.py << 'EOF'
import sqlite3
import os

def test_database_connection():
    """Test database connectivity"""
    try:
        conn = sqlite3.connect('test.db')
        cursor = conn.cursor()
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table';")
        tables = cursor.fetchall()
        conn.close()
        
        assert len(tables) > 0, "No tables found in database"
        print("âœ… Database connection successful")
        return True
    except Exception as e:
        print(f"âŒ Database connection failed: {e}")
        return False

def test_system_integration():
    """Test system integration"""
    iteration = int(os.getenv('ITERATION_NUMBER', '0'))
    
    # Simulate integration issues in early iterations
    if iteration <= 2:
        print(f"âŒ Integration test failed for iteration {iteration}")
        return False
    
    print("âœ… System integration successful")
    return True

if __name__ == "__main__":
    success = True
    success &= test_database_connection()
    success &= test_system_integration()
    
    if not success:
        exit(1)
EOF
        
        python integration_test.py
      env:
        ITERATION_NUMBER: ${{ needs.setup.outputs.iteration }}

  deploy-staging:
    name: ğŸš€ Deploy to Staging
    needs: [setup, test-python, integration-test]
    if: success()
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸš€ Simulate staging deployment / ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        echo "ğŸ”¢ Iteration: ${{ needs.setup.outputs.iteration }}"
        echo "ğŸ†” Loop ID: ${{ env.LOOP_ID }}"
        
        # Simulate deployment process
        sleep 10
        
        echo "âœ… Staging deployment completed / ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
        echo "ğŸŒ Staging URL: https://staging.manga-anime-system.example.com"

  report-status:
    name: ğŸ“Š Report CI Status
    needs: [setup, lint-and-format, security-scan, test-python, build-and-validate, integration-test, deploy-staging]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“Š Generate CI summary / CIçµæœã‚µãƒãƒªãƒ¼ç”Ÿæˆ
      run: |
        echo "ğŸ“Š CI Pipeline Summary / CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµæœ"
        echo "=================================="
        echo "ğŸ”¢ Iteration / åå¾©: ${{ needs.setup.outputs.iteration }}"
        echo "ğŸ†” Loop ID / ãƒ«ãƒ¼ãƒ—ID: ${{ env.LOOP_ID }}"
        echo "ğŸ“… Completed at / å®Œäº†æ™‚åˆ»: $(date)"
        echo ""
        echo "ğŸ“‹ Job Results / ã‚¸ãƒ§ãƒ–çµæœ:"
        echo "- Setup: ${{ needs.setup.result }}"
        echo "- Lint & Format: ${{ needs.lint-and-format.result }}"
        echo "- Security Scan: ${{ needs.security-scan.result }}"
        echo "- Python Tests: ${{ needs.test-python.result }}"
        echo "- Build & Validate: ${{ needs.build-and-validate.result }}"
        echo "- Integration Tests: ${{ needs.integration-test.result }}"
        echo "- Deploy Staging: ${{ needs.deploy-staging.result }}"
        echo ""
        
        # Determine overall status
        if [ "${{ needs.test-python.result }}" == "success" ] && \
           [ "${{ needs.integration-test.result }}" == "success" ] && \
           [ "${{ needs.build-and-validate.result }}" == "success" ]; then
          echo "ğŸ¯ Overall Status: SUCCESS / å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æˆåŠŸ"
          exit 0
        else
          echo "âŒ Overall Status: FAILURE / å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¤±æ•—"
          echo "ğŸ”§ Auto-repair will be triggered / è‡ªå‹•ä¿®å¾©ãŒå®Ÿè¡Œã•ã‚Œã¾ã™"
          exit 1
        fi