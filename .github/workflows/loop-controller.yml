name: ğŸ”„ Auto-Repair Loop Controller
# ã‚¢ãƒ‹ãƒ¡ãƒ»ãƒãƒ³ã‚¬æƒ…å ±é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ  - è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼

on:
  workflow_dispatch:
    inputs:
      max_iterations:
        description: 'æœ€å¤§åå¾©å›æ•° (Maximum iterations)'
        required: false
        default: '10'
        type: string
      force_restart:
        description: 'å¼·åˆ¶ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ (Force restart)'
        required: false
        default: false
        type: boolean
  schedule:
    # æ¯æ—¥åˆå‰8æ™‚ï¼ˆJSTï¼‰ã«è‡ªå‹•å®Ÿè¡Œ - Daily at 8:00 AM JST
    - cron: '0 23 * * *'  # 23:00 UTC = 08:00 JST
  repository_dispatch:
    types: [start-auto-repair]

env:
  MAX_ITERATIONS: ${{ github.event.inputs.max_iterations || '10' }}
  FORCE_RESTART: ${{ github.event.inputs.force_restart || 'false' }}
  LOOP_STATE_FILE: '.github/state/loop-state.json'

jobs:
  initialize-loop:
    name: ğŸ Initialize Loop State
    runs-on: ubuntu-latest
    outputs:
      current_iteration: ${{ steps.get-state.outputs.current_iteration }}
      should_continue: ${{ steps.get-state.outputs.should_continue }}
      loop_id: ${{ steps.get-state.outputs.loop_id }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ” Get current loop state / ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ—çŠ¶æ…‹ã‚’å–å¾—
      id: get-state
      run: |
        mkdir -p .github/state
        
        # Force restart if requested
        if [ "${{ env.FORCE_RESTART }}" == "true" ]; then
          echo "ğŸ”„ Force restart requested - clearing state"
          rm -f ${{ env.LOOP_STATE_FILE }}
        fi
        
        # Initialize state file if it doesn't exist
        if [ ! -f "${{ env.LOOP_STATE_FILE }}" ]; then
          cat > ${{ env.LOOP_STATE_FILE }} << EOF
        {
          "loop_id": "$(date +%Y%m%d_%H%M%S)",
          "current_iteration": 1,
          "max_iterations": ${{ env.MAX_ITERATIONS }},
          "start_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "status": "running",
          "errors_resolved": [],
          "errors_remaining": [],
          "total_fixes_applied": 0
        }
        EOF
        fi
        
        # Read current state
        CURRENT_ITERATION=$(jq -r '.current_iteration' ${{ env.LOOP_STATE_FILE }})
        MAX_ITER=$(jq -r '.max_iterations' ${{ env.LOOP_STATE_FILE }})
        LOOP_ID=$(jq -r '.loop_id' ${{ env.LOOP_STATE_FILE }})
        
        echo "current_iteration=$CURRENT_ITERATION" >> $GITHUB_OUTPUT
        echo "loop_id=$LOOP_ID" >> $GITHUB_OUTPUT
        
        if [ "$CURRENT_ITERATION" -le "$MAX_ITER" ]; then
          echo "should_continue=true" >> $GITHUB_OUTPUT
          echo "âœ… Loop will continue - Iteration $CURRENT_ITERATION/$MAX_ITER"
        else
          echo "should_continue=false" >> $GITHUB_OUTPUT
          echo "â›” Loop completed - Maximum iterations reached"
        fi

    - name: ğŸ“Š Display loop status / ãƒ«ãƒ¼ãƒ—çŠ¶æ…‹ã‚’è¡¨ç¤º
      run: |
        echo "ğŸ”„ ãƒ«ãƒ¼ãƒ—ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼é–‹å§‹ - Loop Controller Started"
        echo "ğŸ“… å®Ÿè¡Œæ—¥æ™‚ / Execution Time: $(date)"
        echo "ğŸ”¢ ç¾åœ¨ã®åå¾© / Current Iteration: ${{ steps.get-state.outputs.current_iteration }}"
        echo "ğŸ¯ æœ€å¤§åå¾©æ•° / Max Iterations: ${{ env.MAX_ITERATIONS }}"
        echo "ğŸ†” ãƒ«ãƒ¼ãƒ—ID / Loop ID: ${{ steps.get-state.outputs.loop_id }}"
        echo "â–¶ï¸ ç¶™ç¶šåˆ¤å®š / Should Continue: ${{ steps.get-state.outputs.should_continue }}"

  run-ci-workflow:
    name: ğŸ› ï¸ Run CI Workflow
    needs: initialize-loop
    if: needs.initialize-loop.outputs.should_continue == 'true'
    runs-on: ubuntu-latest
    outputs:
      ci_status: ${{ steps.trigger-ci.outputs.status }}
      workflow_run_id: ${{ steps.trigger-ci.outputs.run_id }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸš€ Trigger CI workflow / CIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
      id: trigger-ci
      run: |
        echo "ğŸ”§ Starting CI workflow for iteration ${{ needs.initialize-loop.outputs.current_iteration }}"
        
        # Trigger the CI workflow
        gh workflow run ci.yml \
          --field iteration_number="${{ needs.initialize-loop.outputs.current_iteration }}" \
          --field loop_id="${{ needs.initialize-loop.outputs.loop_id }}"
        
        # Wait a moment for the workflow to start
        sleep 10
        
        # Get the latest run ID
        RUN_ID=$(gh run list --workflow=ci.yml --limit=1 --json databaseId --jq '.[0].databaseId')
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        
        echo "ğŸ“ CI workflow triggered with run ID: $RUN_ID"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: â³ Wait for CI completion / CIå®Œäº†ã‚’å¾…æ©Ÿ
      id: wait-ci
      run: |
        echo "â³ Waiting for CI workflow to complete..."
        RUN_ID="${{ steps.trigger-ci.outputs.run_id }}"
        
        # Wait for completion (max 30 minutes)
        timeout 1800 bash -c '
          while true; do
            STATUS=$(gh run view $1 --json status --jq .status)
            echo "Current status: $STATUS"
            
            if [ "$STATUS" = "completed" ]; then
              CONCLUSION=$(gh run view $1 --json conclusion --jq .conclusion)
              echo "Final conclusion: $CONCLUSION"
              echo "status=$CONCLUSION" >> $GITHUB_OUTPUT
              break
            fi
            
            sleep 30
          done
        ' -- "$RUN_ID"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  analyze-results:
    name: ğŸ“Š Analyze Results & Update State
    needs: [initialize-loop, run-ci-workflow]
    if: always() && needs.initialize-loop.outputs.should_continue == 'true'
    runs-on: ubuntu-latest
    outputs:
      next_iteration: ${{ steps.update-state.outputs.next_iteration }}
      should_continue_next: ${{ steps.update-state.outputs.should_continue_next }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”§ Setup Node.js for analysis
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“Š Generate performance report / ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        chmod +x .github/scripts/performance-report.js
        node .github/scripts/performance-report.js \
          --iteration "${{ needs.initialize-loop.outputs.current_iteration }}" \
          --loop-id "${{ needs.initialize-loop.outputs.loop_id }}" \
          --ci-status "${{ needs.run-ci-workflow.outputs.ci_status || 'failure' }}" \
          --run-id "${{ needs.run-ci-workflow.outputs.workflow_run_id || 'unknown' }}"

    - name: ğŸ”„ Update loop state / ãƒ«ãƒ¼ãƒ—çŠ¶æ…‹ã‚’æ›´æ–°
      id: update-state
      run: |
        # Make the script executable
        chmod +x .github/scripts/loop-status.sh
        
        # Update state
        ./.github/scripts/loop-status.sh \
          --iteration "${{ needs.initialize-loop.outputs.current_iteration }}" \
          --status "${{ needs.run-ci-workflow.outputs.ci_status || 'failure' }}" \
          --loop-id "${{ needs.initialize-loop.outputs.loop_id }}"
        
        # Get next iteration info
        NEXT_ITERATION=$(jq -r '.current_iteration' ${{ env.LOOP_STATE_FILE }})
        MAX_ITER=$(jq -r '.max_iterations' ${{ env.LOOP_STATE_FILE }})
        
        echo "next_iteration=$NEXT_ITERATION" >> $GITHUB_OUTPUT
        
        if [ "$NEXT_ITERATION" -le "$MAX_ITER" ] && [ "${{ needs.run-ci-workflow.outputs.ci_status || 'failure' }}" != "success" ]; then
          echo "should_continue_next=true" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Will continue to next iteration"
        else
          echo "should_continue_next=false" >> $GITHUB_OUTPUT
          echo "âœ… Loop completed or all issues resolved"
        fi

    - name: ğŸ“ Commit state updates / çŠ¶æ…‹æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .github/state/
        git add reports/
        
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ”„ Update loop state - iteration ${{ needs.initialize-loop.outputs.current_iteration }}"
          git push
        else
          echo "No changes to commit"
        fi

  schedule-next-iteration:
    name: ğŸ”„ Schedule Next Iteration
    needs: [analyze-results]
    if: needs.analyze-results.outputs.should_continue_next == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: â° Schedule next iteration / æ¬¡ã®åå¾©ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      run: |
        echo "ğŸ”„ Scheduling next iteration..."
        echo "Next iteration will be: ${{ needs.analyze-results.outputs.next_iteration }}"
        
        # Trigger the next iteration after a 5-minute delay
        sleep 300
        
        gh workflow run loop-controller.yml
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  final-report:
    name: ğŸ“‹ Generate Final Report
    needs: [initialize-loop, analyze-results]
    if: always() && (needs.analyze-results.outputs.should_continue_next == 'false' || needs.initialize-loop.outputs.should_continue == 'false')
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“Š Generate final summary / æœ€çµ‚ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
      run: |
        echo "ğŸ¯ Auto-Repair Loop Completed / è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Œäº†"
        echo "=================================="
        
        if [ -f "${{ env.LOOP_STATE_FILE }}" ]; then
          echo "ğŸ“Š Final Statistics / æœ€çµ‚çµ±è¨ˆ:"
          jq -r '
            "ğŸ”¢ Total Iterations / ç·åå¾©æ•°: " + (.current_iteration - 1 | tostring),
            "âœ… Fixes Applied / é©ç”¨ã•ã‚ŒãŸä¿®æ­£: " + (.total_fixes_applied | tostring),
            "â° Total Duration / ç·å®Ÿè¡Œæ™‚é–“: " + (now - (.start_time | fromdateiso8601) | . / 3600 | floor | tostring) + " hours",
            "ğŸ¯ Final Status / æœ€çµ‚çŠ¶æ…‹: " + .status
          ' ${{ env.LOOP_STATE_FILE }}
        fi
        
        echo ""
        echo "ğŸ“ See detailed reports in the reports/ directory"
        echo "ğŸ“ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã¯ reports/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„"