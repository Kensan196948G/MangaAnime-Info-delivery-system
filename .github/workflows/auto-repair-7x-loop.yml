name: ğŸ”„ 7x Auto Repair Loop System
# 7å›ãƒ«ãƒ¼ãƒ—è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ  - Issueãƒ™ãƒ¼ã‚¹ã®ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ç®¡ç†

on:
  # è‡ªå‹•å®Ÿè¡Œ1: 30åˆ†ã”ã¨ã®å®šæœŸãƒã‚§ãƒƒã‚¯
  schedule:
    - cron: '*/30 * * * *'
  
  # è‡ªå‹•å®Ÿè¡Œ2: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—æ™‚ã«è‡ªå‹•èµ·å‹•
  workflow_run:
    workflows:
      - "CI Pipeline"
      - "Security Check"
      - "Test Suite"
    types: [completed]
  
  # è‡ªå‹•å®Ÿè¡Œ3: Issueæ“ä½œæ™‚ã«è‡ªå‹•èµ·å‹•
  issues:
    types: [opened, closed, labeled, unlabeled]
  
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  workflow_dispatch:
    inputs:
      force_repair:
        description: 'å¼·åˆ¶ä¿®å¾©å®Ÿè¡Œ'
        required: false
        default: false
        type: boolean
      target_issue:
        description: 'å¯¾è±¡Issueç•ªå·'
        required: false
        type: string

permissions:
  contents: write
  issues: write
  actions: write
  pull-requests: write

env:
  MAX_ATTEMPTS_PER_CYCLE: 7
  COOLDOWN_MINUTES: 30
  MAX_CYCLES: 3
  REPAIR_LABEL: 'auto-repair-7x'
  IN_PROGRESS_LABEL: 'repair-in-progress'
  ESCALATION_LABEL: 'needs-human-intervention'

jobs:
  # ã‚¸ãƒ§ãƒ–1: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ã¨Issueä½œæˆ
  detect-and-create-issue:
    name: ğŸ” Detect Errors and Create Issue
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'failure'
    
    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
      should_repair: ${{ steps.check-repair.outputs.should_repair }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ” Check for existing issues
      id: check-existing
      run: |
        # æ—¢å­˜ã®ä¿®å¾©ä¸­Issueã‚’ãƒã‚§ãƒƒã‚¯
        EXISTING_ISSUES=$(gh issue list \
          --label "${{ env.REPAIR_LABEL }}" \
          --state open \
          --json number,title,labels \
          --jq '.[] | select(.labels[].name == "${{ env.IN_PROGRESS_LABEL }}") | .number')
        
        if [ -n "$EXISTING_ISSUES" ]; then
          echo "existing_issue=$EXISTING_ISSUES" >> $GITHUB_OUTPUT
          echo "has_existing=true" >> $GITHUB_OUTPUT
        else
          echo "has_existing=false" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“ Create repair issue
      id: create-issue
      if: steps.check-existing.outputs.has_existing != 'true'
      run: |
        # ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’åé›†
        WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
        WORKFLOW_URL="${{ github.event.workflow_run.html_url }}"
        ERROR_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        # Issueæœ¬æ–‡ã‚’ä½œæˆ
        ISSUE_BODY=$(cat << EOF
        ## ğŸš¨ è‡ªå‹•ä¿®å¾©ã‚¿ã‚¹ã‚¯
        
        **æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼:**
        - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: $WORKFLOW_NAME
        - å¤±æ•—ãƒªãƒ³ã‚¯: $WORKFLOW_URL
        - æ¤œå‡ºæ™‚åˆ»: $ERROR_TIME
        
        ## ğŸ“Š ä¿®å¾©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        
        ### ã‚µã‚¤ã‚¯ãƒ« 1/3
        - [ ] è©¦è¡Œ 1/7
        - [ ] è©¦è¡Œ 2/7
        - [ ] è©¦è¡Œ 3/7
        - [ ] è©¦è¡Œ 4/7
        - [ ] è©¦è¡Œ 5/7
        - [ ] è©¦è¡Œ 6/7
        - [ ] è©¦è¡Œ 7/7
        
        ### ã‚µã‚¤ã‚¯ãƒ« 2/3
        - [ ] è©¦è¡Œ 8/14
        - [ ] è©¦è¡Œ 9/14
        - [ ] è©¦è¡Œ 10/14
        - [ ] è©¦è¡Œ 11/14
        - [ ] è©¦è¡Œ 12/14
        - [ ] è©¦è¡Œ 13/14
        - [ ] è©¦è¡Œ 14/14
        
        ### ã‚µã‚¤ã‚¯ãƒ« 3/3
        - [ ] è©¦è¡Œ 15/21
        - [ ] è©¦è¡Œ 16/21
        - [ ] è©¦è¡Œ 17/21
        - [ ] è©¦è¡Œ 18/21
        - [ ] è©¦è¡Œ 19/21
        - [ ] è©¦è¡Œ 20/21
        - [ ] è©¦è¡Œ 21/21
        
        ## ğŸ“ ä¿®å¾©ãƒ­ã‚°
        
        | æ™‚åˆ» | ã‚µã‚¤ã‚¯ãƒ« | è©¦è¡Œ | çµæœ | è©³ç´° |
        |------|---------|------|------|------|
        EOF
        )
        
        # Issueã‚’ä½œæˆ
        ISSUE_NUMBER=$(gh issue create \
          --title "ğŸ”§ Auto Repair: $WORKFLOW_NAME failure" \
          --body "$ISSUE_BODY" \
          --label "${{ env.REPAIR_LABEL }}" \
          --label "${{ env.IN_PROGRESS_LABEL }}" \
          --assignee "@me" \
          | grep -oE '[0-9]+$')
        
        echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
        echo "âœ… Created repair issue #$ISSUE_NUMBER"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ¯ Set repair flag
      id: check-repair
      run: |
        if [ "${{ steps.check-existing.outputs.has_existing }}" == "true" ]; then
          echo "should_repair=false" >> $GITHUB_OUTPUT
        else
          echo "should_repair=true" >> $GITHUB_OUTPUT
        fi

  # ã‚¸ãƒ§ãƒ–2: ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
  execute-repair-loop:
    name: ğŸ”§ Execute Repair Loop
    runs-on: ubuntu-latest
    needs: [detect-and-create-issue]
    if: |
      always() && (
        needs.detect-and-create-issue.outputs.should_repair == 'true' ||
        github.event_name == 'schedule' ||
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'auto-repair-7x'))
      )
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install PyYAML requests

    - name: ğŸ” Find target issue
      id: find-issue
      run: |
        if [ "${{ github.event_name }}" == "issues" ]; then
          ISSUE_NUMBER="${{ github.event.issue.number }}"
        elif [ -n "${{ needs.detect-and-create-issue.outputs.issue_number }}" ]; then
          ISSUE_NUMBER="${{ needs.detect-and-create-issue.outputs.issue_number }}"
        elif [ -n "${{ github.event.inputs.target_issue }}" ]; then
          ISSUE_NUMBER="${{ github.event.inputs.target_issue }}"
        else
          # æœ€ã‚‚å¤ã„æœªè§£æ±ºã®repair issueã‚’å–å¾—
          ISSUE_NUMBER=$(gh issue list \
            --label "${{ env.REPAIR_LABEL }}" \
            --label "${{ env.IN_PROGRESS_LABEL }}" \
            --state open \
            --json number,createdAt \
            --jq 'sort_by(.createdAt) | .[0].number')
        fi
        
        if [ -z "$ISSUE_NUMBER" ]; then
          echo "No repair issues found"
          echo "has_issue=false" >> $GITHUB_OUTPUT
        else
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "has_issue=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Working on issue #$ISSUE_NUMBER"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“Š Check repair state
      id: check-state
      if: steps.find-issue.outputs.has_issue == 'true'
      run: |
        ISSUE_NUMBER="${{ steps.find-issue.outputs.issue_number }}"
        
        # Issueæœ¬æ–‡ã‹ã‚‰ç¾åœ¨ã®çŠ¶æ…‹ã‚’è§£æ
        ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body --jq '.body')
        
        # å®Œäº†ã—ãŸè©¦è¡Œå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        COMPLETED_ATTEMPTS=$(echo "$ISSUE_BODY" | grep -c "- \[x\]" || true)
        
        # ç¾åœ¨ã®ã‚µã‚¤ã‚¯ãƒ«ç•ªå·ã‚’è¨ˆç®—
        CURRENT_CYCLE=$(( ($COMPLETED_ATTEMPTS / ${{ env.MAX_ATTEMPTS_PER_CYCLE }}) + 1 ))
        ATTEMPT_IN_CYCLE=$(( ($COMPLETED_ATTEMPTS % ${{ env.MAX_ATTEMPTS_PER_CYCLE }}) + 1 ))
        
        # æœ€å¾Œã®ä¿®å¾©æ™‚åˆ»ã‚’å–å¾—
        LAST_ATTEMPT=$(gh issue view $ISSUE_NUMBER --json comments --jq '.comments[-1].createdAt // ""')
        
        # ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒã‚§ãƒƒã‚¯
        if [ -n "$LAST_ATTEMPT" ] && [ "$ATTEMPT_IN_CYCLE" -eq 1 ] && [ "$CURRENT_CYCLE" -gt 1 ]; then
          LAST_TIMESTAMP=$(date -d "$LAST_ATTEMPT" +%s)
          CURRENT_TIMESTAMP=$(date +%s)
          ELAPSED_MINUTES=$(( ($CURRENT_TIMESTAMP - $LAST_TIMESTAMP) / 60 ))
          
          if [ "$ELAPSED_MINUTES" -lt "${{ env.COOLDOWN_MINUTES }}" ]; then
            REMAINING=$(( ${{ env.COOLDOWN_MINUTES }} - $ELAPSED_MINUTES ))
            echo "â¸ï¸ In cooldown period. $REMAINING minutes remaining."
            echo "in_cooldown=true" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        
        echo "current_cycle=$CURRENT_CYCLE" >> $GITHUB_OUTPUT
        echo "attempt_in_cycle=$ATTEMPT_IN_CYCLE" >> $GITHUB_OUTPUT
        echo "total_attempts=$COMPLETED_ATTEMPTS" >> $GITHUB_OUTPUT
        echo "in_cooldown=false" >> $GITHUB_OUTPUT
        
        # ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        if [ "$CURRENT_CYCLE" -gt "${{ env.MAX_CYCLES }}" ]; then
          echo "needs_escalation=true" >> $GITHUB_OUTPUT
        else
          echo "needs_escalation=false" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: â¸ï¸ Wait for cooldown
      if: steps.check-state.outputs.in_cooldown == 'true'
      run: |
        echo "Repair is in cooldown period. Exiting..."
        exit 0
    
    - name: ğŸš¨ Escalate if needed
      if: steps.check-state.outputs.needs_escalation == 'true'
      run: |
        ISSUE_NUMBER="${{ steps.find-issue.outputs.issue_number }}"
        
        # ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
        gh issue comment $ISSUE_NUMBER --body "## ğŸš¨ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¿…è¦
        
        21å›ã®ä¿®å¾©è©¦è¡Œï¼ˆ3ã‚µã‚¤ã‚¯ãƒ«ï¼‰ãŒå®Œäº†ã—ã¾ã—ãŸãŒã€å•é¡Œã¯è§£æ±ºã—ã¦ã„ã¾ã›ã‚“ã€‚
        äººé–“ã®ä»‹å…¥ãŒå¿…è¦ã§ã™ã€‚
        
        @${{ github.repository_owner }} - æ‰‹å‹•ã§ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚"
        
        # ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
        gh issue edit $ISSUE_NUMBER \
          --remove-label "${{ env.IN_PROGRESS_LABEL }}" \
          --add-label "${{ env.ESCALATION_LABEL }}"
        
        echo "Issue escalated. Human intervention required."
        exit 0
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ”§ Execute repair attempt
      id: repair
      if: |
        steps.find-issue.outputs.has_issue == 'true' &&
        steps.check-state.outputs.in_cooldown != 'true' &&
        steps.check-state.outputs.needs_escalation != 'true'
      timeout-minutes: 5
      run: |
        ISSUE_NUMBER="${{ steps.find-issue.outputs.issue_number }}"
        CURRENT_CYCLE="${{ steps.check-state.outputs.current_cycle }}"
        ATTEMPT_IN_CYCLE="${{ steps.check-state.outputs.attempt_in_cycle }}"
        TOTAL_ATTEMPTS="${{ steps.check-state.outputs.total_attempts }}"
        
        echo "ğŸ”§ Executing repair attempt $((TOTAL_ATTEMPTS + 1))/21 (Cycle $CURRENT_CYCLE, Attempt $ATTEMPT_IN_CYCLE/7)"
        
        # ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        python scripts/repair-loop-executor.py \
          --issue-number "$ISSUE_NUMBER" \
          --cycle "$CURRENT_CYCLE" \
          --attempt "$ATTEMPT_IN_CYCLE" \
          --total "$((TOTAL_ATTEMPTS + 1))"
        
        REPAIR_RESULT=$?
        
        if [ "$REPAIR_RESULT" -eq 0 ]; then
          echo "repair_success=true" >> $GITHUB_OUTPUT
          echo "âœ… Repair attempt successful"
        else
          echo "repair_success=false" >> $GITHUB_OUTPUT
          echo "âŒ Repair attempt failed"
        fi
    
    - name: ğŸ“ Update issue status
      if: steps.find-issue.outputs.has_issue == 'true' && steps.repair.outcome != 'skipped'
      run: |
        ISSUE_NUMBER="${{ steps.find-issue.outputs.issue_number }}"
        CURRENT_CYCLE="${{ steps.check-state.outputs.current_cycle }}"
        ATTEMPT_IN_CYCLE="${{ steps.check-state.outputs.attempt_in_cycle }}"
        TOTAL_ATTEMPTS="${{ steps.check-state.outputs.total_attempts }}"
        REPAIR_SUCCESS="${{ steps.repair.outputs.repair_success }}"
        
        # Issueæœ¬æ–‡ã‚’å–å¾—
        ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body --jq '.body')
        
        # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
        ATTEMPT_NUMBER=$((TOTAL_ATTEMPTS + 1))
        if [ "$REPAIR_SUCCESS" == "true" ]; then
          RESULT_EMOJI="âœ…"
          RESULT_TEXT="æˆåŠŸ"
        else
          RESULT_EMOJI="âŒ"
          RESULT_TEXT="å¤±æ•—"
        fi
        
        # è©²å½“ã™ã‚‹è¡Œã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
        # ã“ã‚Œã¯ç°¡ç•¥åŒ–ã•ã‚ŒãŸä¾‹ã§ã™ã€‚å®Ÿéš›ã«ã¯ã‚‚ã£ã¨æ´—ç·´ã•ã‚ŒãŸæ–¹æ³•ãŒå¿…è¦
        NEW_BODY=$(echo "$ISSUE_BODY" | sed "${ATTEMPT_NUMBER}s/- \[ \]/- [x]/")
        
        # ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°ã—ã„è¡Œã‚’è¿½åŠ 
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
        NEW_LOG_ROW="| $TIMESTAMP | $CURRENT_CYCLE | $ATTEMPT_IN_CYCLE/7 | $RESULT_EMOJI | Attempt #$ATTEMPT_NUMBER |"
        
        # Issueã‚’æ›´æ–°
        gh issue comment $ISSUE_NUMBER --body "$NEW_LOG_ROW"
        
        # æˆåŠŸã—ãŸå ´åˆã¯Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
        if [ "$REPAIR_SUCCESS" == "true" ]; then
          gh issue close $ISSUE_NUMBER --comment "ğŸ‰ ä¿®å¾©æˆåŠŸï¼è©¦è¡Œ #$ATTEMPT_NUMBER ã§å•é¡ŒãŒè§£æ±ºã—ã¾ã—ãŸã€‚"
          gh issue edit $ISSUE_NUMBER --remove-label "${{ env.IN_PROGRESS_LABEL }}"
        fi
        
        # ã‚µã‚¤ã‚¯ãƒ«çµ‚äº†æ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆ
        if [ "$ATTEMPT_IN_CYCLE" -eq "${{ env.MAX_ATTEMPTS_PER_CYCLE }}" ] && [ "$REPAIR_SUCCESS" != "true" ]; then
          if [ "$CURRENT_CYCLE" -lt "${{ env.MAX_CYCLES }}" ]; then
            gh issue comment $ISSUE_NUMBER --body "## â¸ï¸ ã‚µã‚¤ã‚¯ãƒ« $CURRENT_CYCLE å®Œäº†
            
            7å›ã®ä¿®å¾©è©¦è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸã€‚
            30åˆ†ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å¾Œã€æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹ã—ã¾ã™ã€‚"
          fi
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ã‚¸ãƒ§ãƒ–3: å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  cleanup-old-issues:
    name: ğŸ§¹ Cleanup Old Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ§¹ Close stale issues
      run: |
        # 7æ—¥ä»¥ä¸Šæ›´æ–°ã•ã‚Œã¦ã„ãªã„ä¿®å¾©Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
        STALE_DATE=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)
        
        gh issue list \
          --label "${{ env.REPAIR_LABEL }}" \
          --state open \
          --json number,updatedAt \
          --jq ".[] | select(.updatedAt < \"$STALE_DATE\") | .number" | \
        while read -r ISSUE_NUMBER; do
          if [ -n "$ISSUE_NUMBER" ]; then
            gh issue close $ISSUE_NUMBER \
              --comment "â° 7æ—¥é–“æ›´æ–°ãŒãªã„ãŸã‚ã€è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸã€‚"
            gh issue edit $ISSUE_NUMBER \
              --remove-label "${{ env.IN_PROGRESS_LABEL }}" \
              --add-label "auto-closed"
          fi
        done
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}