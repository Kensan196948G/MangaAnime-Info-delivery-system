name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚·ã‚¹ãƒ†ãƒ  v2ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰

on:
  # ãƒ†ã‚¹ãƒˆç”¨pushãƒˆãƒªã‚¬ãƒ¼ï¼ˆä¸€æ™‚çš„ï¼‰
  push:
    branches: [main, fix-requirements-in-workflows]
    paths:
      - '.github/workflows/auto-error-detection-repair-v2.yml'

  # 30åˆ†ãŠãã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '*/30 * * * *'  # 30åˆ†ã”ã¨

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°'
        required: false
        default: '10'
        type: string
      force_full_repair:
        description: 'å®Œå…¨ä¿®å¾©ã‚’å¼·åˆ¶ï¼ˆè­¦å‘Šã‚‚ä¿®å¾©ï¼‰'
        required: false
        type: boolean
        default: false

  # Issueã‚³ãƒ¡ãƒ³ãƒˆã§ãƒˆãƒªã‚¬ãƒ¼
  issue_comment:
    types: [created]

# åŒæ™‚å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: auto-repair-system
  cancel-in-progress: false

jobs:
  error-detection-and-repair:
    runs-on: ubuntu-latest
    timeout-minutes: 25  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’5åˆ†å»¶é•·
    # Issueã‚³ãƒ¡ãƒ³ãƒˆãŒ@auto-repairã®å ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@auto-repair'))

    env:
      MAX_LOOPS: ${{ inputs.max_loops || '10' }}
      REPAIR_INTERVAL: '30'  # ç§’ï¼ˆGitHub Actionsç”¨ã«çŸ­ç¸®ï¼‰
      FORCE_FULL_REPAIR: ${{ inputs.force_full_repair || 'false' }}

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ç¢ºèªã¨requirementsæº–å‚™
        run: |
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ“‚ List root files:"
          ls -la

          # requirements.txtãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€data/ã‹ã‚‰ã‚³ãƒ”ãƒ¼
          if [ ! -f requirements.txt ]; then
            if [ -f data/requirements.txt ]; then
              echo "âœ“ Copying requirements.txt from data/"
              cp data/requirements.txt requirements.txt
            else
              echo "âš ï¸ Generating minimal requirements.txt"
              cat > requirements.txt << 'EOL'
requests>=2.31.0
PyYAML>=6.0.1
python-dotenv>=1.0.0
flask>=3.0.0
sqlalchemy>=2.0.0
google-api-python-client>=2.100.0
google-auth>=2.23.0
feedparser>=6.0.10
EOL
            fi
          fi

          if [ ! -f requirements-dev.txt ]; then
            if [ -f data/requirements-dev.txt ]; then
              echo "âœ“ Copying requirements-dev.txt from data/"
              cp data/requirements-dev.txt requirements-dev.txt
            else
              echo "âš ï¸ Generating minimal requirements-dev.txt"
              cat > requirements-dev.txt << 'EOL'
pytest>=7.4.0
pytest-cov>=4.1.0
flake8>=6.1.0
black>=23.0.0
EOL
            fi
          fi

          # æœ€çµ‚ç¢ºèª
          echo "ğŸ“‚ Final check:"
          ls -la requirements*.txt
          echo "ğŸ“‚ requirements.txt content:"
          head -5 requirements.txt

      - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
        timeout-minutes: 8
        uses: nick-fields/retry-action@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            set -e
            pip install --upgrade pip

            # å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«å®Ÿè¡Œï¼‰
            echo "ğŸ“¦ Installing core packages..."
            pip install requests PyYAML python-dotenv flask sqlalchemy google-api-python-client google-auth feedparser

            # requirements.txtã‹ã‚‰è¿½åŠ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            if [ -f requirements.txt ]; then
              echo "âœ“ requirements.txt found, installing additional packages..."
              pip install -r requirements.txt || echo "âš  Some packages from requirements.txt failed"
            else
              echo "âš  requirements.txt not found (should have been generated)"
            fi

            # requirements-dev.txtã‹ã‚‰é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
            if [ -f requirements-dev.txt ]; then
              echo "âœ“ requirements-dev.txt found, installing dev packages..."
              pip install -r requirements-dev.txt || echo "â„¹ Dev packages skipped"
            fi

            # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèª
            echo "ğŸ“¦ Installed packages:"
            pip list | grep -E "requests|PyYAML|flask|sqlalchemy"

      - name: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
        id: repair-loop
        timeout-minutes: 18
        continue-on-error: true  # å¤±æ•—ã—ã¦ã‚‚æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || '' }}
        run: |
          if [ -f scripts/auto_error_repair_loop.py ]; then
            python scripts/auto_error_repair_loop.py \
              --max-loops "$MAX_LOOPS" \
              --interval "$REPAIR_INTERVAL" \
              --issue-number "${ISSUE_NUMBER}" \
              --create-issue-on-failure \
              $( [ "$FORCE_FULL_REPAIR" = "true" ] && echo "--force-full-repair" || echo "" )
          else
            echo "âš ï¸ ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: scripts/auto_error_repair_loop.py"
            echo "repair_status=script_not_found" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: ä¿®å¾©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆ¤å®š
        id: check-status
        if: always()
        run: |
          if [ -f repair_summary.json ]; then
            # jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if ! command -v jq &> /dev/null; then
              echo "âš ï¸ jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™"
              echo "final_status=unknown" >> "$GITHUB_OUTPUT"
              echo "error_reduction=0" >> "$GITHUB_OUTPUT"
              echo "critical_errors=999" >> "$GITHUB_OUTPUT"
              echo "result=failed" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            FINAL_STATUS=$(jq -r '.final_status // "unknown"' repair_summary.json)
            ERROR_REDUCTION=$(jq -r '.error_reduction_rate // 0' repair_summary.json)
            CRITICAL_ERRORS=$(jq -r '.critical_errors // 999' repair_summary.json)

            echo "final_status=$FINAL_STATUS" >> "$GITHUB_OUTPUT"
            echo "error_reduction=$ERROR_REDUCTION" >> "$GITHUB_OUTPUT"
            echo "critical_errors=$CRITICAL_ERRORS" >> "$GITHUB_OUTPUT"

            # æˆåŠŸåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
            if [ "$FINAL_STATUS" = "success" ] || [ "$FINAL_STATUS" = "partial_success" ]; then
              echo "result=success" >> "$GITHUB_OUTPUT"
            elif [ "$FINAL_STATUS" = "improved" ] && [ "$CRITICAL_ERRORS" -eq 0 ]; then
              echo "result=success" >> "$GITHUB_OUTPUT"
            elif [ "$FINAL_STATUS" = "attempted" ]; then
              echo "result=partial" >> "$GITHUB_OUTPUT"
            else
              echo "result=failed" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "final_status=error" >> "$GITHUB_OUTPUT"
            echo "result=failed" >> "$GITHUB_OUTPUT"
          fi

      - name: ä¿®å¾©çµæœã‚µãƒãƒªãƒ¼ä½œæˆ
        if: always()
        run: |
          echo "## ğŸ”§ è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œçµæœ v2" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f repair_summary.json ]; then
            # jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if ! command -v jq &> /dev/null; then
              echo "âš ï¸ jqãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“" >> "$GITHUB_STEP_SUMMARY"
              cat repair_summary.json >> "$GITHUB_STEP_SUMMARY"
              exit 0
            fi

            # JSON ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
            FINAL_STATUS=$(jq -r '.final_status // "unknown"' repair_summary.json)
            TOTAL_LOOPS=$(jq -r '.total_loops // 0' repair_summary.json)
            MAX_LOOPS_VAL=$(jq -r '.max_loops // 0' repair_summary.json)
            SUCCESS_COUNT=$(jq -r '.successful_repairs // 0' repair_summary.json)
            FAILED_COUNT=$(jq -r '.failed_repairs // 0' repair_summary.json)
            ERROR_REDUCTION=$(jq -r '.error_reduction_rate // 0' repair_summary.json)
            CRITICAL_ERRORS=$(jq -r '.critical_errors // 0' repair_summary.json)
            WARNING_ERRORS=$(jq -r '.warning_errors // 0' repair_summary.json)

            # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
            case "$FINAL_STATUS" in
              "success")
                BADGE="âœ… å®Œå…¨æˆåŠŸ"
                ;;
              "partial_success")
                BADGE="âš ï¸ éƒ¨åˆ†çš„æˆåŠŸï¼ˆè­¦å‘Šã®ã¿æ®‹å­˜ï¼‰"
                ;;
              "improved")
                BADGE="ğŸ“ˆ æ”¹å–„ï¼ˆã‚¨ãƒ©ãƒ¼å‰Šæ¸›ç‡: ${ERROR_REDUCTION}%ï¼‰"
                ;;
              "attempted")
                BADGE="ğŸ”§ ä¿®å¾©è©¦è¡Œæ¸ˆã¿"
                ;;
              *)
                BADGE="âŒ å¤±æ•—"
                ;;
            esac

            echo "### $BADGE" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| é …ç›® | å€¤ |" >> "$GITHUB_STEP_SUMMARY"
            echo "|------|-----|" >> "$GITHUB_STEP_SUMMARY"
            echo "| ãƒ«ãƒ¼ãƒ—æ•° | $TOTAL_LOOPS / $MAX_LOOPS_VAL |" >> "$GITHUB_STEP_SUMMARY"
            echo "| æˆåŠŸã—ãŸä¿®å¾© | $SUCCESS_COUNT |" >> "$GITHUB_STEP_SUMMARY"
            echo "| å¤±æ•—ã—ãŸä¿®å¾© | $FAILED_COUNT |" >> "$GITHUB_STEP_SUMMARY"
            echo "| ã‚¨ãƒ©ãƒ¼å‰Šæ¸›ç‡ | ${ERROR_REDUCTION}% |" >> "$GITHUB_STEP_SUMMARY"
            echo "| ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ | $CRITICAL_ERRORS |" >> "$GITHUB_STEP_SUMMARY"
            echo "| è­¦å‘Šãƒ¬ãƒ™ãƒ«ã‚¨ãƒ©ãƒ¼ | $WARNING_ERRORS |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"

            # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            echo "### ğŸ“ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> "$GITHUB_STEP_SUMMARY"
            jq -r '.recommendations[]? | "- \(.)"' repair_summary.json >> "$GITHUB_STEP_SUMMARY" || echo "- æƒ…å ±ãªã—" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ ä¿®å¾©ã‚µãƒãƒªãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: ä¿®å¾©ãƒ­ã‚°ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-logs-${{ github.run_number }}
          path: |
            repair_summary.json
            logs/auto_repair_*.log
          retention-days: 30
          if-no-files-found: warn

      - name: å¤±æ•—æ™‚ã«Issueä½œæˆï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã®ã¿ï¼‰
        if: steps.check-status.outputs.result == 'failed' && steps.check-status.outputs.critical_errors != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = 'ä¿®å¾©ã‚µãƒãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';

            try {
              if (fs.existsSync('repair_summary.json')) {
                const data = JSON.parse(fs.readFileSync('repair_summary.json', 'utf8'));

                const statusBadges = {
                  'success': 'âœ…',
                  'partial_success': 'âš ï¸',
                  'improved': 'ğŸ“ˆ',
                  'attempted': 'ğŸ”§',
                  'failed': 'âŒ'
                };

                const badge = statusBadges[data.final_status] || 'â“';

                summary = `
            ## ${badge} è‡ªå‹•ä¿®å¾©å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ

            **å®Ÿè¡Œæ—¥æ™‚**: ${data.timestamp || new Date().toISOString()}
            **æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${data.final_status}
            **å®Ÿè¡Œãƒ«ãƒ¼ãƒ—æ•°**: ${data.total_loops || 0} / ${data.max_loops}
            **æˆåŠŸã—ãŸä¿®å¾©**: ${data.successful_repairs || 0}
            **å¤±æ•—ã—ãŸä¿®å¾©**: ${data.failed_repairs || 0}
            **ã‚¨ãƒ©ãƒ¼å‰Šæ¸›ç‡**: ${(data.error_reduction_rate || 0).toFixed(1)}%

            ### ğŸš¨ æ®‹å­˜ã‚¨ãƒ©ãƒ¼
            - **ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«**: ${data.critical_errors || 0}
            - **è­¦å‘Š**: ${data.warning_errors || 0}

            ### æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼
            ${data.detected_errors?.filter(e => e.severity === 'high').map(e => \`- **\${e.type}**: \${e.message}\`).join('\\n') || 'ãªã—'}

            ### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            ${data.recommendations?.map(r => \`- \${r}\`).join('\\n') || 'æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™'}

            ---
            ğŸ¤– ã“ã® Issue ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼ˆv2: æ®µéšçš„æˆåŠŸåˆ¤å®šï¼‰
            `;
              }
            } catch (error) {
              console.error('ä¿®å¾©ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }

            // æ—¢å­˜ã®æœªè§£æ±ºIssueã‚’ãƒã‚§ãƒƒã‚¯
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'auto-repair',
              state: 'open'
            });

            // æ—¢å­˜IssueãŒ5å€‹æœªæº€ãªã‚‰æ–°è¦ä½œæˆ
            if (existingIssues.data.length < 5) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: \`ğŸš¨ è‡ªå‹•ä¿®å¾©å¤±æ•— - \${new Date().toISOString().split('T')[0]}\`,
                body: summary,
                labels: ['auto-repair', 'bug', 'è¦ç¢ºèª', 'critical']
              });
            } else {
              console.log('æ—¢å­˜ã®IssueãŒ5å€‹ä»¥ä¸Šã‚ã‚‹ãŸã‚ã€æ–°è¦ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
            }

      - name: æˆåŠŸæ™‚ã«Issueã‚³ãƒ¡ãƒ³ãƒˆ
        if: steps.check-status.outputs.result == 'success' && github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = 'âœ… è‡ªå‹•ä¿®å¾©ãŒå®Œäº†ã—ã¾ã—ãŸ';

            try {
              if (fs.existsSync('repair_summary.json')) {
                const data = JSON.parse(fs.readFileSync('repair_summary.json', 'utf8'));
                comment = \`
            ## âœ… è‡ªå‹•ä¿®å¾©å®Œäº† v2

            **æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: \${data.final_status}
            **å®Ÿè¡Œãƒ«ãƒ¼ãƒ—æ•°**: \${data.total_loops || 0} / \${data.max_loops}
            **æˆåŠŸã—ãŸä¿®å¾©**: \${data.successful_repairs || 0}
            **ã‚¨ãƒ©ãƒ¼å‰Šæ¸›ç‡**: \${(data.error_reduction_rate || 0).toFixed(1)}%
            **æ®‹å­˜ã‚¨ãƒ©ãƒ¼**: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«=\${data.critical_errors || 0}, è­¦å‘Š=\${data.warning_errors || 0}

            ã™ã¹ã¦ã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ãŒä¿®å¾©ã•ã‚Œã¾ã—ãŸ ğŸ‰
            \`;
              }
            } catch (error) {
              console.error('ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: ä¿®å¾©çµæœã«åŸºã¥ãçµ‚äº†åˆ¤å®š
        if: always()
        run: |
          RESULT="${{ steps.check-status.outputs.result }}"

          if [ "$RESULT" = "success" ]; then
            echo "âœ… ä¿®å¾©æˆåŠŸ"
            exit 0
          elif [ "$RESULT" = "partial" ]; then
            echo "âš ï¸ éƒ¨åˆ†çš„æˆåŠŸï¼ˆä¸€éƒ¨ã‚¨ãƒ©ãƒ¼æ®‹å­˜ï¼‰"
            exit 0  # éƒ¨åˆ†æˆåŠŸã‚‚è¨±å®¹
          else
            echo "âŒ ä¿®å¾©å¤±æ•—"
            exit 1
          fi
