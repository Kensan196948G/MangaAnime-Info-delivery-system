name: Auto Repair Loop System

on:
  schedule:
    - cron: '*/15 * * * *'
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'modules/**'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'Maximum repair loops (1-15)'
        required: false
        default: '15'
        type: string
      interval_seconds:
        description: 'Interval between loops (seconds)'
        required: false
        default: '30'
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.12'
  MAX_LOOPS: ${{ github.event.inputs.max_loops || '15' }}
  INTERVAL_SECONDS: ${{ github.event.inputs.interval_seconds || '30' }}

jobs:
  repair-loop:
    name: Auto Repair Loop
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install flake8 black isort autoflake bandit mypy
          pip install -r requirements.txt || true

      - name: Run repair loop
        id: repair_loop
        run: |
          MAX_LOOPS=${{ env.MAX_LOOPS }}
          INTERVAL=${{ env.INTERVAL_SECONDS }}
          LOOP_COUNT=0
          TOTAL_FIXED=0
          EXTENDED_MODE=false

          echo "## Auto Repair Loop System" >> $GITHUB_STEP_SUMMARY
          echo "Max loops: $MAX_LOOPS" >> $GITHUB_STEP_SUMMARY
          echo "Interval: ${INTERVAL}s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          while [ $LOOP_COUNT -lt $MAX_LOOPS ]; do
            LOOP_COUNT=$((LOOP_COUNT + 1))
            echo "### Loop $LOOP_COUNT / $MAX_LOOPS" >> $GITHUB_STEP_SUMMARY

            # Detect errors
            flake8 app modules --count --select=E9,F63,F7,F82 --show-source --statistics > errors.txt 2>&1 || true
            ERROR_COUNT=$(tail -1 errors.txt | grep -oE '^[0-9]+' || echo "0")

            # Check Python syntax
            SYNTAX_ERRORS=0
            for file in $(find app modules -name "*.py" -type f 2>/dev/null); do
              python3 -c "import ast; ast.parse(open('$file').read())" 2>/dev/null || ((SYNTAX_ERRORS++)) || true
            done

            TOTAL_ERRORS=$((ERROR_COUNT + SYNTAX_ERRORS))
            echo "- Errors detected: $TOTAL_ERRORS (flake8: $ERROR_COUNT, syntax: $SYNTAX_ERRORS)" >> $GITHUB_STEP_SUMMARY

            if [ "$TOTAL_ERRORS" -eq 0 ]; then
              echo "- **All errors fixed!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              break
            fi

            # Apply auto-fix
            echo "- Applying auto-fix..." >> $GITHUB_STEP_SUMMARY

            # Remove unused imports
            autoflake --in-place --remove-all-unused-imports --recursive app modules 2>/dev/null || true

            # Format code
            black app modules --quiet 2>/dev/null || true

            # Sort imports
            isort app modules --quiet 2>/dev/null || true

            # Re-check errors
            flake8 app modules --count --select=E9,F63,F7,F82 > post_fix.txt 2>&1 || true
            POST_ERRORS=$(tail -1 post_fix.txt | grep -oE '^[0-9]+' || echo "0")

            FIXED=$((ERROR_COUNT - POST_ERRORS))
            if [ "$FIXED" -lt 0 ]; then FIXED=0; fi
            TOTAL_FIXED=$((TOTAL_FIXED + FIXED))

            echo "- Fixed in this loop: $FIXED" >> $GITHUB_STEP_SUMMARY
            echo "- Remaining errors: $POST_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # If no progress, wait and continue
            if [ "$FIXED" -eq 0 ] && [ "$POST_ERRORS" -gt 0 ]; then
              if [ "$LOOP_COUNT" -ge "$MAX_LOOPS" ]; then
                echo "Max loops reached. Switching to extended mode (5 min intervals)..." >> $GITHUB_STEP_SUMMARY
                EXTENDED_MODE=true
                break
              fi
            fi

            # Commit if changes exist
            if [ -n "$(git status --porcelain)" ]; then
              git config user.name "Auto Repair Bot"
              git config user.email "auto-repair@github-actions"
              git add -A
              git commit -m "[Auto Repair Loop $LOOP_COUNT] Fixed $FIXED errors, remaining: $POST_ERRORS" || true
            fi

            # Wait before next loop
            if [ $LOOP_COUNT -lt $MAX_LOOPS ] && [ "$POST_ERRORS" -gt 0 ]; then
              sleep $INTERVAL
            fi
          done

          # Final push
          if [ -n "$(git log origin/main..HEAD)" ]; then
            git push || true
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Total loops: $LOOP_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Total fixed: $TOTAL_FIXED" >> $GITHUB_STEP_SUMMARY
          echo "- Extended mode: $EXTENDED_MODE" >> $GITHUB_STEP_SUMMARY

          echo "loop_count=$LOOP_COUNT" >> $GITHUB_OUTPUT
          echo "total_fixed=$TOTAL_FIXED" >> $GITHUB_OUTPUT
          echo "extended_mode=$EXTENDED_MODE" >> $GITHUB_OUTPUT

      - name: Schedule extended repair (if needed)
        if: steps.repair_loop.outputs.extended_mode == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Extended mode triggered - would schedule 5-minute interval repairs');
            // In production, this would trigger a scheduled workflow or create an issue

      - name: Create issue if errors remain
        if: failure() || steps.repair_loop.outputs.extended_mode == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const loopCount = '${{ steps.repair_loop.outputs.loop_count }}';
            const totalFixed = '${{ steps.repair_loop.outputs.total_fixed }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[Auto Repair] Extended mode - ' + today,
              body: '## Auto Repair Loop Report\n\n' +
                    '- Loops completed: ' + loopCount + '\n' +
                    '- Total fixed: ' + totalFixed + '\n' +
                    '- Status: Extended mode (5 min intervals)\n\n' +
                    'Manual intervention may be required.\n\n' +
                    '---\nAuto Repair Loop System',
              labels: ['auto-repair', 'bug']
            });

  security-scan:
    name: Security Scan
    needs: repair-loop
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install bandit
        run: pip install bandit

      - name: Run security scan
        continue-on-error: true
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          bandit -r app modules -ll -ii -f txt > security.txt 2>&1 || true

          HIGH=$(grep -c "Severity: High" security.txt 2>/dev/null || echo "0")
          MEDIUM=$(grep -c "Severity: Medium" security.txt 2>/dev/null || echo "0")
          LOW=$(grep -c "Severity: Low" security.txt 2>/dev/null || echo "0")

          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY

  type-check:
    name: Type Check
    needs: repair-loop
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install mypy
        run: |
          pip install mypy
          pip install -r requirements.txt || true

      - name: Run type check
        continue-on-error: true
        run: |
          echo "## Type Check Results" >> $GITHUB_STEP_SUMMARY
          mypy app modules --ignore-missing-imports --no-error-summary > mypy.txt 2>&1 || true

          ERROR_COUNT=$(wc -l < mypy.txt || echo "0")
          echo "Type errors: $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY

  test-suite:
    name: Test Suite
    needs: repair-loop
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov pytest-timeout
          pip install -r requirements.txt || true

      - name: Run tests
        continue-on-error: true
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          pytest tests/ --tb=short -x --timeout=60 2>&1 | tee test.txt || true

          if grep -q "passed" test.txt; then
            PASSED=$(grep -oE '[0-9]+ passed' test.txt | grep -oE '[0-9]+' || echo "0")
            FAILED=$(grep -oE '[0-9]+ failed' test.txt | grep -oE '[0-9]+' || echo "0")
            echo "- Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
          else
            echo "Test execution error" >> $GITHUB_STEP_SUMMARY
          fi
