name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæœ¬ç•ªï¼‰

on:
  # 1æ™‚é–“ãŠãã«è‡ªå‹•å®Ÿè¡Œï¼ˆæœ¬ç•ªè¨­å®šï¼‰
  schedule:
    - cron: '0 * * * *'  # æ¯æ™‚0åˆ†å®Ÿè¡Œ

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°'
        required: false
        default: '10'
        type: string

  # Issueã‚³ãƒ¡ãƒ³ãƒˆã§ãƒˆãƒªã‚¬ãƒ¼
  issue_comment:
    types: [created]

# åŒæ™‚å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: auto-repair-system
  cancel-in-progress: false

jobs:
  error-detection-and-repair:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # æœ¬ç•ªç”¨: æœ€å¤§30åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    # Issueã‚³ãƒ¡ãƒ³ãƒˆãŒ@auto-repairã®å ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@auto-repair'))

    env:
      MAX_LOOPS: ${{ inputs.max_loops || '10' }}
      REPAIR_INTERVAL: '60'  # ç§’ï¼ˆæœ¬ç•ªè¨­å®š: å„ãƒ«ãƒ¼ãƒ—é–“éš”ï¼‰
      PRODUCTION_MODE: 'true'  # æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ç¢ºèªã¨requirementsæº–å‚™
        run: |
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ“‚ List root files:"
          ls -la

          # requirements.txtãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€data/ã‹ã‚‰ã‚³ãƒ”ãƒ¼
          if [ ! -f requirements.txt ] && [ -f data/requirements.txt ]; then
            echo "âœ“ Copying requirements.txt from data/"
            cp data/requirements.txt requirements.txt
          fi

          if [ ! -f requirements-dev.txt ] && [ -f data/requirements-dev.txt ]; then
            echo "âœ“ Copying requirements-dev.txt from data/"
            cp data/requirements-dev.txt requirements-dev.txt
          fi

          # æœ€çµ‚ç¢ºèª
          echo "ğŸ“‚ Final check:"
          ls -la requirements*.txt 2>&1 || echo "âš ï¸ Still no requirements files"

      - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        timeout-minutes: 5
        run: |
          pip install --upgrade pip

          # åŸºæœ¬çš„ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install requests PyYAML python-dotenv

          # requirements.txtãŒã‚ã‚‹å ´åˆã¯è¿½åŠ ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if [ -f requirements.txt ]; then
            echo "âœ“ requirements.txt found, installing..."
            pip install -r requirements.txt || echo "âš  requirements.txt installation failed, continuing with basic dependencies"
          else
            echo "âš  requirements.txt not found, using basic dependencies only"
          fi

          # requirements-dev.txtãŒã‚ã‚‹å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if [ -f requirements-dev.txt ]; then
            echo "âœ“ requirements-dev.txt found, installing..."
            pip install -r requirements-dev.txt || echo "âš  requirements-dev.txt installation skipped"
          fi

      - name: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
        id: repair-loop
        timeout-minutes: 15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || '' }}
        run: |
          if [ -f scripts/auto_error_repair_loop.py ]; then
            python scripts/auto_error_repair_loop.py \
              --max-loops "$MAX_LOOPS" \
              --interval "$REPAIR_INTERVAL" \
              --issue-number "${ISSUE_NUMBER}" \
              --create-issue-on-failure
          else
            echo "âš ï¸ ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: scripts/auto_error_repair_loop.py"
            exit 1
          fi

      - name: ä¿®å¾©çµæœã‚µãƒãƒªãƒ¼ä½œæˆ
        if: always()
        run: |
          echo "## ğŸ”§ è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œçµæœ" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f repair_summary.json ]; then
            if [ -f scripts/generate_repair_summary.py ]; then
              python scripts/generate_repair_summary.py repair_summary.json >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âš ï¸ ã‚µãƒãƒªãƒ¼ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "âš ï¸ ä¿®å¾©ã‚µãƒãƒªãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: ä¿®å¾©ãƒ­ã‚°ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-logs-${{ github.run_number }}
          path: |
            repair_summary.json
            logs/auto_repair_*.log
          retention-days: 30
          if-no-files-found: warn

      - name: å¤±æ•—æ™‚ã«Issueä½œæˆ
        if: failure() && steps.repair-loop.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = 'ä¿®å¾©ã‚µãƒãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';

            try {
              if (fs.existsSync('repair_summary.json')) {
                const data = JSON.parse(fs.readFileSync('repair_summary.json', 'utf8'));
                summary = `
            ## ğŸš¨ è‡ªå‹•ä¿®å¾©å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ

            **å®Ÿè¡Œæ—¥æ™‚**: ${data.timestamp || new Date().toISOString()}
            **å®Ÿè¡Œãƒ«ãƒ¼ãƒ—æ•°**: ${data.total_loops || 0} / ${process.env.MAX_LOOPS}
            **æˆåŠŸã—ãŸä¿®å¾©**: ${data.successful_repairs || 0}
            **å¤±æ•—ã—ãŸä¿®å¾©**: ${data.failed_repairs || 0}

            ### æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼
            ${data.detected_errors?.map(e => \`- \${e.type}: \${e.message}\`).join('\\n') || 'ãªã—'}

            ### ä¿®å¾©è©¦è¡Œå±¥æ­´
            ${data.repair_attempts?.map((a, i) => \`
            #### ãƒ«ãƒ¼ãƒ— ${i + 1}
            - **æ™‚åˆ»**: \${a.timestamp}
            - **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: \${a.action}
            - **çµæœ**: \${a.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
            \${a.error ? \`- **ã‚¨ãƒ©ãƒ¼**: \${a.error}\` : ''}
            \`).join('\\n') || 'ãªã—'}

            ### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            ${data.recommendations?.map(r => \`- \${r}\`).join('\\n') || 'æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™'}

            ---
            ğŸ¤– ã“ã® Issue ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
            `;
              }
            } catch (error) {
              console.error('ä¿®å¾©ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: \`ğŸš¨ è‡ªå‹•ä¿®å¾©å¤±æ•— - \${new Date().toISOString().split('T')[0]}\`,
              body: summary,
              labels: ['auto-repair', 'bug', 'è¦ç¢ºèª']
            });

      - name: æˆåŠŸæ™‚ã«Issueã‚³ãƒ¡ãƒ³ãƒˆ
        if: success() && github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = 'âœ… è‡ªå‹•ä¿®å¾©ãŒå®Œäº†ã—ã¾ã—ãŸ';

            try {
              if (fs.existsSync('repair_summary.json')) {
                const data = JSON.parse(fs.readFileSync('repair_summary.json', 'utf8'));
                comment = \`
            ## âœ… è‡ªå‹•ä¿®å¾©å®Œäº†

            **å®Ÿè¡Œãƒ«ãƒ¼ãƒ—æ•°**: \${data.total_loops || 0} / \${process.env.MAX_LOOPS}
            **æˆåŠŸã—ãŸä¿®å¾©**: \${data.successful_repairs || 0}
            **æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°**: \${data.detected_errors?.length || 0}

            ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãŒä¿®å¾©ã•ã‚Œã¾ã—ãŸ ğŸ‰
            \`;
              }
            } catch (error) {
              console.error('ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
