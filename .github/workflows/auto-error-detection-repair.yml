name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæœ¬ç•ªï¼‰

on:
  # 1æ™‚é–“ãŠãã«è‡ªå‹•å®Ÿè¡Œï¼ˆæœ¬ç•ªè¨­å®šï¼‰
  schedule:
    - cron: '0 * * * *'  # æ¯æ™‚0åˆ†å®Ÿè¡Œ

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°'
        required: false
        default: '10'
        type: string

  # Issueã‚³ãƒ¡ãƒ³ãƒˆã§ãƒˆãƒªã‚¬ãƒ¼
  issue_comment:
    types: [created]

# åŒæ™‚å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: auto-repair-system
  cancel-in-progress: false

jobs:
  error-detection-and-repair:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # æœ¬ç•ªç”¨: æœ€å¤§30åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    # Issueã‚³ãƒ¡ãƒ³ãƒˆãŒ@auto-repairã®å ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@auto-repair'))

    env:
      MAX_LOOPS: ${{ inputs.max_loops || '10' }}
      REPAIR_INTERVAL: '60'  # ç§’ï¼ˆæœ¬ç•ªè¨­å®š: å„ãƒ«ãƒ¼ãƒ—é–“éš”ï¼‰
      PRODUCTION_MODE: 'true'  # æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ç¢ºèªã¨requirementsæº–å‚™
        run: |
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ“‚ Git branch: $(git branch --show-current)"
          echo "ğŸ“‚ List root files:"
          ls -la

          # requirements.txtãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€è¤‡æ•°ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if [ ! -f requirements.txt ]; then
            if [ -f data/requirements.txt ]; then
              echo "âœ“ Copying requirements.txt from data/"
              cp data/requirements.txt requirements.txt
            else
              echo "âš ï¸ Generating minimal requirements.txt"
              echo "requests>=2.31.0" > requirements.txt
              echo "PyYAML>=6.0.1" >> requirements.txt
              echo "python-dotenv>=1.0.0" >> requirements.txt
              echo "flask>=3.0.0" >> requirements.txt
              echo "sqlalchemy>=2.0.0" >> requirements.txt
              echo "google-api-python-client>=2.100.0" >> requirements.txt
              echo "google-auth>=2.23.0" >> requirements.txt
              echo "feedparser>=6.0.10" >> requirements.txt
            fi
          fi

          if [ ! -f requirements-dev.txt ]; then
            if [ -f data/requirements-dev.txt ]; then
              echo "âœ“ Copying requirements-dev.txt from data/"
              cp data/requirements-dev.txt requirements-dev.txt
            else
              echo "âš ï¸ Generating minimal requirements-dev.txt"
              echo "pytest>=7.4.0" > requirements-dev.txt
              echo "pytest-cov>=4.1.0" >> requirements-dev.txt
              echo "flake8>=6.1.0" >> requirements-dev.txt
              echo "black>=23.0.0" >> requirements-dev.txt
              echo "autopep8>=2.0.4" >> requirements-dev.txt
            fi
          fi

          # æœ€çµ‚ç¢ºèª
          echo "ğŸ“‚ Final check:"
          ls -la requirements*.txt
          echo "ğŸ“‚ requirements.txt content:"
          head -5 requirements.txt

      - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        timeout-minutes: 5
        run: |
          set -e
          pip install --upgrade pip

          # å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆç¢ºå®Ÿã«å®Ÿè¡Œï¼‰
          echo "ğŸ“¦ Installing core packages..."
          pip install requests PyYAML python-dotenv flask sqlalchemy google-api-python-client google-auth feedparser

          # requirements.txtã‹ã‚‰è¿½åŠ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if [ -f requirements.txt ]; then
            echo "âœ“ requirements.txt found, installing additional packages..."
            pip install -r requirements.txt || echo "âš  Some packages from requirements.txt failed"
          else
            echo "âš  requirements.txt not found (should have been generated)"
          fi

          # requirements-dev.txtã‹ã‚‰é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
          if [ -f requirements-dev.txt ]; then
            echo "âœ“ requirements-dev.txt found, installing dev packages..."
            pip install -r requirements-dev.txt || echo "â„¹ Dev packages skipped"
          fi

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèª
          echo "ğŸ“¦ Installed packages:"
          pip list | grep -E "requests|PyYAML|flask|sqlalchemy"

      - name: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
        id: repair-loop
        timeout-minutes: 15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || '' }}
        run: |
          if [ -f scripts/auto_error_repair_loop.py ]; then
            python scripts/auto_error_repair_loop.py \
              --max-loops "$MAX_LOOPS" \
              --interval "$REPAIR_INTERVAL" \
              --issue-number "${ISSUE_NUMBER}" \
              --create-issue-on-failure
          else
            echo "âš ï¸ ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: scripts/auto_error_repair_loop.py"
            exit 1
          fi

      - name: ä¿®å¾©çµæœã‚µãƒãƒªãƒ¼ä½œæˆ
        if: always()
        run: |
          echo "## ğŸ”§ è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œçµæœ" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f repair_summary.json ]; then
            if [ -f scripts/generate_repair_summary.py ]; then
              python scripts/generate_repair_summary.py repair_summary.json >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âš ï¸ ã‚µãƒãƒªãƒ¼ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "âš ï¸ ä¿®å¾©ã‚µãƒãƒªãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: ä¿®å¾©ãƒ­ã‚°ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-logs-${{ github.run_number }}
          path: |
            repair_summary.json
            logs/auto_repair_*.log
          retention-days: 30
          if-no-files-found: warn

      - name: å¤±æ•—æ™‚ã«Issueä½œæˆ
        if: failure() && steps.repair-loop.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = 'ä¿®å¾©ã‚µãƒãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';

            try {
              if (fs.existsSync('repair_summary.json')) {
                const data = JSON.parse(fs.readFileSync('repair_summary.json', 'utf8'));
                const timestamp = data.timestamp || new Date().toISOString();
                const totalLoops = data.total_loops || 0;
                const maxLoops = process.env.MAX_LOOPS;
                const successfulRepairs = data.successful_repairs || 0;
                const failedRepairs = data.failed_repairs || 0;

                // ã‚¨ãƒ©ãƒ¼æƒ…å ±ã®æ•´å½¢
                let errorsText = 'ãªã—';
                if (data.detected_errors && data.detected_errors.length > 0) {
                  errorsText = data.detected_errors.map(e => `- ${e.type}: ${e.message}`).join('\n');
                }

                // ä¿®å¾©è©¦è¡Œå±¥æ­´ã®æ•´å½¢
                let attemptsText = 'ãªã—';
                if (data.repair_attempts && data.repair_attempts.length > 0) {
                  attemptsText = data.repair_attempts.map((a, i) => {
                    const result = a.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—';
                    const errorLine = a.error ? `\n- **ã‚¨ãƒ©ãƒ¼**: ${a.error}` : '';
                    return `#### ãƒ«ãƒ¼ãƒ— ${i + 1}\n- **æ™‚åˆ»**: ${a.timestamp}\n- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ${a.action}\n- **çµæœ**: ${result}${errorLine}`;
                  }).join('\n\n');
                }

                // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ•´å½¢
                let recommendationsText = 'æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™';
                if (data.recommendations && data.recommendations.length > 0) {
                  recommendationsText = data.recommendations.map(r => `- ${r}`).join('\n');
                }

                summary = `## ğŸš¨ è‡ªå‹•ä¿®å¾©å¤±æ•—ãƒ¬ãƒãƒ¼ãƒˆ

            **å®Ÿè¡Œæ—¥æ™‚**: ${timestamp}
            **å®Ÿè¡Œãƒ«ãƒ¼ãƒ—æ•°**: ${totalLoops} / ${maxLoops}
            **æˆåŠŸã—ãŸä¿®å¾©**: ${successfulRepairs}
            **å¤±æ•—ã—ãŸä¿®å¾©**: ${failedRepairs}

            ### æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼
            ${errorsText}

            ### ä¿®å¾©è©¦è¡Œå±¥æ­´
            ${attemptsText}

            ### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            ${recommendationsText}

            ---
            ğŸ¤– ã“ã® Issue ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ`;
              }
            } catch (error) {
              console.error('ä¿®å¾©ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }

            const today = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ è‡ªå‹•ä¿®å¾©å¤±æ•— - ${today}`,
              body: summary,
              labels: ['auto-repair', 'bug', 'è¦ç¢ºèª']
            });

      - name: æˆåŠŸæ™‚ã«Issueã‚³ãƒ¡ãƒ³ãƒˆ
        if: success() && github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = 'âœ… è‡ªå‹•ä¿®å¾©ãŒå®Œäº†ã—ã¾ã—ãŸ';

            // Issueç•ªå·ã®å–å¾—ã¨æ¤œè¨¼
            const issueNumber = context.issue?.number || context.payload?.issue?.number;

            if (!issueNumber) {
              console.log('âš ï¸ Issueç•ªå·ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
              return;
            }

            try {
              if (fs.existsSync('repair_summary.json')) {
                const data = JSON.parse(fs.readFileSync('repair_summary.json', 'utf8'));
                const totalLoops = data.total_loops || 0;
                const successfulRepairs = data.successful_repairs || 0;
                const detectedErrors = data.detected_errors?.length || 0;
                const maxLoops = process.env.MAX_LOOPS;

                comment = `## âœ… è‡ªå‹•ä¿®å¾©å®Œäº†

            **å®Ÿè¡Œãƒ«ãƒ¼ãƒ—æ•°**: ${totalLoops} / ${maxLoops}
            **æˆåŠŸã—ãŸä¿®å¾©**: ${successfulRepairs}
            **æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°**: ${detectedErrors}

            ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ãŒä¿®å¾©ã•ã‚Œã¾ã—ãŸ ğŸ‰`;
              }
            } catch (error) {
              console.error('ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
              // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            }

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: comment
              });
              console.log(`âœ… Issue #${issueNumber} ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ`);
            } catch (error) {
              console.error('âŒ ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
              core.setFailed(`ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
