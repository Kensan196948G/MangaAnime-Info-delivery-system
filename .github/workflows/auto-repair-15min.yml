name: ğŸ”§ è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ15åˆ†ãŠãå®šæœŸå®Ÿè¡Œï¼‰

# 15åˆ†ã”ã¨ã«è‡ªå‹•å®Ÿè¡Œ
on:
  schedule:
    - cron: '*/15 * * * *'  # 15åˆ†ã”ã¨

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  auto-repair:
    name: ğŸ”§ ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»è‡ªå‹•ä¿®å¾©
    runs-on: ubuntu-latest
    timeout-minutes: 14

    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install flake8 black isort
        continue-on-error: true

      - name: ğŸ” ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
        id: check
        run: |
          # é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã®ã¿ãƒã‚§ãƒƒã‚¯
          flake8 app modules --count --select=E9,F63,F7,F82 > errors.txt 2>&1 || true

          error_count=$(cat errors.txt | tail -1 | grep -oE '[0-9]+' || echo "0")
          echo "error_count=$error_count" >> $GITHUB_OUTPUT

          if [ "$error_count" -gt 0 ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "ğŸš¨ æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: $error_count"
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
            echo "âœ… ã‚¨ãƒ©ãƒ¼ãªã—"
          fi

      - name: ğŸ”§ è‡ªå‹•ä¿®å¾©
        if: steps.check.outputs.has_errors == 'true'
        run: |
          echo "ğŸ”§ è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™..."
          black app modules || true
          isort app modules || true

      - name: ğŸ’¾ ä¿®å¾©ã‚³ãƒŸãƒƒãƒˆ
        if: steps.check.outputs.has_errors == 'true'
        run: |
          git config user.name "Auto Repair Bot"
          git config user.email "auto-repair@github-actions"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "[è‡ªå‹•ä¿®å¾©] ã‚¨ãƒ©ãƒ¼${{ steps.check.outputs.error_count }}ä»¶ã‚’æ¤œçŸ¥ãƒ»ä¿®å¾©

è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ15åˆ†ãŠãï¼‰ã«ã‚ˆã‚Šä¿®å¾©

ğŸ¤– Auto Repair System
"
            git push
            echo "âœ… ä¿®å¾©å®Œäº†ãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: ğŸš¨ ã‚¨ãƒ©ãƒ¼æ™‚Issueä½œæˆ
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼',
              body: `è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

**å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toISOString()}
**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: è‡ªå‹•ä¿®å¾©ï¼ˆ15åˆ†ãŠãï¼‰

ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
              labels: ['auto-repair', 'bug']
            });

      - name: âœ… æˆåŠŸæ™‚ã®å‡¦ç†
        if: success()
        run: |
          echo "âœ… è‡ªå‹•ä¿®å¾©ã‚µã‚¤ã‚¯ãƒ«å®Œäº†"
          echo "   ã‚¨ãƒ©ãƒ¼æ•°: ${{ steps.check.outputs.error_count }}"
          echo "   æ¬¡å›å®Ÿè¡Œ: 15åˆ†å¾Œ"
