name: Auto Repair Loop System (7x with 30min cooldown)

on:
  # å®šæœŸå®Ÿè¡Œï¼ˆ30åˆ†ã”ã¨ï¼‰
  schedule:
    - cron: '*/30 * * * *'
  
  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—æ™‚ã«èµ·å‹•
  workflow_run:
    workflows: 
      - "Simple CI Pipeline"
      - "Security Audit & Quality Assurance"
      - "MangaAnime System Health Check"
      - "MangaAnime Auto Deployment"
    types: [completed]
    
  # Issueæ“ä½œæ™‚ã«èµ·å‹•
  issues:
    types: [opened, closed, labeled, unlabeled]
    
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      reset_counter:
        description: 'Reset loop counter'
        required: false
        default: 'false'
        type: boolean
      max_attempts:
        description: 'Maximum repair attempts per cycle'
        required: false
        default: '7'
        type: string

env:
  MAX_ATTEMPTS_PER_CYCLE: 7
  COOLDOWN_MINUTES: 30
  ISSUE_LABEL: 'auto-repair-7x'

permissions:
  contents: write
  issues: write
  actions: read
  pull-requests: write

jobs:
  # ã‚¸ãƒ§ãƒ–1: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ã¨Issueä½œæˆ
  detect-errors:
    name: Detect Errors and Create Issues
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.conclusion == 'failure'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check for existing issue
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: '${{ env.ISSUE_LABEL }}',
              state: 'open'
            });
            
            const workflowName = context.payload.workflow_run.name;
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(workflowName)
            );
            
            core.setOutput('exists', existingIssue ? 'true' : 'false');
            core.setOutput('issue_number', existingIssue ? existingIssue.number : '');
            
      - name: Create error issue
        if: steps.check-issue.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = context.payload.workflow_run.name;
            const workflowUrl = context.payload.workflow_run.html_url;
            const failureTime = new Date().toISOString();
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”§ Auto-Repair: ${workflowName} Failed`,
              body: `## ğŸš¨ Automated Error Detection
              
              **Failed Workflow:** ${workflowName}
              **Failure Time:** ${failureTime}
              **Workflow Run:** ${workflowUrl}
              **Commit:** ${context.payload.workflow_run.head_sha}
              
              ### ğŸ“Š Repair Status
              - **Current Cycle:** 1
              - **Attempts in Cycle:** 0 / ${process.env.MAX_ATTEMPTS_PER_CYCLE}
              - **Total Attempts:** 0
              - **Status:** ğŸ”„ Pending Repair
              
              ### ğŸ”„ Repair Loop Configuration
              - Max attempts per cycle: **7**
              - Cooldown between cycles: **30 minutes**
              - Auto-escalation after: **3 cycles**
              
              ### ğŸ“ Repair Log
              | Time | Cycle | Attempt | Action | Result |
              |------|-------|---------|--------|--------|
              | ${failureTime} | - | - | Error Detected | ğŸ”´ Failed |
              
              ---
              *This issue was automatically created by the Auto-Repair Loop System*
              `,
              labels: ['${{ env.ISSUE_LABEL }}', 'error', 'automated']
            });
            
            console.log(`Created issue #${issue.data.number}`);

  # ã‚¸ãƒ§ãƒ–2: ä¿®å¾©ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œ
  repair-loop:
    name: Execute Repair Loop
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && 
       contains(github.event.issue.labels.*.name, 'auto-repair-7x'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Get open repair issues
        id: get-issues
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: '${{ env.ISSUE_LABEL }}',
              state: 'open'
            });
            
            console.log(`Found ${issues.data.length} open repair issues`);
            core.setOutput('issue_count', issues.data.length);
            
            if (issues.data.length > 0) {
              // æœ€ã‚‚å¤ã„Issueã‹ã‚‰å‡¦ç†
              const oldestIssue = issues.data[issues.data.length - 1];
              core.setOutput('issue_number', oldestIssue.number);
              core.setOutput('issue_body', oldestIssue.body);
              return oldestIssue;
            }
            
            return null;
            
      - name: Parse repair status
        if: steps.get-issues.outputs.issue_count > 0
        id: parse-status
        run: |
          ISSUE_NUMBER="${{ steps.get-issues.outputs.issue_number }}"
          echo "Processing Issue #${ISSUE_NUMBER}"
          
          # Issueã®æœ¬æ–‡ã‹ã‚‰ç¾åœ¨ã®çŠ¶æ…‹ã‚’æŠ½å‡º
          # å®Ÿéš›ã«ã¯GitHub APIã‹ã‚‰å–å¾—ã—ãŸå†…å®¹ã‚’ãƒ‘ãƒ¼ã‚¹
          CURRENT_CYCLE=1
          CURRENT_ATTEMPT=0
          TOTAL_ATTEMPTS=0
          
          # ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          mkdir -p .repair-state
          echo "{
            \"issue_number\": ${ISSUE_NUMBER},
            \"current_cycle\": ${CURRENT_CYCLE},
            \"current_attempt\": ${CURRENT_ATTEMPT},
            \"total_attempts\": ${TOTAL_ATTEMPTS},
            \"last_update\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
          }" > .repair-state/status.json
          
          echo "current_cycle=${CURRENT_CYCLE}" >> $GITHUB_OUTPUT
          echo "current_attempt=${CURRENT_ATTEMPT}" >> $GITHUB_OUTPUT
          echo "total_attempts=${TOTAL_ATTEMPTS}" >> $GITHUB_OUTPUT
          
      - name: Check cooldown status
        if: steps.get-issues.outputs.issue_count > 0
        id: check-cooldown
        run: |
          # æœ€å¾Œã®ä¿®å¾©è©¦è¡Œã‹ã‚‰30åˆ†çµŒéã—ãŸã‹ãƒã‚§ãƒƒã‚¯
          if [ -f .repair-state/last_cycle_end.txt ]; then
            LAST_END=$(cat .repair-state/last_cycle_end.txt)
            CURRENT=$(date +%s)
            DIFF=$((CURRENT - LAST_END))
            
            if [ $DIFF -lt 1800 ]; then  # 30åˆ† = 1800ç§’
              REMAINING=$((1800 - DIFF))
              echo "â¸ï¸ Cooldown active. Remaining: ${REMAINING} seconds"
              echo "in_cooldown=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "in_cooldown=false" >> $GITHUB_OUTPUT
          
      - name: Execute repair attempt
        if: |
          steps.get-issues.outputs.issue_count > 0 && 
          steps.check-cooldown.outputs.in_cooldown != 'true'
        id: repair
        run: |
          CURRENT_ATTEMPT=${{ steps.parse-status.outputs.current_attempt }}
          CURRENT_CYCLE=${{ steps.parse-status.outputs.current_cycle }}
          
          # ç¾åœ¨ã®ã‚µã‚¤ã‚¯ãƒ«ã§7å›æœªæº€ã®å ´åˆã®ã¿å®Ÿè¡Œ
          if [ $CURRENT_ATTEMPT -lt ${{ env.MAX_ATTEMPTS_PER_CYCLE }} ]; then
            echo "ğŸ”§ Executing repair attempt $((CURRENT_ATTEMPT + 1)) of cycle ${CURRENT_CYCLE}"
            
            # ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
            bash scripts/fix-workflows.sh
            
            # æ¤œè¨¼ã‚’å®Ÿè¡Œ
            if python scripts/validate_workflow_fixes.py; then
              echo "repair_success=true" >> $GITHUB_OUTPUT
              echo "âœ… Repair successful!"
            else
              echo "repair_success=false" >> $GITHUB_OUTPUT
              echo "âŒ Repair failed, will retry..."
            fi
            
            # ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
            CURRENT_ATTEMPT=$((CURRENT_ATTEMPT + 1))
            echo "new_attempt=${CURRENT_ATTEMPT}" >> $GITHUB_OUTPUT
            
            # ã‚µã‚¤ã‚¯ãƒ«çµ‚äº†ãƒã‚§ãƒƒã‚¯
            if [ $CURRENT_ATTEMPT -ge ${{ env.MAX_ATTEMPTS_PER_CYCLE }} ]; then
              echo "ğŸ”„ Cycle ${CURRENT_CYCLE} completed. Entering cooldown..."
              date +%s > .repair-state/last_cycle_end.txt
              echo "cycle_complete=true" >> $GITHUB_OUTPUT
            else
              echo "cycle_complete=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Maximum attempts for this cycle reached"
            echo "skip_repair=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Update issue with results
        if: steps.get-issues.outputs.issue_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.get-issues.outputs.issue_number }};
            const repairSuccess = '${{ steps.repair.outputs.repair_success }}' === 'true';
            const cycleComplete = '${{ steps.repair.outputs.cycle_complete }}' === 'true';
            const newAttempt = parseInt('${{ steps.repair.outputs.new_attempt }}' || '0');
            const currentCycle = parseInt('${{ steps.parse-status.outputs.current_cycle }}');
            
            // Issueã®æœ¬æ–‡ã‚’æ›´æ–°
            let statusIcon = repairSuccess ? 'âœ…' : 'ğŸ”„';
            let statusText = repairSuccess ? 'Repair Successful' : 'Repair In Progress';
            
            if (cycleComplete) {
              statusText += ' (Cycle Complete - Entering Cooldown)';
            }
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `### ğŸ”§ Repair Attempt Update
              
              **Cycle:** ${currentCycle}
              **Attempt:** ${newAttempt} / ${{ env.MAX_ATTEMPTS_PER_CYCLE }}
              **Result:** ${repairSuccess ? 'âœ… Success' : 'âŒ Failed'}
              **Time:** ${new Date().toISOString()}
              
              ${cycleComplete ? 'â¸ï¸ **Entering 30-minute cooldown period...**' : ''}
              ${repairSuccess ? 'ğŸ‰ **Issue resolved! Closing automatically.**' : ''}
              `
            });
            
            // æˆåŠŸã—ãŸã‚‰Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
            if (repairSuccess) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
            }
            
      - name: Commit fixes if successful
        if: steps.repair.outputs.repair_success == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "ğŸ¤– Auto-repair: Fix workflow errors (Issue #${{ steps.get-issues.outputs.issue_number }})"
            git push
          fi

  # ã‚¸ãƒ§ãƒ–3: ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†
  escalation-manager:
    name: Manage Escalation
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: [repair-loop]
    
    steps:
      - name: Check for stuck issues
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: '${{ env.ISSUE_LABEL }}',
              state: 'open'
            });
            
            const now = new Date();
            const threeCyclesAgo = new Date(now - 3 * 60 * 60 * 1000); // 3æ™‚é–“å‰
            
            for (const issue of issues.data) {
              const createdAt = new Date(issue.created_at);
              
              if (createdAt < threeCyclesAgo) {
                // 3ã‚µã‚¤ã‚¯ãƒ«ï¼ˆ3æ™‚é–“ï¼‰ä»¥ä¸Šè§£æ±ºã—ã¦ã„ãªã„
                console.log(`Issue #${issue.number} needs escalation`);
                
                // ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['needs-human-intervention', 'priority:critical']
                });
                
                // ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `## âš ï¸ Escalation Required
                  
                  This issue has been through **3 repair cycles** (21 attempts) without resolution.
                  Human intervention is required.
                  
                  **Summary:**
                  - Total repair attempts: 21
                  - Time elapsed: ${Math.round((now - createdAt) / (1000 * 60 * 60))} hours
                  - Auto-repair status: **Suspended**
                  
                  @Kensan196948G Please review this issue manually.
                  `
                });
              }
            }