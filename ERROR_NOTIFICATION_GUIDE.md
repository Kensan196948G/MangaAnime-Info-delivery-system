# 🚨 エラー通知システム - 運用ガイド

## 📧 通知先設定

**通知先メールアドレス:** `kensan1969@gmail.com`

配信エラーやシステムエラー発生時に自動でメール通知が送信されます。

## 📊 監視項目

### 1. **配信エラー監視**
- メール配信失敗
- API接続エラー  
- RSS取得失敗
- **通知タイミング:** 配信後5分以内

### 2. **システムエラー監視**
- アプリケーションログエラー
- プロセス停止
- ディスク容量不足（85%以上）
- **監視間隔:** 30分おき

### 3. **バックアップエラー監視**  
- バックアップ失敗
- ファイル破損
- **監視間隔:** 毎時15分

### 4. **Cron実行エラー監視**
- スケジュール実行失敗
- スクリプトエラー
- **監視間隔:** 15分おき

## ⏰ 監視スケジュール

```bash
# 15分おきエラー監視（配信後の即座チェック）
5,20,35,50 * * * * エラーログチェック

# 30分おきシステムヘルスチェック  
10,40 * * * * システム状態チェック

# 1時間おき全体エラーチェック
0 * * * * 全項目チェック

# 配信直後のエラーチェック（各配信の5分後）
5 7,12,18 * * * Cron実行チェック

# バックアップエラーチェック（毎時15分）
15 * * * * バックアップ状態チェック
```

## 📬 通知メール内容

### **件名形式:**
```
🚨 MangaAnime システムエラー - [エラータイプ]
```

### **メール内容:**
- 🕒 **発生時刻**
- 📝 **エラー詳細**
- 📋 **最新ログ情報**
- 🔧 **推奨対応手順**
- 🌐 **WebUI アクセス先**

## 🛠️ 手動操作コマンド

### **テスト通知送信**
```bash
./scripts/error_monitor.sh test
```

### **即座エラーチェック**
```bash
# 全項目チェック
./scripts/error_monitor.sh all

# ログのみチェック
./scripts/error_monitor.sh logs

# システムのみチェック  
./scripts/error_monitor.sh system

# バックアップのみチェック
./scripts/error_monitor.sh backup
```

### **個別エラー通知送信**
```bash
python modules/error_notifier.py "エラータイプ" "エラーメッセージ" "詳細情報" "ログファイルパス"
```

## ⚙️ 設定詳細

### **通知制限設定**
- **クールダウン:** 30分間隔
- **時間制限:** 最大5通/時間
- **対象レベル:** ERROR, CRITICAL

### **設定ファイル:** `config.json`
```json
{
  "error_notifications": {
    "enabled": true,
    "recipient_email": "kensan1969@gmail.com",
    "cooldown_minutes": 30,
    "max_emails_per_hour": 5
  }
}
```

## 🔍 トラブルシューティング

### **通知が届かない場合**

1. **設定確認**
   ```bash
   cat config.json | jq .error_notifications
   ```

2. **テスト送信**
   ```bash
   ./scripts/error_monitor.sh test
   ```

3. **ログ確認**
   ```bash
   tail -20 logs/error_monitor.log
   ```

4. **メール設定確認**
   - Gmail App パスワード
   - SMTP接続設定

### **通知が多すぎる場合**

1. **クールダウン設定調整**
   ```json
   "cooldown_minutes": 60  // 30分→60分に延長
   ```

2. **時間制限調整**
   ```json
   "max_emails_per_hour": 3  // 5通→3通に削減
   ```

### **特定エラーを除外したい場合**

1. **監視スクリプト調整**
   ```bash
   vim scripts/error_monitor.sh
   # 特定パターンを除外
   ```

## 📱 推奨対応フロー

### **エラー通知受信時**

1. **🔍 初期確認**
   - WebUI アクセス: http://192.168.3.135:3030
   - システム状態確認

2. **📋 ログ詳細確認**
   ```bash
   tail -50 logs/app.log
   tail -50 logs/system.log
   ```

3. **🔧 対応実施**
   - エラー原因に応じた修正
   - 必要に応じてサービス再起動

4. **✅ 復旧確認**
   ```bash
   ./scripts/error_monitor.sh all
   ```

## 📊 監視ダッシュボード

**WebUI管理画面:** http://192.168.3.135:3030

- **📊 ダッシュボード:** システム全体状況
- **📝 ログビューア:** リアルタイムログ監視  
- **⚙️ 設定管理:** 通知設定変更
- **🔍 ヘルスチェック:** システム診断

---

**🎯 24時間365日の安定監視でシステムの信頼性を確保します！**