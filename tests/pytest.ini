[pytest]
# Pytest設定ファイル

# テストディレクトリ
testpaths = tests

# テストファイル・クラス・関数の命名規則
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# コマンドライン追加オプション
addopts =
    # 詳細出力
    --verbose
    # 短いトレースバック
    --tb=short
    # カバレッジ測定
    --cov=app
    --cov=scripts
    # カバレッジレポート形式
    --cov-report=html:htmlcov
    --cov-report=term-missing
    --cov-report=xml:coverage.xml
    # 最低カバレッジ閾値
    --cov-fail-under=75
    # 警告表示
    --strict-markers
    # 並列実行（8プロセス）
    -n auto
    # キャプチャ出力の制御
    --capture=no
    # 失敗したテストを最初に実行
    --failed-first
    # 重複テストの警告
    --durations=10

# マーカー定義
markers =
    slow: 低速テスト（5秒以上かかるテスト）
    integration: 統合テスト（複数モジュール連携）
    e2e: E2Eテスト（完全フロー）
    unit: 単体テスト（単一モジュール）
    api: 外部API連携テスト（モック推奨）
    database: データベース操作テスト
    security: セキュリティテスト
    performance: パフォーマンステスト
    smoke: スモークテスト（基本動作確認）

# カバレッジ除外パターン
[coverage:run]
omit =
    */tests/*
    */venv/*
    */migrations/*
    */__pycache__/*
    */site-packages/*
    */conftest.py

[coverage:report]
# カバレッジレポートから除外
exclude_lines =
    # デフォルト除外
    pragma: no cover
    # デバッグコード
    def __repr__
    # エラーハンドリング
    raise AssertionError
    raise NotImplementedError
    # 型チェック用
    if TYPE_CHECKING:
    # メイン実行ブロック
    if __name__ == .__main__.:
    # 抽象メソッド
    @abstractmethod

# 精度設定
precision = 2

# ログ設定
[pytest]
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = tests/logs/pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] [%(filename)s:%(lineno)d] %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# タイムアウト設定
timeout = 300
timeout_method = thread

# 最小Python バージョン
minversion = 3.9

# 一時ディレクトリ
[pytest]
tmp_path_retention_count = 3
tmp_path_retention_policy = failed
