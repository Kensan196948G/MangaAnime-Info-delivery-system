# 本番設定ガイド - 自動エラー検知・修復システム

## 📋 本番設定サマリー

### 自動実行スケジュール

| Workflow | 実行間隔 | 実行タイミング | 最大実行時間 |
|----------|---------|---------------|-------------|
| **自動修復ループ** | **1時間** | 毎時0分 | 30分 |
| Issue管理 | 毎日1回 | 0:00 | 10分 |
| 監視・アラート | 6時間 | 0:00, 6:00, 12:00, 18:00 | 5分 |

### 修復ループ設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `MAX_LOOPS` | **10回** | 最大ループ回数 |
| `REPAIR_INTERVAL` | **60秒** | 各ループ間の待機時間 |
| `timeout-minutes` | **30分** | Workflow全体のタイムアウト |
| `PRODUCTION_MODE` | **true** | 本番モードフラグ |

---

## 🎯 本番設定の特徴

### 1. 実行間隔: 1時間

**理由:**
- システム負荷の最適化
- GitHub Actions無料枠の効率的利用
- 十分な修復時間の確保

**実行例:**
```
00:00 - 自動実行 #1
01:00 - 自動実行 #2
02:00 - 自動実行 #3
...
23:00 - 自動実行 #24
```

1日あたり24回実行、月あたり約720回実行。

### 2. 最大ループ回数: 10回

**理由:**
- ほとんどのエラーは3-5ループで解消
- 10回でも解消しないエラーは手動対応が必要
- 実行時間のバランス（最大30分以内）

**実行フロー:**
```
ループ1 → エラー検知 → 修復 → 60秒待機
ループ2 → エラー検知 → 修復 → 60秒待機
...
ループ10 → エラー検知 → 修復 → 終了
```

### 3. 段階的成功判定

| ステータス | 条件 | Issue生成 |
|-----------|------|-----------|
| **Success** | エラー0個 | なし |
| **Partial Success** | クリティカル0 + 警告のみ | なし |
| **Improved** | エラー削減率50%以上 | なし |
| **Attempted** | 修復試行したが効果なし | 5回連続で生成 |
| **Failed** | クリティカルエラー残存 | 即座に生成 |

---

## 🔧 本番環境での動作

### 通常時（エラーなし）

```
00:00 実行開始
00:01 エラー検知完了（0個検出）
00:01 → Success ✅
00:01 実行終了（Issue生成なし）
```

### エラー検出時

```
01:00 実行開始
01:01 エラー検知（3個検出）
      - LintError: 200個
      - ImportError: 1個（軽微）

01:02 修復ループ開始
      ループ1: 修復実行 → エラー2個に減少
      60秒待機
      ループ2: 修復実行 → エラー0個

01:05 → Success ✅
01:05 実行終了（Issue生成なし）
```

### クリティカルエラー検出時

```
02:00 実行開始
02:01 エラー検知（10個検出）
      - SyntaxError: 1個（クリティカル）
      - LintError: 9個

02:02 修復ループ開始
      ループ1-10: 修復試行

02:15 → Failed ❌
02:15 Issue #XX自動生成
      タイトル: 🚨 自動修復失敗 - YYYY-MM-DD
      ラベル: auto-repair, bug, 要確認
```

---

## 📊 リソース使用量

### GitHub Actions無料枠

- **無料枠**: 月2,000分
- **本番使用**: 約720分/月（30分 × 24回/日 × 30日）
- **余裕**: 1,280分（約64%の余裕）

### コスト試算

- 無料枠内: **$0/月**
- 超過時: $0.008/分
- 予想コスト: **$0/月**（無料枠内）

---

## 🛡️ フェイルセーフ機構

### 1. タイムアウト保護

```yaml
timeout-minutes: 30  # 30分で強制終了
```

無限ループや処理停止を防止。

### 2. 同時実行防止

```yaml
concurrency:
  group: auto-repair-system
  cancel-in-progress: false
```

複数のWorkflowが同時実行されるのを防止。

### 3. Issue生成の制限

- クリティカルエラーのみ生成
- 最大5個まで（6個目以降は抑制）
- 7日後に自動クローズ

### 4. リトライロジック

- エラー発生時に最大3回リトライ
- 10秒間隔でリトライ
- 3回失敗したら次のループへ

---

## 📈 監視メトリクス

自動的に収集されるメトリクス：

### パフォーマンス
- 実行時間
- ループ回数
- 修復成功率

### エラー
- 検出されたエラー数
- エラー種別
- エラー削減率

### Issue
- 生成されたIssue数
- クローズされたIssue数
- 平均解決時間

---

## 🔔 アラート設定

### 異常検知条件

| 条件 | アラートレベル | アクション |
|------|---------------|-----------|
| 連続5回失敗 | 🟡 Warning | GitHub Issue |
| 連続10回失敗 | 🔴 Critical | Issue + Slack |
| 成功率<60% | 🟡 Warning | Issue |
| Issue数>10 | 🟡 Warning | 自動クリーンアップ |

---

## 🚀 本番運用開始手順

### ステップ1: 設定確認

```bash
# Workflow設定を確認
cat .github/workflows/auto-error-detection-repair.yml | head -40

# 期待値:
# - cron: '0 * * * *'  ← 1時間ごと
# - MAX_LOOPS: 10      ← 最大10回
# - timeout-minutes: 30 ← 30分タイムアウト
```

### ステップ2: 手動テスト実行

```bash
# GitHub Actionsで手動実行
gh workflow run "自動エラー検知・修復ループシステム（本番）"

# または
# GitHubのActionsタブ → Run workflow
```

### ステップ3: 初回実行の監視

次の毎時0分（例: 23:00）に自動実行されます。

**確認項目:**
- ✅ Workflow自動起動
- ✅ エラー検知実行
- ✅ 修復試行
- ✅ ステータス判定
- ✅ Issue生成（必要時のみ）

### ステップ4: 1週間の観察

```bash
# 実行履歴確認
gh run list --workflow="auto-error-detection-repair.yml" --limit 168

# 成功率確認
python scripts/monitoring_alert.py --report
```

---

## 📝 運用ルール

### DO（推奨）

- ✅ 毎週月曜日に実行履歴をレビュー
- ✅ 月1回、メトリクスレポートを確認
- ✅ Issue数が5個超えたら原因調査
- ✅ 成功率が80%未満なら設定見直し

### DON'T（非推奨）

- ❌ 実行間隔を30分未満にしない（負荷過多）
- ❌ タイムアウトを60分以上にしない（コスト増）
- ❌ 手動でIssueを大量削除しない（履歴が失われる）
- ❌ Workflowを頻繁に無効化しない（監視の空白期間が発生）

---

## 🆘 トラブルシューティング

### Q: 1時間ごとに実行されない

**A: Workflowが無効化されている可能性**

```bash
# Workflow一覧確認
gh workflow list

# 無効化されている場合は有効化
gh workflow enable "自動エラー検知・修復ループシステム（本番）"
```

### Q: Issueが大量に生成される

**A: クリティカルエラーが継続している**

```bash
# 最新のIssueを確認
gh issue view --web

# 手動で修正
python scripts/auto_error_repair_loop.py --max-loops 1

# 修正後、Issueを一括クローズ
python scripts/issue_manager.py --close-old 0
```

### Q: 修復が成功しない

**A: エラーが自動修復不可能**

手動で対応が必要です：
1. 最新のIssueで原因確認
2. ログファイルを確認（アーティファクト）
3. 該当コードを手動修正
4. プッシュ後、次回実行で確認

---

## 📚 関連ドキュメント

- [自動修復システム詳細](AUTO_ERROR_REPAIR_SYSTEM.md)
- [DevOps改善内容](docs/DEVOPS_IMPROVEMENTS.md)
- [クイックスタート](docs/DEVOPS_QUICKSTART.md)
- [最終レポート](FINAL_REPORT.md)

---

**設定日**: 2025年11月12日
**設定者**: DevOps Agent + Claude Code
**環境**: 本番（Production）
**ステータス**: ✅ 稼働中
