{% extends "base.html" %}

{% block title %}収集設定 - アニメ・マンガ情報配信システム{% endblock %}

{% block head %}
<style>
/* ========== グローバルスタイル ========== */
.settings-tab-content {
    min-height: 500px;
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 2rem 0;
}

/* タブコンテンツの幅を最大化 */
.settings-tab-content > .container-fluid {
    max-width: 100%;
    width: 100%;
}

/* ========== カード統一スタイル ========== */
.settings-card {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
    width: 100%;
}

.settings-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
}

.settings-card .card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #dee2e6;
    padding: 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.settings-card .card-header h5 {
    margin: 0;
    font-weight: 600;
    color: #1a1a1a;
}

.settings-card .card-header .card-subtitle {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.settings-card .card-body {
    padding: 1.5rem;
}

/* ========== ソース設定カード ========== */
.source-config-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
}

.source-config-card.enabled {
    border-left: 4px solid #198754;
    background-color: rgba(25, 135, 84, 0.02);
}

.source-config-card.disabled {
    border-left: 4px solid #6c757d;
    background-color: rgba(108, 117, 125, 0.02);
}

.source-config-card.error {
    border-left: 4px solid #dc3545;
    background-color: rgba(220, 53, 69, 0.02);
}

/* ========== 接続ステータス ========== */
.connection-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    padding: 0.35rem 0.75rem;
    border-radius: 1rem;
    font-weight: 500;
}

.connection-status.connected {
    background-color: rgba(25, 135, 84, 0.1);
    color: #198754;
}

.connection-status.disconnected {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

.connection-status.testing {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

/* ========== フォームセクション ========== */
.form-section {
    margin-bottom: 2rem;
}

.form-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-section-title i {
    font-size: 1.3rem;
}

/* ========== フォームコントロール ========== */
.form-label {
    font-weight: 500;
    color: #1a1a1a;
    margin-bottom: 0.5rem;
}

.form-label .label-description {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 400;
    display: block;
    margin-top: 0.25rem;
}

.form-control:focus,
.form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
}

/* フォームフィールドの幅を最大化 */
.form-control,
.form-select,
.input-group {
    width: 100%;
    max-width: 100%;
}

.settings-card textarea.form-control {
    width: 100%;
    max-width: 100%;
}

/* ========== キーワードタグ ========== */
.keyword-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #f0f2f5;
    border: 1px solid #dee2e6;
    border-radius: 1.5rem;
    padding: 0.35rem 0.85rem;
    margin: 0.25rem;
    font-size: 0.85rem;
    transition: all 0.2s ease;
}

.keyword-tag:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.keyword-tag .remove-keyword {
    cursor: pointer;
    color: #dc3545;
    font-weight: bold;
    padding: 0 4px;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.keyword-tag .remove-keyword:hover {
    background: #dc3545;
    color: white;
}

/* ========== スケジュールアイテム ========== */
.schedule-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 0.75rem;
    background: white;
    transition: all 0.2s ease;
}

.schedule-item:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
}

.schedule-item.active {
    border-color: #198754;
    background-color: rgba(25, 135, 84, 0.05);
}

.schedule-item .schedule-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.schedule-item .schedule-info {
    flex-grow: 1;
}

.schedule-item .schedule-name {
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 0.25rem;
}

.schedule-item .schedule-desc {
    font-size: 0.85rem;
    color: #6c757d;
}

.schedule-item .schedule-controls {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

/* ========== 統計カード ========== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.stats-card {
    background: white;
    border-radius: 0.375rem;
    padding: 1.25rem;
    border: 1px solid #dee2e6;
    text-align: center;
    transition: all 0.3s ease;
}

.stats-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    border-color: #0d6efd;
}

.stats-value {
    font-size: 2rem;
    font-weight: 700;
    color: #0d6efd;
    margin-bottom: 0.5rem;
}

.stats-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
}

/* ========== ボタングループ ========== */
.button-group {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.test-connection-btn {
    position: relative;
    overflow: hidden;
}

.test-connection-btn.testing::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

/* ========== アラート・情報パネル ========== */
.info-box {
    background: #e7f3ff;
    border-left: 4px solid #0d6efd;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.info-box i {
    color: #0d6efd;
    margin-right: 0.5rem;
}

.info-box strong {
    color: #0d6efd;
}

.warning-box {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.warning-box i {
    color: #ffc107;
    margin-right: 0.5rem;
}

.success-box {
    background: #d1e7dd;
    border-left: 4px solid #198754;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.success-box i {
    color: #198754;
    margin-right: 0.5rem;
}

/* ========== セクション区切り ========== */
.section-divider {
    border: none;
    border-top: 2px solid #dee2e6;
    margin: 2rem 0;
}

.section-divider.light {
    border-top: 1px solid #e9ecef;
    margin: 1.5rem 0;
}

/* ========== タイムライン ========== */
.timeline {
    position: relative;
    padding-left: 1.5rem;
}

.timeline-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.timeline-item i {
    font-size: 1.25rem;
    margin-right: 0.75rem;
    margin-top: 0.125rem;
}

.timeline-content {
    flex-grow: 1;
}

.timeline-time {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

.timeline-desc {
    font-size: 0.9rem;
    color: #1a1a1a;
}

/* ========== 高度な設定セクション ========== */
.advanced-settings {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1.5rem;
    margin-top: 1.5rem;
}

.advanced-settings .form-section-title {
    margin-bottom: 1rem;
}

/* ========== レスポンシブ対応 ========== */
@media (min-width: 1400px) {
    .settings-tab-content > .container-fluid {
        padding-left: 3rem;
        padding-right: 3rem;
    }
}

@media (max-width: 1199px) {
    .col-12.col-xl-8,
    .col-12.col-xl-4,
    .col-12.col-xl-6 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 1.5rem;
    }
}

@media (max-width: 992px) {
    .settings-card .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .schedule-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .schedule-item .schedule-controls {
        width: 100%;
        justify-content: flex-start;
    }
}

@media (max-width: 768px) {
    .settings-tab-content {
        padding: 1rem 0;
    }

    .settings-tab-content > .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }

    .settings-card {
        margin-bottom: 1rem;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .button-group {
        flex-direction: column;
    }

    .button-group .btn {
        width: 100%;
    }

    .form-section-title {
        font-size: 1rem;
    }

    .timeline {
        padding-left: 1rem;
    }
}

/* ========== 追加スタイル ========== */
.badge-status {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.8rem;
    font-weight: 600;
}

.badge-status.active {
    background: rgba(25, 135, 84, 0.15);
    color: #198754;
}

.badge-status.inactive {
    background: rgba(108, 117, 125, 0.15);
    color: #6c757d;
}
</style>

<!-- 通知ステータス表示用CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/notification-status.css') }}">

<!-- 収集設定拡張スタイル -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/collection-settings.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- ========== ページヘッダー ========== -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">収集設定</h1>
            <p class="text-muted mb-0">データ収集源、フィルター、スケジュール、通知設定を一元管理します</p>
        </div>
        <div class="button-group">
            <button class="btn btn-outline-secondary" id="importBtn">
                <i class="bi bi-upload"></i> インポート
            </button>
            <button class="btn btn-outline-primary" id="exportBtn">
                <i class="bi bi-download"></i> エクスポート
            </button>
            <button class="btn btn-success" id="saveAllBtn">
                <i class="bi bi-check-lg"></i> すべて保存
            </button>
        </div>
    </div>

    <!-- ========== タブナビゲーション ========== -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources" type="button" role="tab" aria-controls="sources" aria-selected="true">
                <i class="bi bi-globe me-2"></i>収集ソース
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="filters-tab" data-bs-toggle="tab" data-bs-target="#filters" type="button" role="tab" aria-controls="filters" aria-selected="false">
                <i class="bi bi-funnel me-2"></i>フィルター
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab" aria-controls="schedule" aria-selected="false">
                <i class="bi bi-clock me-2"></i>スケジュール
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab" aria-controls="notifications" aria-selected="false">
                <i class="bi bi-bell me-2"></i>通知設定
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">
                <i class="bi bi-gear me-2"></i>詳細設定
            </button>
        </li>
    </ul>

    <!-- ========== タブコンテンツ ========== -->
    <div class="tab-content settings-tab-content" id="settingsTabContent">

        <!-- ========== 1. 収集ソース設定タブ ========== -->
        <div class="tab-pane fade show active" id="sources" role="tabpanel" aria-labelledby="sources-tab">
            <div class="container-fluid px-4">
                <!-- API収集ソース -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="flex-grow-1">
                            <h4 class="form-section-title">
                                <i class="bi bi-code-square text-primary"></i> API収集ソース
                            </h4>
                            <p class="text-muted mb-2">外部APIからアニメ・マンガの最新情報を自動収集します</p>
                            <!-- API統計サマリー -->
                            <div class="alert alert-info py-2 px-3 mb-0" id="apiStatsSummary">
                                <div class="row g-2 small">
                                    <div class="col-auto">
                                        <i class="bi bi-collection text-primary"></i>
                                        <strong>総取得数:</strong> <span id="api-total-items">{{ stats.api.total_items }}件</span>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-percent text-success"></i>
                                        <strong>平均成功率:</strong> <span id="api-avg-success">{{ stats.api.avg_success_rate }}%</span>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-speedometer2 text-warning"></i>
                                        <strong>平均レスポンス:</strong> <span id="api-avg-response">{{ stats.api.avg_response_time }}s</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-3">
                            <button class="btn btn-outline-primary" id="refreshAllApiStatsBtn" title="API統計を更新">
                                <i class="bi bi-arrow-clockwise"></i> 統計更新
                            </button>
                            <button class="btn btn-outline-secondary" id="testAllApisBtn" title="すべてのAPIをテスト">
                                <i class="bi bi-wifi"></i> すべてテスト
                            </button>
                        </div>
                    </div>
                    <div class="row" id="apiSourcesContainer">
                        <!-- API sources will be dynamically loaded here by JavaScript -->
                    </div>
                </div>

                <hr class="section-divider light">

                <!-- RSS収集ソース -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="flex-grow-1">
                            <h4 class="form-section-title">
                                <i class="bi bi-rss text-warning"></i> RSS収集ソース
                            </h4>
                            <p class="text-muted mb-2">RSSフィードからマンガ・アニメの最新情報を定期取得します</p>
                            <!-- RSS統計サマリー -->
                            <div class="alert alert-warning py-2 px-3 mb-0" id="rssStatsSummary">
                                <div class="row g-2 small">
                                    <div class="col-auto">
                                        <i class="bi bi-collection text-primary"></i>
                                        <strong>総取得数:</strong> <span id="rss-total-items">{{ stats.rss.total_items }}件</span>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-percent text-success"></i>
                                        <strong>平均成功率:</strong> <span id="rss-avg-success">{{ stats.rss.avg_success_rate }}%</span>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-speedometer2 text-warning"></i>
                                        <strong>平均レスポンス:</strong> <span id="rss-avg-response">{{ stats.rss.avg_response_time }}s</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-3">
                            <button class="btn btn-outline-warning" id="refreshAllRssStatsBtn" title="RSS統計を更新">
                                <i class="bi bi-arrow-clockwise"></i> 統計更新
                            </button>
                            <button class="btn btn-outline-secondary" id="testAllRssBtn" title="すべてのRSSをテスト">
                                <i class="bi bi-wifi"></i> すべてテスト
                            </button>
                        </div>
                    </div>
                    <div class="row" id="rssSourcesContainer">
                        <!-- RSSフィードはJavaScriptで動的に生成されます -->
                    </div>

                    <!-- カスタムRSSフィード追加 -->
                    <div class="row mt-3">
                        <div class="col-12 col-xl-6">
                            <div class="settings-card source-config-card disabled">
                                <div class="card-header">
                                    <div>
                                        <h5 class="mb-0">カスタムRSSフィード</h5>
                                        <p class="card-subtitle">独自のRSSソースを追加できます</p>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="connection-status disconnected">
                                            <i class="bi bi-dash-circle"></i> 無効
                                        </span>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="customRssEnabled">
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            RSS URLs
                                            <span class="label-description">1行につき1つのURLを入力してください</span>
                                        </label>
                                        <textarea class="form-control" rows="4" placeholder="https://example1.com/rss&#10;https://example2.com/feed&#10;https://example3.com/updates.xml"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            更新間隔
                                            <span class="label-description">データ取得の頻度を指定します</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" value="60" min="15" max="1440">
                                            <span class="input-group-text">分</span>
                                        </div>
                                    </div>
                                    <div class="button-group">
                                        <button class="btn btn-primary" id="addCustomRss">
                                            <i class="bi bi-plus-lg"></i> RSS追加
                                        </button>
                                        <button class="btn btn-outline-primary test-connection-btn">
                                            <i class="bi bi-wifi"></i> 接続テスト
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== 2. フィルター設定タブ ========== -->
        <div class="tab-pane fade" id="filters" role="tabpanel" aria-labelledby="filters-tab">
            <div class="container-fluid px-4">
                <div class="row">
                    <!-- フィルター設定パネル -->
                    <div class="col-12 col-xl-8">
                        <!-- NGワード設定 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <div>
                                    <h5 class="mb-0">NGワード設定</h5>
                                    <p class="card-subtitle">タイトル・説明に含まれる作品を除外します</p>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-4">
                                    <label class="form-label">
                                        NGワードを追加
                                        <span class="label-description">除外したいキーワードを入力してください</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="newNgKeyword" placeholder="例: R18, BL, エロ">
                                        <button class="btn btn-outline-primary" id="addNgKeyword">
                                            <i class="bi bi-plus-lg"></i> 追加
                                        </button>
                                    </div>
                                </div>

                                <div class="form-group mb-4">
                                    <label class="form-label">
                                        現在のNGワード
                                        <span class="label-description">クリックで削除できます</span>
                                    </label>
                                    <div class="border rounded p-3" id="ngKeywordsList" style="min-height: 120px; background: white;">
                                        <div class="keyword-tag">
                                            エロ <span class="remove-keyword" onclick="removeKeyword(this)">&times;</span>
                                        </div>
                                        <div class="keyword-tag">
                                            R18 <span class="remove-keyword" onclick="removeKeyword(this)">&times;</span>
                                        </div>
                                        <div class="keyword-tag">
                                            成人向け <span class="remove-keyword" onclick="removeKeyword(this)">&times;</span>
                                        </div>
                                        <div class="keyword-tag">
                                            BL <span class="remove-keyword" onclick="removeKeyword(this)">&times;</span>
                                        </div>
                                        <div class="keyword-tag">
                                            百合 <span class="remove-keyword" onclick="removeKeyword(this)">&times;</span>
                                        </div>
                                        <div class="keyword-tag">
                                            ボーイズラブ <span class="remove-keyword" onclick="removeKeyword(this)">&times;</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        フィルター強度
                                        <span class="label-description">除外の厳しさを設定します</span>
                                    </label>
                                    <select class="form-select">
                                        <option value="strict" selected>厳格（部分一致も除外）</option>
                                        <option value="normal">標準（完全一致のみ除外）</option>
                                        <option value="loose">緩い（明確なマッチのみ除外）</option>
                                    </select>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableWhitelist">
                                    <label class="form-check-label" for="enableWhitelist">
                                        ホワイトリスト機能を有効にする（指定キーワドを含む作品のみを収集）
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- プリセット設定 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">クイック設定プリセット</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">よく使う設定をワンクリックで適用できます</p>
                                <div class="button-group">
                                    <button class="btn btn-outline-secondary flex-fill" onclick="loadPreset('family')">
                                        <i class="bi bi-house"></i> ファミリー向け
                                    </button>
                                    <button class="btn btn-outline-secondary flex-fill" onclick="loadPreset('general')">
                                        <i class="bi bi-people"></i> 一般向け
                                    </button>
                                    <button class="btn btn-outline-secondary flex-fill" onclick="loadPreset('all')">
                                        <i class="bi bi-globe"></i> 制限なし
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- フィルター統計パネル -->
                    <div class="col-12 col-xl-4">
                        <!-- 統計カード -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">フィルター統計</h5>
                            </div>
                            <div class="card-body">
                                <div class="stats-grid">
                                    <div class="stats-card">
                                        <div class="stats-value text-success">2,341</div>
                                        <div class="stats-label">許可された作品</div>
                                    </div>
                                    <div class="stats-card">
                                        <div class="stats-value text-danger">147</div>
                                        <div class="stats-label">除外された作品</div>
                                    </div>
                                </div>

                                <hr class="section-divider light">

                                <h6 class="mb-3">よく除外されるキーワード</h6>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">R18</small>
                                        <small class="text-muted">67件</small>
                                    </div>
                                    <div class="progress" style="height: 1.5rem;">
                                        <div class="progress-bar bg-danger" style="width: 45%"></div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">BL</small>
                                        <small class="text-muted">44件</small>
                                    </div>
                                    <div class="progress" style="height: 1.5rem;">
                                        <div class="progress-bar bg-warning" style="width: 30%"></div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">成人向け</small>
                                        <small class="text-muted">28件</small>
                                    </div>
                                    <div class="progress" style="height: 1.5rem;">
                                        <div class="progress-bar bg-info" style="width: 20%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- フィルター情報 -->
                        <div class="info-box">
                            <i class="bi bi-info-circle"></i>
                            <strong>ヒント:</strong> フィルター設定は即座に反映され、次回の収集から適用されます
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== 3. スケジュール設定タブ ========== -->
        <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
            <div class="container-fluid px-4">
                <div class="row">
                    <!-- スケジュール設定パネル -->
                    <div class="col-12 col-xl-8">
                        <div class="settings-card">
                            <div class="card-header">
                                <div>
                                    <h5 class="mb-0">収集スケジュール</h5>
                                    <p class="card-subtitle">定期実行タスクの時間と頻度を設定します</p>
                                </div>
                                <button class="btn btn-primary btn-sm" id="addScheduleBtn">
                                    <i class="bi bi-plus-lg"></i> スケジュール追加
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="scheduleList">
                                    <!-- 定期収集スケジュール -->
                                    <div class="schedule-item active">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" checked id="schedule1">
                                        </div>
                                        <div class="schedule-icon">
                                            <i class="bi bi-clock text-primary"></i>
                                        </div>
                                        <div class="schedule-info">
                                            <div class="schedule-name">毎日定期収集</div>
                                            <div class="schedule-desc">毎日 08:00 に全ソースからアニメ・マンガ情報を収集</div>
                                        </div>
                                        <div class="schedule-controls">
                                            <select class="form-select form-select-sm" style="width: 120px;">
                                                <option value="0">00:00</option>
                                                <option value="6">06:00</option>
                                                <option value="8" selected>08:00</option>
                                                <option value="12">12:00</option>
                                                <option value="18">18:00</option>
                                                <option value="21">21:00</option>
                                            </select>
                                            <button class="btn btn-outline-secondary btn-sm" title="設定">
                                                <i class="bi bi-gear"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" title="削除">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 週次まとめ収集 -->
                                    <div class="schedule-item">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" checked id="schedule2">
                                        </div>
                                        <div class="schedule-icon">
                                            <i class="bi bi-calendar-week text-success"></i>
                                        </div>
                                        <div class="schedule-info">
                                            <div class="schedule-name">週次まとめ収集</div>
                                            <div class="schedule-desc">毎週日曜日 23:00 に週次データの整理と通知</div>
                                        </div>
                                        <div class="schedule-controls">
                                            <select class="form-select form-select-sm" style="width: 130px;">
                                                <option value="sunday" selected>日曜日</option>
                                                <option value="monday">月曜日</option>
                                                <option value="tuesday">火曜日</option>
                                                <option value="wednesday">水曜日</option>
                                                <option value="thursday">木曜日</option>
                                                <option value="friday">金曜日</option>
                                                <option value="saturday">土曜日</option>
                                            </select>
                                            <button class="btn btn-outline-secondary btn-sm" title="設定">
                                                <i class="bi bi-gear"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" title="削除">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 緊急更新チェック -->
                                    <div class="schedule-item">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="schedule3">
                                        </div>
                                        <div class="schedule-icon">
                                            <i class="bi bi-lightning text-warning"></i>
                                        </div>
                                        <div class="schedule-info">
                                            <div class="schedule-name">緊急更新チェック</div>
                                            <div class="schedule-desc">重要な更新をリアルタイムで検出（現在無効）</div>
                                        </div>
                                        <div class="schedule-controls">
                                            <select class="form-select form-select-sm" style="width: 120px;">
                                                <option value="15">15分ごと</option>
                                                <option value="30">30分ごと</option>
                                                <option value="60" selected>60分ごと</option>
                                            </select>
                                            <button class="btn btn-outline-secondary btn-sm" title="設定">
                                                <i class="bi bi-gear"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" title="削除">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="warning-box mt-3">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>注意:</strong> スケジュール変更後は、システムの再起動が必要です。
                                </div>
                            </div>
                        </div>

                        <!-- 手動実行 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">手動実行</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">スケジュールを待たず、すぐに実行できます</p>
                                <div class="button-group">
                                    <button class="btn btn-outline-primary" onclick="runCollectionNow()">
                                        <i class="bi bi-play-circle"></i> 今すぐ収集実行
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="testSchedule()">
                                        <i class="bi bi-check-circle"></i> スケジュールテスト
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 次回実行予定・実行履歴パネル -->
                    <div class="col-12 col-xl-4">
                        <!-- 次回実行予定 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">次回実行予定</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <small class="text-muted">毎日定期収集</small>
                                        </div>
                                        <div>
                                            <strong class="text-primary">明日 08:00</strong>
                                        </div>
                                    </div>
                                    <div class="progress" style="height: 1rem;">
                                        <div class="progress-bar bg-primary" style="width: 65%"></div>
                                    </div>
                                    <small class="text-muted">あと16時間20分</small>
                                </div>

                                <hr class="section-divider light">

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <small class="text-muted">週次まとめ収集</small>
                                        </div>
                                        <div>
                                            <strong class="text-success">日曜日 23:00</strong>
                                        </div>
                                    </div>
                                    <div class="progress" style="height: 1rem;">
                                        <div class="progress-bar bg-success" style="width: 30%"></div>
                                    </div>
                                    <small class="text-muted">あと4日15時間</small>
                                </div>
                            </div>
                        </div>

                        <!-- 実行履歴 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">最近の実行履歴</h5>
                            </div>
                            <div class="card-body">
                                <div class="timeline">
                                    <div class="timeline-item">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        <div class="timeline-content">
                                            <div class="timeline-time">今日 08:00</div>
                                            <div class="timeline-desc">定期収集完了（127件取得）</div>
                                        </div>
                                    </div>

                                    <div class="timeline-item">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        <div class="timeline-content">
                                            <div class="timeline-time">昨日 23:00</div>
                                            <div class="timeline-desc">週次まとめ完了</div>
                                        </div>
                                    </div>

                                    <div class="timeline-item">
                                        <i class="bi bi-exclamation-circle-fill text-warning"></i>
                                        <div class="timeline-content">
                                            <div class="timeline-time">昨日 08:00</div>
                                            <div class="timeline-desc">部分的な収集（警告あり）</div>
                                        </div>
                                    </div>

                                    <div class="timeline-item">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        <div class="timeline-content">
                                            <div class="timeline-time">3日前 08:00</div>
                                            <div class="timeline-desc">定期収集完了（89件取得）</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="section-divider my-4">

                <!-- リリースカレンダー同期セクション -->
                <div class="row">
                    <div class="col-12 col-xl-8">
                        <div class="settings-card">
                            <div class="card-header">
                                <div>
                                    <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>リリースカレンダー同期</h5>
                                    <p class="card-subtitle">3ヶ月先までのリリース情報をカレンダーイベントに自動同期します</p>
                                </div>
                                <button class="btn btn-primary btn-sm" id="syncCalendarBtn">
                                    <i class="bi bi-arrow-repeat"></i> 今すぐ同期
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- 同期設定 -->
                                <div class="mb-4">
                                    <label for="monthsAheadSelect" class="form-label">同期期間</label>
                                    <select class="form-select" id="monthsAheadSelect">
                                        <option value="1">1ヶ月先まで</option>
                                        <option value="2">2ヶ月先まで</option>
                                        <option value="3" selected>3ヶ月先まで</option>
                                        <option value="4">4ヶ月先まで</option>
                                        <option value="6">6ヶ月先まで</option>
                                    </select>
                                    <small class="text-muted">指定期間内のリリース情報をカレンダーに登録します</small>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="forceResyncCheck">
                                        <label class="form-check-label" for="forceResyncCheck">
                                            既存イベントも強制更新
                                        </label>
                                    </div>
                                    <small class="text-muted">チェックを入れると、既に登録済みのイベントも最新情報で上書きします</small>
                                </div>

                                <!-- 同期結果表示エリア -->
                                <div id="calendarSyncResult" class="mt-3" style="display: none;">
                                    <!-- JavaScript で動的に更新 -->
                                </div>

                                <!-- 自動同期スケジュール -->
                                <hr class="section-divider my-3">
                                <div class="schedule-item">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoCalendarSyncCheck" checked>
                                        <label class="form-check-label" for="autoCalendarSyncCheck">
                                            <div class="schedule-name">自動カレンダー同期</div>
                                            <div class="schedule-desc">毎月1日にリリースカレンダーを自動更新</div>
                                        </label>
                                    </div>
                                    <div class="ms-auto d-flex align-items-center gap-2">
                                        <select class="form-select form-select-sm" style="width: auto;">
                                            <option value="1" selected>毎月1日</option>
                                            <option value="15">毎月15日</option>
                                            <option value="0">月末</option>
                                        </select>
                                        <button class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-gear"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- カレンダー統計パネル -->
                    <div class="col-12 col-xl-4">
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">カレンダー統計</h5>
                            </div>
                            <div class="card-body">
                                <div id="calendarStatsContainer">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">読み込み中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 最近の同期履歴 -->
                        <div class="settings-card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0">同期履歴</h5>
                            </div>
                            <div class="card-body">
                                <div id="calendarSyncHistory">
                                    <p class="text-muted small mb-0">まだ同期が実行されていません</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="section-divider my-4">

                <!-- 3ヶ月カレンダー表示セクション -->
                <div class="row">
                    <div class="col-12">
                        <div class="settings-card">
                            <div class="card-header">
                                <div>
                                    <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>リリースカレンダー（3ヶ月表示）</h5>
                                    <p class="card-subtitle">今月から3ヶ月先までのリリース予定を表示します</p>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" id="refreshCalendarBtn">
                                    <i class="bi bi-arrow-clockwise"></i> 更新
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="threeMonthCalendar">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">読み込み中...</span>
                                        </div>
                                        <p class="text-muted mt-3">カレンダーを読み込んでいます...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== 4. 通知設定タブ ========== -->
        <div class="tab-pane fade" id="notifications" role="tabpanel" aria-labelledby="notifications-tab">
            <div class="container-fluid px-4">
                <!-- 実行状況セクション -->
                <div class="form-section">
                    <h4 class="form-section-title mb-3">
                        <i class="bi bi-activity"></i> 実行状況
                    </h4>
                    <div class="row">
                        <div class="col-lg-6">
                            <!-- メール通知ステータス -->
                            <div id="notification-status-container"></div>
                        </div>
                        <div class="col-lg-6">
                            <!-- カレンダー連携ステータス -->
                            <div id="calendar-status-container"></div>
                        </div>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- 通知設定セクション -->
                <div class="row">
                    <div class="col-12 col-xl-8">
                        <!-- メール通知設定 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <div>
                                    <h5 class="mb-0">メール通知</h5>
                                    <p class="card-subtitle">新作情報をメールで受け取ります</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="emailNotifyEnabled" checked>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        送信先メールアドレス
                                        <span class="label-description">Google アカウントで認証済みです</span>
                                    </label>
                                    <input type="email" class="form-control" value="user@example.com" readonly>
                                    <small class="form-text text-muted">メールアドレスを変更するには、設定を再認証してください</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        通知頻度
                                        <span class="label-description">メール送信のタイミングを選択します</span>
                                    </label>
                                    <select class="form-select">
                                        <option value="instant">リアルタイム（新作時にすぐ送信）</option>
                                        <option value="daily" selected>毎日まとめ（毎朝8:00に一度に送信）</option>
                                        <option value="weekly">毎週まとめ（日曜23:00に一度に送信）</option>
                                        <option value="disabled">通知しない</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        メール形式
                                        <span class="label-description">メール本文のレイアウトを選択します</span>
                                    </label>
                                    <select class="form-select">
                                        <option value="html" selected>HTML（画像・リンク付き、見やすい）</option>
                                        <option value="text">テキスト（シンプル、軽量）</option>
                                    </select>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="includeImages" checked>
                                    <label class="form-check-label" for="includeImages">
                                        作品画像を含める（メール容量が増加します）
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Google Calendar連携 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <div>
                                    <h5 class="mb-0">Google Calendar連携</h5>
                                    <p class="card-subtitle">新作情報をカレンダーに自動登録</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="calendarIntegrationEnabled" checked>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        対象カレンダー
                                        <span class="label-description">イベントが追加されるカレンダーを選択</span>
                                    </label>
                                    <select class="form-select">
                                        <option value="primary" selected>メインカレンダー（primary）</option>
                                        <option value="anime">アニメ専用カレンダー</option>
                                        <option value="manga">マンガ専用カレンダー</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        通知時間
                                        <span class="label-description">配信日の何時間前に通知するか</span>
                                    </label>
                                    <select class="form-select">
                                        <option value="1440">1日前</option>
                                        <option value="480" selected>8時間前</option>
                                        <option value="120">2時間前</option>
                                        <option value="60">1時間前</option>
                                        <option value="0">通知しない</option>
                                    </select>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="googleNotification" checked>
                                    <label class="form-check-label" for="googleNotification">
                                        Google Calendar の通知も有効にする
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 通知プレビュー・設定パネル -->
                    <div class="col-12 col-xl-4">
                        <!-- 通知プレビュー -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">メール通知プレビュー</h5>
                            </div>
                            <div class="card-body">
                                <div class="border rounded p-3" style="background: #f8f9fa; max-height: 400px; overflow-y: auto;">
                                    <div style="background: white; padding: 1rem; border-radius: 0.25rem;">
                                        <h6 class="mb-2">新作アニメ・マンガ情報</h6>
                                        <small class="text-muted">配信日: 2024-11-15</small>
                                        <hr class="my-2">
                                        <div class="small">
                                            <p class="mb-2"><strong>作品タイトル</strong></p>
                                            <p class="mb-2">第3話配信予定</p>
                                            <p class="text-primary"><a href="#">詳細を見る</a></p>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-2">これはプレビューです。実際のメール形式とは異なる場合があります。</small>
                            </div>
                        </div>

                        <!-- テスト送信 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">テスト送信</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">現在の設定でテストメールを送信します</p>
                                <button class="btn btn-outline-primary w-100" onclick="sendTestEmail()">
                                    <i class="bi bi-envelope"></i> テストメール送信
                                </button>
                            </div>
                        </div>

                        <!-- 認証情報 -->
                        <div class="success-box">
                            <i class="bi bi-check-circle"></i>
                            <strong>認証済み:</strong> Google アカウント認証が完了しています
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== 5. 詳細設定タブ ========== -->
        <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
            <div class="container-fluid px-4">
                <div class="row">
                    <div class="col-12 col-xl-8">
                        <!-- データベース設定 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">データベース設定</h5>
                            </div>
                            <div class="card-body">
                                <div class="info-box">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>情報:</strong> SQLite3 データベースファイル: db.sqlite3
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        自動クリーンアップ
                                        <span class="label-description">古いレコードを自動削除します</span>
                                    </label>
                                    <select class="form-select">
                                        <option value="7days">7日以上前のデータを削除</option>
                                        <option value="30days" selected>30日以上前のデータを削除</option>
                                        <option value="90days">90日以上前のデータを削除</option>
                                        <option value="disabled">無効</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        クリーンアップ実行時刻
                                        <span class="label-description">毎日自動実行される時刻</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="time" class="form-control" value="02:00">
                                    </div>
                                </div>

                                <div class="button-group">
                                    <button class="btn btn-outline-primary" onclick="backupDatabase()">
                                        <i class="bi bi-cloud-download"></i> バックアップ
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="cleanupNow()">
                                        <i class="bi bi-trash"></i> 今すぐクリーンアップ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ログ設定 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">ログ設定</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        ログレベル
                                        <span class="label-description">記録する情報の詳細度</span>
                                    </label>
                                    <select class="form-select">
                                        <option value="debug">DEBUG（詳細）</option>
                                        <option value="info" selected>INFO（標準）</option>
                                        <option value="warning">WARNING（警告のみ）</option>
                                        <option value="error">ERROR（エラーのみ）</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        ログ保持期間
                                        <span class="label-description">ログファイルを保持する日数</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" value="30" min="1" max="365">
                                        <span class="input-group-text">日</span>
                                    </div>
                                </div>

                                <div class="button-group">
                                    <button class="btn btn-outline-secondary" onclick="viewLogs()">
                                        <i class="bi bi-file-text"></i> ログ表示
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="clearLogs()">
                                        <i class="bi bi-trash"></i> ログクリア
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- API設定 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">API設定</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        接続タイムアウト
                                        <span class="label-description">API接続の最大待機時間</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" value="30" min="5" max="120">
                                        <span class="input-group-text">秒</span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        リトライ回数
                                        <span class="label-description">失敗時の再試行回数</span>
                                    </label>
                                    <input type="number" class="form-control" value="3" min="0" max="10">
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableProxy">
                                    <label class="form-check-label" for="enableProxy">
                                        プロキシ設定を使用する
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- パフォーマンス設定 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">パフォーマンス設定</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">
                                        並列処理スレッド数
                                        <span class="label-description">同時に処理するタスク数</span>
                                    </label>
                                    <select class="form-select">
                                        <option value="1">1（シングル）</option>
                                        <option value="2">2</option>
                                        <option value="4" selected>4</option>
                                        <option value="8">8</option>
                                        <option value="16">16</option>
                                    </select>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableCache" checked>
                                    <label class="form-check-label" for="enableCache">
                                        キャッシュを有効にする（取得結果をキャッシュ）
                                    </label>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        キャッシュ有効期限
                                        <span class="label-description">キャッシュ保持時間</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" value="3600" min="300" max="86400">
                                        <span class="input-group-text">秒</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- システム情報・設定管理パネル -->
                    <div class="col-12 col-xl-4">
                        <!-- システム情報 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">システム情報</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">バージョン</small>
                                    <div class="small font-weight-bold">1.2.0</div>
                                </div>
                                <hr class="section-divider light">
                                <div class="mb-2">
                                    <small class="text-muted">最終更新</small>
                                    <div class="small font-weight-bold">2024-11-15 08:00:00</div>
                                </div>
                                <hr class="section-divider light">
                                <div class="mb-2">
                                    <small class="text-muted">ステータス</small>
                                    <div class="small">
                                        <span class="badge-status active">稼働中</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 設定バックアップ・復元 -->
                        <div class="settings-card">
                            <div class="card-header">
                                <h5 class="mb-0">設定管理</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">設定を保存・復元できます</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="exportSettings()">
                                        <i class="bi bi-download"></i> 設定エクスポート
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="importSettings()">
                                        <i class="bi bi-upload"></i> 設定インポート
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="resetSettings()">
                                        <i class="bi bi-arrow-clockwise"></i> リセット
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 危険な操作 -->
                        <div class="warning-box mt-4">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>警告:</strong> 以下の操作は取り消せません。慎重に実行してください。
                        </div>

                        <div class="settings-card">
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-danger btn-sm" onclick="resetAllData()">
                                        <i class="bi bi-x-circle"></i> すべてのデータを削除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// フィルター設定
function removeKeyword(el) {
    el.closest('.keyword-tag').remove();
}

function loadPreset(preset) {
    console.log('Loading preset:', preset);
    // プリセット読み込みロジック
}

function customizeFilter() {
    console.log('Customizing filter');
}

// スケジュール管理
function runCollectionNow() {
    console.log('Running collection now');
}

function testSchedule() {
    console.log('Testing schedule');
}

// 通知設定
function sendTestEmail() {
    console.log('Sending test email');
}

// 詳細設定
function backupDatabase() {
    console.log('Backing up database');
}

function cleanupNow() {
    console.log('Running cleanup');
}

function viewLogs() {
    console.log('Viewing logs');
}

function clearLogs() {
    console.log('Clearing logs');
}

function exportSettings() {
    console.log('Exporting settings');
}

function importSettings() {
    console.log('Importing settings');
}

function resetSettings() {
    console.log('Resetting settings');
}

function resetAllData() {
    if (confirm('本当にすべてのデータを削除しますか？この操作は取り消せません。')) {
        console.log('Resetting all data');
    }
}

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    console.log('Settings page loaded');
    initializeScheduleHandlers();
});

// スケジュール管理イベントハンドラ
function initializeScheduleHandlers() {
    // 設定ボタン（歯車アイコン）のイベント
    document.querySelectorAll('#scheduleList .btn-outline-secondary').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const scheduleItem = this.closest('.schedule-item');
            const scheduleName = scheduleItem.querySelector('.schedule-name').textContent;
            const scheduleDesc = scheduleItem.querySelector('.schedule-desc').textContent;
            const scheduleId = scheduleItem.querySelector('.form-check-input').id;

            // スケジュール設定モーダルを表示
            showScheduleSettingsModal(scheduleId, scheduleName, scheduleDesc, scheduleItem);
        });
    });

    // 削除ボタン（ゴミ箱アイコン）のイベント
    document.querySelectorAll('#scheduleList .btn-outline-danger').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const scheduleItem = this.closest('.schedule-item');
            const scheduleName = scheduleItem.querySelector('.schedule-name').textContent;

            if (confirm(`「${scheduleName}」を削除してもよろしいですか？\n\nこの操作は取り消せません。`)) {
                // アニメーション付きで削除
                scheduleItem.style.transition = 'opacity 0.3s, transform 0.3s';
                scheduleItem.style.opacity = '0';
                scheduleItem.style.transform = 'translateX(-20px)';

                setTimeout(() => {
                    scheduleItem.remove();
                    showNotification('success', `「${scheduleName}」を削除しました`);
                }, 300);
            }
        });
    });

    // スケジュール追加ボタン
    document.getElementById('addScheduleBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        alert('新規スケジュール追加\n\n現在この機能は開発中です。\n以下のスケジュールタイプを追加できるようになります：\n- 毎日実行\n- 毎週実行\n- 毎月実行\n- カスタム間隔');
    });

    // トグルスイッチの変更イベント
    document.querySelectorAll('#scheduleList .form-check-input').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const scheduleItem = this.closest('.schedule-item');
            const scheduleName = scheduleItem.querySelector('.schedule-name').textContent;

            if (this.checked) {
                scheduleItem.classList.add('active');
                showNotification('success', `「${scheduleName}」を有効化しました`);
            } else {
                scheduleItem.classList.remove('active');
                showNotification('info', `「${scheduleName}」を無効化しました`);
            }
        });
    });
}

// 通知表示関数
function showNotification(type, message) {
    // Bootstrap Toastまたはシンプルなアラートで通知
    const alertClass = type === 'success' ? 'alert-success' :
                      type === 'error' ? 'alert-danger' : 'alert-info';

    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 150);
    }, 3000);
}

// スケジュール設定モーダルを表示
function showScheduleSettingsModal(scheduleId, scheduleName, scheduleDesc, scheduleItem) {
    // 既存のモーダルを削除
    const existingModal = document.getElementById('scheduleSettingsModal');
    if (existingModal) {
        existingModal.remove();
    }

    // 現在の設定値を取得
    const timeSelect = scheduleItem.querySelector('.form-select');
    const currentValue = timeSelect ? timeSelect.value : '8';
    const isEnabled = scheduleItem.querySelector('.form-check-input').checked;

    // モーダルHTML作成
    const modalHTML = `
        <div class="modal fade" id="scheduleSettingsModal" tabindex="-1" aria-labelledby="scheduleSettingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="scheduleSettingsModalLabel">
                            <i class="bi bi-gear"></i> スケジュール設定：${scheduleName}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="scheduleSettingsForm">
                            <div class="mb-3">
                                <label for="scheduleName" class="form-label">スケジュール名</label>
                                <input type="text" class="form-control" id="scheduleName" value="${scheduleName}">
                            </div>

                            <div class="mb-3">
                                <label for="scheduleDescription" class="form-label">説明</label>
                                <textarea class="form-control" id="scheduleDescription" rows="2">${scheduleDesc}</textarea>
                            </div>

                            <div class="mb-3">
                                <label for="scheduleTime" class="form-label">実行時刻</label>
                                <select class="form-select" id="scheduleTime">
                                    <option value="0" ${currentValue === '0' ? 'selected' : ''}>00:00</option>
                                    <option value="1" ${currentValue === '1' ? 'selected' : ''}>01:00</option>
                                    <option value="2" ${currentValue === '2' ? 'selected' : ''}>02:00</option>
                                    <option value="3" ${currentValue === '3' ? 'selected' : ''}>03:00</option>
                                    <option value="4" ${currentValue === '4' ? 'selected' : ''}>04:00</option>
                                    <option value="5" ${currentValue === '5' ? 'selected' : ''}>05:00</option>
                                    <option value="6" ${currentValue === '6' ? 'selected' : ''}>06:00</option>
                                    <option value="7" ${currentValue === '7' ? 'selected' : ''}>07:00</option>
                                    <option value="8" ${currentValue === '8' ? 'selected' : ''}>08:00</option>
                                    <option value="9" ${currentValue === '9' ? 'selected' : ''}>09:00</option>
                                    <option value="10" ${currentValue === '10' ? 'selected' : ''}>10:00</option>
                                    <option value="11" ${currentValue === '11' ? 'selected' : ''}>11:00</option>
                                    <option value="12" ${currentValue === '12' ? 'selected' : ''}>12:00</option>
                                    <option value="13" ${currentValue === '13' ? 'selected' : ''}>13:00</option>
                                    <option value="14" ${currentValue === '14' ? 'selected' : ''}>14:00</option>
                                    <option value="15" ${currentValue === '15' ? 'selected' : ''}>15:00</option>
                                    <option value="16" ${currentValue === '16' ? 'selected' : ''}>16:00</option>
                                    <option value="17" ${currentValue === '17' ? 'selected' : ''}>17:00</option>
                                    <option value="18" ${currentValue === '18' ? 'selected' : ''}>18:00</option>
                                    <option value="19" ${currentValue === '19' ? 'selected' : ''}>19:00</option>
                                    <option value="20" ${currentValue === '20' ? 'selected' : ''}>20:00</option>
                                    <option value="21" ${currentValue === '21' ? 'selected' : ''}>21:00</option>
                                    <option value="22" ${currentValue === '22' ? 'selected' : ''}>22:00</option>
                                    <option value="23" ${currentValue === '23' ? 'selected' : ''}>23:00</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="schedulePriority" class="form-label">優先度</label>
                                <select class="form-select" id="schedulePriority">
                                    <option value="low">低</option>
                                    <option value="normal" selected>標準</option>
                                    <option value="high">高</option>
                                    <option value="critical">緊急</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableNotification" checked>
                                    <label class="form-check-label" for="enableNotification">
                                        実行完了時に通知を送信
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableRetry" checked>
                                    <label class="form-check-label" for="enableRetry">
                                        失敗時に自動リトライ
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3" id="retryOptions">
                                <label for="retryCount" class="form-label">リトライ回数</label>
                                <input type="number" class="form-control" id="retryCount" value="3" min="1" max="10">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                        <button type="button" class="btn btn-primary" id="saveScheduleSettings">保存</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // モーダルをDOMに追加
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Bootstrapモーダル初期化
    const modal = new bootstrap.Modal(document.getElementById('scheduleSettingsModal'));
    modal.show();

    // リトライオプションの表示/非表示
    document.getElementById('enableRetry').addEventListener('change', function() {
        document.getElementById('retryOptions').style.display = this.checked ? 'block' : 'none';
    });

    // 保存ボタンのイベント
    document.getElementById('saveScheduleSettings').addEventListener('click', function() {
        const newName = document.getElementById('scheduleName').value;
        const newDesc = document.getElementById('scheduleDescription').value;
        const newTime = document.getElementById('scheduleTime').value;

        // スケジュールアイテムを更新
        scheduleItem.querySelector('.schedule-name').textContent = newName;
        scheduleItem.querySelector('.schedule-desc').textContent = newDesc;

        const timeSelect = scheduleItem.querySelector('.form-select');
        if (timeSelect) {
            timeSelect.value = newTime;
            // 時刻表示を更新（表示テキストがあれば）
            const selectedOption = timeSelect.querySelector(`option[value="${newTime}"]`);
            if (selectedOption) {
                timeSelect.dispatchEvent(new Event('change'));
            }
        }

        modal.hide();
        showNotification('success', `「${newName}」の設定を保存しました`);
    });

    // モーダルが閉じられたら削除
    document.getElementById('scheduleSettingsModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// ========== カレンダー同期機能 ==========

// ページロード時にカレンダー統計と3ヶ月カレンダーを取得
document.addEventListener('DOMContentLoaded', function() {
    loadCalendarStats();
    loadThreeMonthCalendar();
});

// カレンダー統計を読み込む
async function loadCalendarStats() {
    try {
        const response = await fetch('/api/calendar/stats');
        const data = await response.json();

        if (data.success && data.stats) {
            const stats = data.stats;
            const container = document.getElementById('calendarStatsContainer');

            container.innerHTML = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">総イベント数</small>
                        <strong class="text-primary">${stats.total_events}件</strong>
                    </div>
                    <div class="progress" style="height: 0.5rem;">
                        <div class="progress-bar bg-primary" style="width: 100%"></div>
                    </div>
                </div>

                <hr class="my-2">

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">今月</small>
                        <span class="badge bg-info">${stats.events_this_month}件</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">来月</small>
                        <span class="badge bg-success">${stats.events_next_month}件</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">7日以内</small>
                        <span class="badge bg-warning">${stats.upcoming_7days}件</span>
                    </div>
                </div>

                <hr class="my-2">

                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">同期済み / 全リリース</small>
                    <strong>${stats.synced_releases} / ${stats.total_releases}</strong>
                </div>
                <div class="progress mt-2" style="height: 0.5rem;">
                    <div class="progress-bar bg-success"
                         style="width: ${stats.total_releases > 0 ? (stats.synced_releases / stats.total_releases * 100) : 0}%"></div>
                </div>
            `;
        }
    } catch (error) {
        console.error('カレンダー統計の取得に失敗:', error);
        document.getElementById('calendarStatsContainer').innerHTML = `
            <div class="alert alert-warning small mb-0">
                <i class="bi bi-exclamation-triangle"></i> 統計の取得に失敗しました
            </div>
        `;
    }
}

// カレンダー同期ボタンのイベント
document.getElementById('syncCalendarBtn')?.addEventListener('click', async function(e) {
    e.preventDefault();

    const btn = this;
    const originalHTML = btn.innerHTML;

    // ボタンを無効化してローディング表示
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>同期中...';

    try {
        const monthsAhead = parseInt(document.getElementById('monthsAheadSelect').value);
        const forceResync = document.getElementById('forceResyncCheck').checked;

        const response = await fetch('/api/calendar/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                months_ahead: monthsAhead,
                force_resync: forceResync
            })
        });

        const data = await response.json();

        if (data.success) {
            // 成功時の表示
            const resultContainer = document.getElementById('calendarSyncResult');
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = `
                <div class="alert alert-success">
                    <h6 class="alert-heading mb-2">
                        <i class="bi bi-check-circle"></i> カレンダー同期が完了しました
                    </h6>
                    <div class="row g-2 small">
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>スキャン済み:</span>
                                <strong>${data.total_releases_scanned}件</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>新規作成:</span>
                                <strong class="text-success">${data.new_events}件</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>更新:</span>
                                <strong class="text-info">${data.updated_events}件</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>スキップ:</span>
                                <strong class="text-muted">${data.skipped_events}件</strong>
                            </div>
                        </div>
                    </div>
                    ${data.errors && data.errors.length > 0 ? `
                        <hr class="my-2">
                        <div class="small text-warning">
                            <i class="bi bi-exclamation-triangle"></i> ${data.errors.length}件のエラーが発生しました
                        </div>
                    ` : ''}
                    <div class="small text-muted mt-2">
                        <i class="bi bi-clock"></i> ${new Date(data.sync_date).toLocaleString('ja-JP')}
                    </div>
                </div>
            `;

            // 統計を再読み込み
            loadCalendarStats();

            // 同期履歴を更新
            updateSyncHistory(data);

            // 3ヶ月カレンダーを更新
            loadThreeMonthCalendar();

            showNotification('success', `カレンダー同期完了：${data.new_events}件の新規イベントを作成しました`);
        } else {
            throw new Error(data.error || '同期に失敗しました');
        }
    } catch (error) {
        console.error('カレンダー同期エラー:', error);

        const resultContainer = document.getElementById('calendarSyncResult');
        resultContainer.style.display = 'block';
        resultContainer.innerHTML = `
            <div class="alert alert-danger">
                <h6 class="alert-heading mb-2">
                    <i class="bi bi-x-circle"></i> 同期に失敗しました
                </h6>
                <p class="mb-0 small">${error.message}</p>
            </div>
        `;

        showNotification('error', 'カレンダー同期に失敗しました');
    } finally {
        // ボタンを元に戻す
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// 同期履歴を更新
function updateSyncHistory(syncData) {
    const historyContainer = document.getElementById('calendarSyncHistory');
    const historyHTML = `
        <div class="timeline-item mb-2">
            <i class="bi bi-check-circle-fill text-success"></i>
            <div class="timeline-content">
                <div class="timeline-time small">${new Date(syncData.sync_date).toLocaleString('ja-JP')}</div>
                <div class="timeline-desc small">
                    ${syncData.new_events}件作成、${syncData.updated_events}件更新
                </div>
            </div>
        </div>
    `;

    // 既存の履歴の先頭に追加
    if (historyContainer.querySelector('.timeline-item')) {
        historyContainer.insertAdjacentHTML('afterbegin', historyHTML);

        // 最大5件まで保持
        const items = historyContainer.querySelectorAll('.timeline-item');
        if (items.length > 5) {
            items[items.length - 1].remove();
        }
    } else {
        // 初回の場合は置き換え
        historyContainer.innerHTML = historyHTML;
    }
}

// 3ヶ月カレンダーを読み込む
async function loadThreeMonthCalendar() {
    const container = document.getElementById('threeMonthCalendar');

    try {
        const response = await fetch('/api/calendar/monthly?months=3');
        const data = await response.json();

        if (data.success && data.months) {
            let html = '<div class="row g-3">';

            for (const month of data.months) {
                html += `
                    <div class="col-12 col-lg-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-calendar-month me-2"></i>
                                    ${month.year}年 ${month.month_name}
                                    <span class="badge bg-light text-dark ms-2">${month.event_count}件</span>
                                </h6>
                            </div>
                            <div class="card-body p-2">
                                ${month.events.length > 0 ? `
                                    <div class="list-group list-group-flush">
                                        ${month.events.map(event => `
                                            <div class="list-group-item px-2 py-2">
                                                <div class="d-flex align-items-start">
                                                    <div class="text-center me-2" style="min-width: 40px;">
                                                        <div class="badge bg-secondary">${event.day}</div>
                                                        <small class="text-muted d-block">日</small>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <div class="small fw-bold text-truncate" title="${event.title}">
                                                            ${event.title}
                                                        </div>
                                                        <div class="small text-muted">
                                                            ${event.work_type === 'anime' ?
                                                                '<i class="bi bi-tv"></i> アニメ' :
                                                                '<i class="bi bi-book"></i> マンガ'}
                                                            ${event.platform ? ` · ${event.platform}` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center text-muted py-5">
                                        <i class="bi bi-calendar-x fs-1"></i>
                                        <p class="mb-0 mt-2">予定なし</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            if (data.total_events === 0) {
                html = `
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle me-2"></i>
                        今後3ヶ月間のリリース予定がありません。<br>
                        「今すぐ同期」ボタンでリリース情報を同期してください。
                    </div>
                `;
            }

            container.innerHTML = html;
        } else {
            throw new Error(data.error || 'カレンダーの取得に失敗しました');
        }
    } catch (error) {
        console.error('3ヶ月カレンダーの取得エラー:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                カレンダーの読み込みに失敗しました: ${error.message}
            </div>
        `;
    }
}

// 更新ボタンのイベント
document.getElementById('refreshCalendarBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    loadThreeMonthCalendar();
    showNotification('info', 'カレンダーを更新しています...');
});
</script>

<!-- 収集設定JavaScript -->
<script src="{{ url_for('static', filename='js/collection-settings.js') }}?v={{ 'js/collection-settings.js'|file_mtime }}"></script>

{% endblock %}
