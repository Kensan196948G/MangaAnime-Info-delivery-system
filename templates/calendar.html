{% extends "base.html" %}

{% block title %}ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ - {{ super() }}{% endblock %}

{% block head %}
<!-- Calendar Enhanced CSS -->
<link href="{{ url_for('static', filename='css/calendar-enhanced.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="bi bi-calendar-event me-2" aria-hidden="true"></i>ãƒªãƒªãƒ¼ã‚¹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
            </h2>
            <p class="text-muted">æœˆåˆ¥ã§ã‚¢ãƒ‹ãƒ¡ãƒ»ãƒãƒ³ã‚¬ã®ãƒªãƒªãƒ¼ã‚¹äºˆå®šã‚’ç¢ºèªã§ãã¾ã™ã€‚ã‚¹ãƒ¯ã‚¤ãƒ—ã¾ãŸã¯çŸ¢å°ã‚­ãƒ¼ï¼ˆAlt+â†/â†’ï¼‰ã§æœˆç§»å‹•ã§ãã¾ã™ã€‚</p>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="btn-group" role="group" aria-label="æœˆç§»å‹•ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
                <a href="{{ url_for('calendar', year=current_year if current_month > 1 else current_year - 1, month=current_month-1 if current_month > 1 else 12) }}"
                   class="btn btn-outline-primary calendar-nav-btn"
                   aria-label="å‰æœˆã«ç§»å‹•">
                    <i class="bi bi-chevron-left" aria-hidden="true"></i> å‰æœˆ
                </a>
                <button class="btn btn-primary calendar-nav-btn" disabled aria-current="page">
                    {{ current_year }}å¹´{{ current_month }}æœˆ
                </button>
                <a href="{{ url_for('calendar', year=current_year if current_month < 12 else current_year + 1, month=current_month+1 if current_month < 12 else 1) }}"
                   class="btn btn-outline-primary calendar-nav-btn"
                   aria-label="æ¬¡æœˆã«ç§»å‹•">
                    æ¬¡æœˆ <i class="bi bi-chevron-right" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="card shadow-lg">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered calendar-table mb-0" role="grid" aria-label="ãƒªãƒªãƒ¼ã‚¹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼">
                    <thead>
                        <tr role="row">
                            <th class="text-center py-3" scope="col">æ—¥</th>
                            <th class="text-center py-3" scope="col">æœˆ</th>
                            <th class="text-center py-3" scope="col">ç«</th>
                            <th class="text-center py-3" scope="col">æ°´</th>
                            <th class="text-center py-3" scope="col">æœ¨</th>
                            <th class="text-center py-3" scope="col">é‡‘</th>
                            <th class="text-center py-3" scope="col">åœŸ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set ns = namespace(day_count=0) %}
                        {% for week_num in range(6) %}
                            <tr role="row">
                                {% for day_num in range(7) %}
                                    {% set ns.day_count = ns.day_count + 1 %}
                                    {% set day_of_week = day_num %}
                                    {% set first_day_of_month = (current_year ~ '-' ~ '%02d' % current_month ~ '-01') | strptime('%Y-%m-%d') %}
                                    {% set first_weekday = first_day_of_month.strftime('%w') | int %}
                                    {% set day = ns.day_count - first_weekday %}

                                    {% if day >= 1 and day <= 31 %}
                                        {% set date_str = '%04d-%02d-%02d' % (current_year, current_month, day) %}
                                        {% set day_releases = releases_by_date.get(date_str, []) %}

                                        <td class="calendar-day {% if day_releases|length == 0 %}empty{% endif %}"
                                            data-date="{{ date_str }}"
                                            role="gridcell"
                                            aria-label="{{ date_str }}{% if day_releases|length > 0 %} - {{ day_releases|length }}ä»¶ã®ãƒªãƒªãƒ¼ã‚¹{% endif %}">
                                            <div class="day-header">
                                                <span class="day-number">{{ day }}</span>
                                            </div>

                                            {% if day_releases %}
                                                <div class="releases-container">
                                                    {% for release in day_releases[:5] %}
                                                        <div class="release-item {% if release.type == 'anime' %}anime{% else %}manga{% endif %}"
                                                             title="{{ release.title }} - {% if release.release_type == 'episode' %}ç¬¬{{ release.number }}è©±{% else %}ç¬¬{{ release.number }}å·»{% endif %} ({{ release.platform }})"
                                                             data-platform="{{ release.platform | lower }}"
                                                             data-title="{{ release.title }}">
                                                            <div class="release-content">
                                                                <div class="release-title">
                                                                    {{ release.title }}
                                                                </div>
                                                                <div class="release-details">
                                                                    {% if release.release_type == 'episode' %}ç¬¬{{ release.number }}è©±{% else %}ç¬¬{{ release.number }}å·»{% endif %} Â· {{ release.platform }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}

                                                    {% if day_releases|length > 5 %}
                                                        <div class="more-releases"
                                                             role="button"
                                                             tabindex="0"
                                                             aria-label="{{ day_releases|length - 5 }}ä»¶ã®ãƒªãƒªãƒ¼ã‚¹ã‚’ã•ã‚‰ã«è¡¨ç¤º">
                                                            +{{ day_releases|length - 5 }}ä»¶ ã‚‚ã£ã¨è¦‹ã‚‹
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </td>
                                    {% else %}
                                        <td class="calendar-day empty" role="gridcell" aria-label="ç©ºã®ã‚»ãƒ«"></td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Enhanced Legend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body calendar-legend">
                    <div class="d-flex flex-wrap justify-content-center align-items-center">
                        <div class="legend-item">
                            <div class="legend-color-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                            <span class="legend-label">ã‚¢ãƒ‹ãƒ¡</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"></div>
                            <span class="legend-label">ãƒãƒ³ã‚¬</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color-box" style="background: linear-gradient(135deg, #e50914 0%, #b20710 100%);"></div>
                            <span class="legend-label">Netflix ğŸ¬</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color-box" style="background: linear-gradient(135deg, #00a8e1 0%, #0073bb 100%);"></div>
                            <span class="legend-label">Prime Video ğŸ“º</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color-box" style="background: linear-gradient(135deg, #f78c2c 0%, #f47321 100%);"></div>
                            <span class="legend-label">Crunchyroll ğŸŒ¸</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color-box" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);"></div>
                            <span class="legend-label">dã‚¢ãƒ‹ãƒ¡ã‚¹ãƒˆã‚¢ ğŸ­</span>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
                            å„æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚
                            ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ: Alt+â†ï¼ˆå‰æœˆï¼‰ã€Alt+â†’ï¼ˆæ¬¡æœˆï¼‰
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-primary mb-0">{{ releases_by_date.values() | sum(attribute='__len__') | default(0) }}</h3>
                    <small class="text-muted">ä»Šæœˆã®ãƒªãƒªãƒ¼ã‚¹ç·æ•°</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-success mb-0">{{ releases_by_date.keys() | length }}</h3>
                    <small class="text-muted">ãƒªãƒªãƒ¼ã‚¹äºˆå®šæ—¥æ•°</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h3 class="text-info mb-0">{{ (releases_by_date.values() | sum(attribute='__len__') / (releases_by_date.keys() | length | default(1))) | round(1) }}</h3>
                    <small class="text-muted">1æ—¥ã‚ãŸã‚Šã®å¹³å‡ãƒªãƒªãƒ¼ã‚¹æ•°</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Day Details Modal -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-labelledby="dayModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayModalLabel">
                    <i class="bi bi-calendar-day me-2" aria-hidden="true"></i>
                    <span id="modal-date"></span> ã®ãƒªãƒªãƒ¼ã‚¹äºˆå®š
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1" aria-hidden="true"></i>é–‰ã˜ã‚‹
                </button>
                <button type="button" class="btn btn-primary" onclick="addToGoogleCalendar()">
                    <i class="bi bi-calendar-plus me-1" aria-hidden="true"></i>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ 
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- ãƒªãƒªãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã«æ¸¡ã™ -->
<script>
    window.releasesData = {{ releases_by_date | tojson }};
</script>
<!-- Calendar Enhanced JS -->
<script src="{{ url_for('static', filename='js/calendar-enhanced.js') }}"></script>
{% endblock %}
