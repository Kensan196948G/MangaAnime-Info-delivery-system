{% extends "base.html" %}

{% block title %}APIキー管理 - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-key me-2"></i>APIキー管理</h2>
            <p class="text-muted">プログラムからAPIにアクセスするためのキーを管理します</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateKeyModal">
                <i class="bi bi-plus-circle me-1"></i>新しいAPIキーを生成
            </button>
        </div>
    </div>

    <!-- APIキー一覧 -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">APIキー一覧</h5>
        </div>
        <div class="card-body">
            {% if api_keys %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>キー名</th>
                            <th>キー</th>
                            <th>権限</th>
                            <th>作成日時</th>
                            <th>最終利用</th>
                            <th>ステータス</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in api_keys %}
                        <tr>
                            <td><strong>{{ key.name }}</strong></td>
                            <td>
                                <code class="text-muted">{{ key.key[:20] }}...</code>
                                <button class="btn btn-sm btn-outline-secondary copy-btn" 
                                        data-key="{{ key.key }}" title="コピー">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </td>
                            <td>
                                {% set perms = key.permissions.split(',') %}
                                {% for perm in perms %}
                                <span class="badge bg-info">{{ perm }}</span>
                                {% endfor %}
                            </td>
                            <td>{{ key.created_at.strftime('%Y-%m-%d %H:%M') if key.created_at else '-' }}</td>
                            <td>
                                {% if key.last_used %}
                                {{ key.last_used.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                <span class="text-muted">未使用</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if key.is_active %}
                                <span class="badge bg-success">有効</span>
                                {% else %}
                                <span class="badge bg-secondary">無効</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if key.is_active %}
                                <form method="POST" action="{{ url_for('api_key.revoke', key=key.key) }}" 
                                      style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-danger" 
                                            onclick="return confirm('このAPIキーを無効化しますか？')">
                                        <i class="bi bi-x-circle"></i> 無効化
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-key" style="font-size: 4rem; color: #ddd;"></i>
                <p class="text-muted mt-3">APIキーがありません</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateKeyModal">
                    <i class="bi bi-plus-circle me-1"></i>最初のAPIキーを生成
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 使用例 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">APIキーの使用方法</h5>
        </div>
        <div class="card-body">
            <h6>cURLでの使用例:</h6>
            <pre><code>curl -H "X-API-Key: YOUR_API_KEY" http://localhost:5000/api/stats</code></pre>
            
            <h6 class="mt-3">Pythonでの使用例:</h6>
            <pre><code>import requests

headers = {"X-API-Key": "YOUR_API_KEY"}
response = requests.get("http://localhost:5000/api/stats", headers=headers)
print(response.json())</code></pre>
        </div>
    </div>
</div>

<!-- APIキー生成モーダル -->
<div class="modal fade" id="generateKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新しいAPIキーを生成</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('api_key.generate') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="keyName" class="form-label">キー名</label>
                        <input type="text" class="form-control" id="keyName" name="name" 
                               required placeholder="例: Production API Key">
                        <div class="form-text">識別用のわかりやすい名前を付けてください</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">権限</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="read" 
                                   id="permRead" name="permissions" checked>
                            <label class="form-check-label" for="permRead">
                                読み取り（read）
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="write" 
                                   id="permWrite" name="permissions">
                            <label class="form-check-label" for="permWrite">
                                書き込み（write）
                            </label>
                        </div>
                        <div class="form-text">必要な権限を選択してください</div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>重要:</strong> 生成されたAPIキーは一度しか表示されません。必ず安全な場所に保存してください。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-primary">生成</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// コピー機能
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.copy-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const key = this.dataset.key;
            navigator.clipboard.writeText(key).then(function() {
                // 成功フィードバック
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i>';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                
                setTimeout(function() {
                    btn.innerHTML = original;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            });
        });
    });
    
    // 権限チェックボックスの処理
    const checkboxes = document.querySelectorAll('input[name="permissions"]');
    const permInput = document.createElement('input');
    permInput.type = 'hidden';
    permInput.name = 'permissions';
    
    if (checkboxes.length > 0) {
        checkboxes[0].closest('form').appendChild(permInput);
        
        checkboxes.forEach(function(cb) {
            cb.addEventListener('change', function() {
                const checked = Array.from(checkboxes)
                    .filter(function(c) { return c.checked; })
                    .map(function(c) { return c.value; });
                permInput.value = checked.join(',');
            });
        });
        
        // 初期値設定
        permInput.value = 'read';
    }
});
</script>
{% endblock %}
