# メール配信システム概要

## 📧 システム概要

MangaAnime情報配信システムのメール配信機能は、アニメ・マンガの新着情報を自動的に収集し、登録ユーザーへGmail経由で通知する自動配信システムです。

### 主な特徴

- ✅ **完全自動化**: cronによる定時実行で人手を介さずに配信
- ✅ **スマート分散**: 大量通知を自動的に複数回に分散
- ✅ **日本語対応**: 英語タイトルを自動的に日本語に変換
- ✅ **リトライ機能**: 送信失敗時の自動再送信
- ✅ **レート制限対応**: Gmail APIの制限を考慮した送信制御

## 🏗️ システムアーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│                  情報収集レイヤー                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ AniList  │  │しょぼカレ │  │  RSS     │        │
│  │   API    │  │   API    │  │ フィード  │        │
│  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────┬───────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────┐
│                データ処理レイヤー                      │
│  ┌──────────────┐  ┌─────────────┐                │
│  │ タイトル変換  │  │ フィルタリング │                │
│  │   (日本語化)  │  │  (NGワード)   │                │
│  └──────────────┘  └─────────────┘                │
└─────────────────┬───────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────┐
│                 データ保存レイヤー                     │
│  ┌────────────────────────────────────┐              │
│  │          SQLite Database           │              │
│  │  - works テーブル                  │              │
│  │  - releases テーブル               │              │
│  │  - notification_history テーブル   │              │
│  └────────────────────────────────────┘              │
└─────────────────┬───────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────┐
│                  配信制御レイヤー                      │
│  ┌──────────────┐  ┌─────────────┐                │
│  │ スケジューラ  │  │ バッチ処理   │                │
│  │   (cron)     │  │   エンジン    │                │
│  └──────────────┘  └─────────────┘                │
└─────────────────┬───────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────┐
│                   配信実行レイヤー                     │
│  ┌──────────────┐  ┌─────────────┐                │
│  │  Gmail API   │  │ Google       │                │
│  │   (SMTP)     │  │  Calendar    │                │
│  └──────────────┘  └─────────────┘                │
└─────────────────────────────────────────────────────┘
```

## 📊 配信スケジュール

### 通常配信パターン

| 通知件数 | 配信時刻 | 説明 |
|---------|---------|------|
| 1-99件 | 朝8時のみ | 少量の通知は1回で配信 |
| 100-199件 | 朝8時、夜20時 | 中量の通知は2回に分散 |
| 200件以上 | 朝8時、昼12時、夜20時 | 大量の通知は3回に分散 |

### 配信時刻（JST）

```
08:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━ メイン配信
      │
      │  ＜100件未満なら完了＞
      │
12:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 追加配信①
      │
      │  ＜200件以上の場合のみ＞
      │
20:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 追加配信②
      │
      │  ＜100件以上の場合＞
      │
02:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━ ログローテーション
```

## 🔧 主要コンポーネント

### 1. メール送信モジュール (`modules/mailer.py`)

- **GmailNotifier**: Gmail API連携クラス
  - OAuth2認証管理
  - トークン自動更新
  - レート制限対応
  - リトライ機能

- **EmailTemplateGenerator**: HTMLメール生成クラス
  - レスポンシブデザイン
  - 日本語対応
  - アニメ/マンガ別セクション

### 2. タイトル変換モジュール (`modules/title_translator.py`)

- 英語タイトル → 日本語タイトル変換
- 50以上のタイトルマッピング
- シーズン番号の自動処理

### 3. スケジューラモジュール (`modules/email_scheduler.py`)

- 通知数に応じた自動分散
- バッチサイズ最適化
- 配信時刻管理

## 📈 パフォーマンス指標

### Gmail API制限

| 制限項目 | 制限値 | 対策 |
|---------|--------|------|
| 送信数/日 | 250通 | バッチ処理で分散 |
| API呼び出し/分 | 250回 | レート制限実装 |
| メールサイズ | 25MB | 画像最適化 |

### システム性能

- 平均送信時間: 2-3秒/通
- リトライ成功率: 95%以上
- エラー自動復旧: 実装済み

## 🔐 セキュリティ

### 認証方式

1. **OAuth2.0**: ユーザー認証
2. **App Password**: SMTP認証（2段階認証必須）
3. **トークン管理**: 自動更新・暗号化保存

### データ保護

- パスワード: 環境変数で管理（.env）
- トークン: ファイル権限制限（600）
- 通信: TLS暗号化

## 📝 ログ管理

### ログファイル構成

```
logs/
├── daily_delivery.log    # 日次配信ログ
├── app.log              # アプリケーションログ
├── error_monitor.log    # エラー監視ログ
└── backup_*.log         # バックアップログ
```

### ログローテーション

- 保持期間: 7日間
- 自動削除: 毎日午前2時
- 形式: タイムスタンプ付きプレーンテキスト

## 🚀 今後の拡張予定

1. **LINE通知対応**: LINE Notifyとの連携
2. **Slack連携**: ビジネスユーザー向け
3. **配信カスタマイズ**: ユーザー別配信時刻設定
4. **多言語対応**: 英語・中国語対応
5. **プッシュ通知**: モバイルアプリ連携

## 📞 サポート情報

問題が発生した場合は、以下の順序で確認してください：

1. [トラブルシューティングガイド](./トラブルシューティング.md)を参照
2. ログファイルを確認（`logs/daily_delivery.log`）
3. [運用マニュアル](./運用マニュアル.md)の該当セクションを確認

---

*最終更新: 2024年8月*