# ユーザー管理機能 - クイックスタート

## 概要
管理者専用のユーザー管理画面が実装されました。ユーザーの作成・削除・権限管理を行えます。

## クイックスタート

### 自動セットアップ（推奨）

```bash
# プロジェクトルートで実行
bash scripts/setup_user_management.sh
```

このスクリプトが自動的に:
- ✅ auth.pyにUserStoreメソッドを追加
- ✅ web_app.pyにBlueprint登録
- ✅ base.htmlにナビゲーション追加
- ✅ バックアップファイル作成

### 手動セットアップ

詳細は以下を参照:
```bash
cat docs/USER_MANAGEMENT_INTEGRATION.md
```

## 実装済みファイル

```
MangaAnime-Info-delivery-system/
├── app/
│   └── routes/
│       └── users.py                    # ユーザー管理ルート（新規）
├── templates/
│   └── users/
│       └── list.html                   # ユーザー管理UI（新規）
├── scripts/
│   ├── integrate_user_management.py   # 統合スクリプト（新規）
│   └── setup_user_management.sh       # セットアップスクリプト（新規）
└── docs/
    └── USER_MANAGEMENT_INTEGRATION.md # 統合ガイド（新規）
```

## 機能一覧

### ユーザー一覧
- ユーザー名、権限、作成日、最終ログイン表示
- リアルタイム統計情報（総数、管理者数、一般ユーザー数）

### 新規ユーザー作成
- ユーザー名（3文字以上、英数字_-のみ）
- パスワード（6文字以上）
- 管理者権限の付与

### ユーザー削除
- 確認モーダル付き安全な削除
- 自分自身は削除不可

### 権限管理
- ワンクリックで管理者権限の切り替え
- 自分自身の権限は変更不可

## アクセス方法

1. **アプリケーション起動**
   ```bash
   python3 app/web_app.py
   ```

2. **ブラウザでアクセス**
   ```
   http://localhost:5000/
   ```

3. **管理者でログイン**
   - デフォルト管理者アカウントでログイン

4. **ユーザー管理画面を開く**
   - ナビゲーションバーの「ユーザー管理」をクリック
   - または直接アクセス: `http://localhost:5000/users/`

## セキュリティ機能

- ✅ **CSRF保護**: すべてのフォームにCSRFトークン
- ✅ **管理者権限チェック**: @admin_requiredデコレーター
- ✅ **ログイン必須**: @login_requiredデコレーター
- ✅ **自己削除防止**: 自分自身を削除できない
- ✅ **自己権限変更防止**: 自分の権限を変更できない
- ✅ **パスワードハッシュ化**: SHA-256でハッシュ化
- ✅ **入力バリデーション**: フロントエンド・バックエンド両方

## デザイン特徴

- Bootstrap 5準拠
- レスポンシブデザイン（モバイル対応）
- モダンなカードレイアウト
- ホバーエフェクト
- アクセシビリティ対応（ARIA属性）
- アイコン使用（Bootstrap Icons）

## API エンドポイント

### GET /users/
**権限**: 管理者のみ
**説明**: ユーザー一覧ページを表示

### POST /users/create
**権限**: 管理者のみ
**パラメータ**:
- username (string): ユーザー名
- password (string): パスワード
- is_admin (checkbox): 管理者フラグ

### POST /users/<user_id>/delete
**権限**: 管理者のみ
**説明**: 指定ユーザーを削除

### POST /users/<user_id>/toggle-admin
**権限**: 管理者のみ
**レスポンス**: JSON
```json
{
  "success": true,
  "is_admin": true,
  "message": "管理者権限を付与しました"
}
```

### GET /users/api/stats
**権限**: 管理者のみ
**レスポンス**: JSON
```json
{
  "total_users": 10,
  "admin_users": 2,
  "regular_users": 8
}
```

## スクリーンショット例

### ユーザー一覧画面
```
┌────────────────────────────────────────────────────┐
│ ユーザー管理                    [新規ユーザー作成] │
├────────────────────────────────────────────────────┤
│ 統計情報                                            │
│ [総ユーザー数: 10] [管理者: 2] [一般: 8]          │
├────────────────────────────────────────────────────┤
│ # │ ユーザー名 │ 権限 │ 作成日 │ 操作             │
│ 1 │ admin      │ 管理者│ ...   │ [権限][削除]    │
│ 2 │ user1      │ 一般  │ ...   │ [権限][削除]    │
└────────────────────────────────────────────────────┘
```

## トラブルシューティング

### Q: 統合スクリプトが失敗する
**A**: 手動統合を試してください
```bash
cat docs/USER_MANAGEMENT_INTEGRATION.md
```

### Q: 「管理者のみ」エラーが表示される
**A**: 現在のユーザーが管理者権限を持っているか確認してください

### Q: モーダルが表示されない
**A**: Bootstrap 5のJavaScriptが読み込まれているか確認
```html
<!-- base.htmlに以下が含まれているか確認 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
```

### Q: バックアップから復元したい
**A**: .bakファイルから復元
```bash
# 例: auth.pyを復元
cp app/routes/auth.py.bak app/routes/auth.py
```

## 次のステップ

### 推奨される拡張機能
1. **パスワード変更機能**: ユーザー自身がパスワードを変更できる
2. **プロフィール編集**: 追加情報の入力
3. **ロール管理**: より細かい権限設定（RBAC）
4. **監査ログ**: ユーザー操作履歴の記録
5. **メール通知**: アカウント作成時の自動通知
6. **2要素認証**: セキュリティ強化
7. **エクスポート/インポート**: CSV一括処理
8. **パスワードリセット**: セキュアなリセット機能

### 実装優先度
1. **高**: パスワード変更、監査ログ
2. **中**: プロフィール編集、メール通知
3. **低**: エクスポート/インポート、2要素認証

## テスト

### 機能テストチェックリスト

- [ ] ユーザー作成（正常系）
- [ ] ユーザー作成（重複エラー）
- [ ] ユーザー作成（バリデーションエラー）
- [ ] 権限切り替え（管理者→一般）
- [ ] 権限切り替え（一般→管理者）
- [ ] 権限切り替え（自分自身 - エラー）
- [ ] ユーザー削除（正常系）
- [ ] ユーザー削除（自分自身 - エラー）
- [ ] 統計情報の正確性
- [ ] 非管理者のアクセス拒否
- [ ] CSRFトークン検証

### ブラウザ互換性

- ✅ Chrome 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Edge 90+

## サポート

問題が発生した場合:
1. `docs/USER_MANAGEMENT_INTEGRATION.md` を確認
2. バックアップファイル(.bak)から復元
3. GitHubでIssueを作成

## ライセンス

このプロジェクトと同じライセンスが適用されます。

## 変更履歴

### v1.0.0 (2025-12-07)
- 初回リリース
- ユーザーCRUD機能実装
- Bootstrap 5ベースUI
- 自動統合スクリプト
- セキュリティ対策実装

---

**重要**: 本番環境にデプロイする前に、必ずセキュリティレビューを実施してください。
