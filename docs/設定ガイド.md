# メール配信システム設定ガイド

## 📋 目次

1. [前提条件](#前提条件)
2. [Gmail設定](#gmail設定)
3. [環境設定](#環境設定)
4. [スケジュール設定](#スケジュール設定)
5. [動作確認](#動作確認)

---

## 前提条件

### 必要な環境

- **OS**: Ubuntu 20.04以上 / macOS 10.15以上
- **Python**: 3.11以上
- **Gmail**: 2段階認証が有効なアカウント
- **タイムゾーン**: Asia/Tokyo（JST）

### 必要なパッケージ

```bash
# システムパッケージ
sudo apt-get update
sudo apt-get install -y python3-pip python3-venv cron

# Python パッケージ（requirements.txt）
google-auth==2.23.0
google-auth-oauthlib==1.1.0
google-auth-httplib2==0.1.1
google-api-python-client==2.100.0
python-dotenv==1.0.0
```

---

## Gmail設定

### ステップ1: 2段階認証の有効化

1. [Googleアカウント設定](https://myaccount.google.com/security)にアクセス
2. 「セキュリティ」→「2段階認証プロセス」を選択
3. 指示に従って2段階認証を有効化

### ステップ2: アプリパスワードの生成

1. [アプリパスワード設定](https://myaccount.google.com/apppasswords)にアクセス
2. アプリ名に「MangaAnime配信システム」と入力
3. 生成された16文字のパスワードをコピー

```bash
# 例: sxsg mzbv ubsa jtok
```

### ステップ3: OAuth2認証の設定

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成または既存のプロジェクトを選択
3. Gmail APIを有効化

```bash
# APIを有効化
gcloud services enable gmail.googleapis.com
```

4. 認証情報を作成

```json
// credentials.json の例
{
  "installed": {
    "client_id": "YOUR_CLIENT_ID.apps.googleusercontent.com",
    "client_secret": "YOUR_CLIENT_SECRET",
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://oauth2.googleapis.com/token",
    "redirect_uris": ["urn:ietf:wg:oauth:2.0:oob", "http://localhost"]
  }
}
```

---

## 環境設定

### ステップ1: 環境変数の設定（.env ファイル）

```bash
# .env ファイルを作成
cat << 'EOF' > .env
# Gmail設定
GMAIL_APP_PASSWORD=sxsgmzbvubsajtok
GMAIL_SENDER_EMAIL=kensan1969@gmail.com
GMAIL_RECIPIENT_EMAIL=kensan1969@gmail.com

# システム設定
TZ=Asia/Tokyo
LOG_LEVEL=INFO
EOF

# ファイル権限を設定（セキュリティ対策）
chmod 600 .env
```

### ステップ2: config.json の設定

```json
{
  "notification_email": "kensan1969@gmail.com",
  "email": {
    "smtp_server": "smtp.gmail.com",
    "smtp_port": 587,
    "sender_email": "kensan1969@gmail.com",
    "sender_password": "${GMAIL_APP_PASSWORD}",
    "use_tls": true,
    "timeout": 30
  },
  "google": {
    "credentials_file": "credentials.json",
    "token_file": "token.json",
    "scopes": [
      "https://www.googleapis.com/auth/gmail.send",
      "https://www.googleapis.com/auth/calendar"
    ],
    "gmail": {
      "from_email": "kensan1969@gmail.com",
      "to_email": "kensan1969@gmail.com",
      "subject_prefix": "[MangaAnime]"
    }
  },
  "notification": {
    "batch_size": 50,
    "delay_between_batches": 2,
    "max_retries": 3,
    "email": {
      "enabled": true,
      "include_images": true,
      "html_template": "default"
    }
  },
  "schedule": {
    "distribution": {
      "small": {
        "threshold": 100,
        "times": ["08:00"]
      },
      "medium": {
        "threshold": 200,
        "times": ["08:00", "20:00"]
      },
      "large": {
        "threshold": null,
        "times": ["08:00", "12:00", "20:00"]
      }
    }
  }
}
```

### ステップ3: ディレクトリ構造の確認

```bash
# 必要なディレクトリを作成
mkdir -p logs
mkdir -p data
mkdir -p templates

# 権限設定
chmod 755 logs data templates
```

---

## スケジュール設定

### 自動設定スクリプトの実行

```bash
# スケジュール設定スクリプトを実行
./scripts/setup_daily_delivery.sh install

# 出力例：
# [INFO] 前提条件をチェックしています...
# [INFO] 現在のタイムゾーン: Asia/Tokyo
# [SUCCESS] 前提条件チェック完了
# [INFO] 配信スケジュールをインストールしています...
# [SUCCESS] 配信スケジュールをインストールしました
# [INFO] 配信時刻:
#   ・朝8時   - メイン配信
#   ・昼12時  - 大量通知時の追加配信
#   ・夜20時  - 大量通知時の追加配信
```

### 手動でのcrontab設定

```bash
# crontabを編集
crontab -e

# 以下を追加
# MangaAnime Notification System - Daily Delivery
# 朝8時（JST）- メインの配信時刻
0 8 * * * cd /path/to/project && python3 release_notifier.py >> logs/daily_delivery.log 2>&1

# 昼12時（JST）- 大量通知時の追加配信
0 12 * * * cd /path/to/project && python3 release_notifier.py >> logs/daily_delivery.log 2>&1

# 夜20時（JST）- 大量通知時の追加配信
0 20 * * * cd /path/to/project && python3 release_notifier.py >> logs/daily_delivery.log 2>&1

# 毎日午前2時にログローテーション
0 2 * * * find /path/to/project/logs -name "*.log" -type f -mtime +7 -delete
```

### タイムゾーンの確認と設定

```bash
# 現在のタイムゾーンを確認
timedatectl status

# 日本時間に設定
sudo timedatectl set-timezone Asia/Tokyo

# 確認
date
# 出力例: 2024年 8月15日 木曜日 21:30:00 JST
```

---

## 動作確認

### ステップ1: 設定の検証

```bash
# 設定検証スクリプトを実行
python3 scripts/validate_config.py

# 出力例：
# ✅ Gmail App Password: 設定済み
# ✅ 送信元メール: kensan1969@gmail.com
# ✅ 送信先メール: kensan1969@gmail.com
# ✅ SMTP設定: smtp.gmail.com:587
# ✅ タイムゾーン: Asia/Tokyo
# ✅ crontab: 3エントリ設定済み
```

### ステップ2: テストメール送信

```bash
# テストメール送信
python3 scripts/test_email.py

# 出力例：
# 📧 メール配信テスト開始
#    送信元: kensan1969@gmail.com
#    送信先: kensan1969@gmail.com
#    SMTPサーバー: smtp.gmail.com:587
# 
# 🔄 SMTP接続中...
# 🔐 認証中...
# 📤 メール送信中...
# ✅ メール送信成功！
#    kensan1969@gmail.com にテストメールを送信しました
```

### ステップ3: ドライラン実行

```bash
# 実際にメールを送信せずに動作確認
python3 release_notifier.py --dry-run --verbose

# 出力例：
# [DRY-RUN MODE] メールは送信されません
# 📊 処理対象: 1041件の未通知
# 📧 配信スケジュール:
#   - バッチ1: 347件 (08:00)
#   - バッチ2: 347件 (12:00)
#   - バッチ3: 347件 (20:00)
```

### ステップ4: ログ確認

```bash
# リアルタイムログ監視
tail -f logs/daily_delivery.log

# 最新のエラーを確認
grep ERROR logs/daily_delivery.log | tail -20

# 配信統計を確認
grep "配信完了" logs/daily_delivery.log | wc -l
```

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. Gmail認証エラー

```bash
# エラー例
smtplib.SMTPAuthenticationError: (535, b'5.7.8 Username and Password not accepted')

# 解決方法
1. 2段階認証が有効か確認
2. アプリパスワードを再生成
3. .envファイルを更新
4. スペースが含まれていないか確認
```

#### 2. タイムゾーンの問題

```bash
# 問題: メールが予定時刻に送信されない

# 解決方法
# システムのタイムゾーンを確認
timedatectl status

# cronのタイムゾーンを確認
crontab -e
# 先頭に追加: TZ=Asia/Tokyo
```

#### 3. 権限エラー

```bash
# エラー例
PermissionError: [Errno 13] Permission denied: 'logs/daily_delivery.log'

# 解決方法
chmod 755 logs
chmod 644 logs/*.log
```

### デバッグモード

```bash
# 詳細ログを有効化
export LOG_LEVEL=DEBUG
python3 release_notifier.py --verbose

# SQLクエリログを有効化
export SQL_DEBUG=1
python3 release_notifier.py
```

---

## セキュリティベストプラクティス

### 1. ファイル権限

```bash
# 重要ファイルの権限設定
chmod 600 .env                  # 環境変数
chmod 600 credentials.json      # OAuth認証情報
chmod 600 token.json            # アクセストークン
chmod 755 scripts/*.sh          # スクリプト
```

### 2. パスワード管理

- ❌ ハードコーディングしない
- ❌ Gitにコミットしない
- ✅ 環境変数を使用
- ✅ .gitignoreに追加

```bash
# .gitignore に追加
.env
credentials.json
token.json
*.log
```

### 3. API制限対策

```python
# レート制限の設定例
GMAIL_API_LIMITS = {
    "daily_quota": 250,           # 1日の送信上限
    "per_user_rate_limit": 250,   # 1分あたりの上限
    "batch_size": 50,              # バッチサイズ
    "retry_delay": 2               # リトライ間隔（秒）
}
```

---

## 次のステップ

設定が完了したら、以下のドキュメントも参照してください：

1. [運用マニュアル](./運用マニュアル.md) - 日常的な運用方法
2. [トラブルシューティング](./トラブルシューティング.md) - 問題解決ガイド
3. [API仕様書](./API仕様書.md) - 技術的な詳細

---

*最終更新: 2024年8月*