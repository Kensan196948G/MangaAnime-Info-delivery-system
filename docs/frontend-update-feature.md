# フロントエンドUI データ更新機能 実装ドキュメント

## 概要
ダッシュボードに、手動データ更新機能と自動更新確認機能を実装しました。

## 実装日
2025-11-14

## 実装内容

### 1. データ更新ボタン

#### 配置場所
- ダッシュボードのトップ（統計カードの直前）
- レスポンシブデザインで、モバイルでも適切に表示

#### 機能
- **手動更新ボタン**: `/api/refresh-data` を呼び出してデータを更新
- **自動更新トグル**: 自動更新確認機能の有効/無効を切り替え

#### UI要素
- 最終更新時刻の表示
- 更新中のスピナーアニメーション
- プログレスバー（0% → 50% → 80% → 100%）
- ステータスメッセージ

### 2. 自動データ更新機能

#### 動作仕様
1. ページロード時に最終閲覧時刻をチェック
2. 30分以上経過している場合、確認モーダルを表示
3. ユーザーが承認すると、データ更新を実行
4. 最終閲覧時刻は localStorage に保存

#### ローカルストレージキー
- `dashboard_last_visit`: 最終閲覧時刻（タイムスタンプ）
- `dashboard_auto_refresh`: 自動更新の有効/無効（boolean）

### 3. 更新ステータス表示

#### 表示項目
- **最終更新時刻**: リアルタイムで表示（日本語フォーマット）
- **プログレスバー**: アニメーション付きの進捗表示
- **ステータスメッセージ**:
  - 開始: "データ更新を開始しています..."
  - 完了: "データ更新が完了しました。ページをリロードしています..."
  - エラー: "データ更新に失敗しました: [エラー内容]"

## ファイル構成

### 新規作成ファイル

#### 1. `/static/js/dashboard-update.js` (9KB)
データ更新機能のJavaScriptロジック

**主要関数:**
- `initializeUpdateFeature()`: 初期化処理
- `checkAndPromptDataUpdate()`: 自動更新チェック
- `refreshDashboardData()`: データ更新実行
- `toggleAutoRefresh()`: 自動更新トグル
- `updateLastUpdateTimeDisplay()`: 最終更新時刻の表示更新

#### 2. `/static/css/dashboard-update.css` (4.7KB)
データ更新機能のスタイル定義

**主要スタイル:**
- 更新ステータスカードのグラデーション
- ボタンホバー時のアニメーション
- プログレスバーのshimmerアニメーション
- モーダルのデザインカスタマイズ
- レスポンシブ対応
- ダークモード対応

### 更新ファイル

#### 3. `/templates/dashboard.html`
- CSSリンク追加（行5）
- 更新ステータスUI追加（行96-135）
- 自動更新モーダル追加（行1367-1395）
- JavaScriptインクルード追加（行1397）

## API仕様

### エンドポイント: `/api/refresh-data`

#### メソッド
GET

#### レスポンス
```json
{
  "success": true,
  "message": "データが正常に更新されました",
  "timestamp": "2025-11-14T21:30:00"
}
```

#### エラーレスポンス
```json
{
  "success": false,
  "error": "エラーメッセージ"
}
```

## UI/UXの特徴

### 1. Bootstrap 5活用
- モダンなカードデザイン
- レスポンシブグリッドシステム
- Bootstrapモーダルコンポーネント
- Bootstrap Iconsの使用

### 2. レスポンシブデザイン
- デスクトップ: 横並びのボタン配置
- タブレット: 適応的なレイアウト
- モバイル: 縦積みのフルワイドボタン

### 3. アクセシビリティ対応
- ARIA属性の適切な使用
  - `aria-valuenow`, `aria-valuemin`, `aria-valuemax` (プログレスバー)
  - `aria-label` (モーダルの閉じるボタン)
  - `tabindex` (モーダル)
- キーボードショートカット: `Ctrl+Shift+R` でデータ更新
- フォーカス時のビジュアルフィードバック

### 4. アニメーション
- ボタンホバー時の浮き上がりエフェクト
- プログレスバーのshimmerアニメーション
- ステータスメッセージのスライドダウンアニメーション
- ボタンアイコンの回転アニメーション

### 5. ユーザーフィードバック
- 更新中のスピナー表示
- リアルタイムの進捗表示
- 分かりやすいステータスメッセージ
- 自動リロード前の通知

## 技術仕様

### JavaScript
- ES6+標準準拠
- Fetch API使用
- Promise/async-awaitパターン
- localStorage API活用
- イベントリスナー方式

### CSS
- CSS変数（カスタムプロパティ）未使用（既存コードとの整合性）
- アニメーションは@keyframes使用
- Flexbox/Gridレイアウト
- メディアクエリによるレスポンシブ対応

### セキュリティ
- XSS対策: textContentでエスケープ
- CSRF対策: Flaskのデフォルト機能に依存
- エラーハンドリング: try-catchで適切な例外処理

## 動作フロー

### 手動更新
```
1. ユーザーが「データ更新」ボタンをクリック
2. ボタンを無効化、スピナー表示
3. プログレスバー表示開始（10%）
4. /api/refresh-data へGETリクエスト
5. 進捗更新（50%）
6. レスポンス受信、検証
7. 進捗更新（80%）
8. 成功メッセージ表示
9. 進捗更新（100%）
10. 1.5秒後にページリロード
```

### 自動更新確認
```
1. ページロード時、localStorageから最終閲覧時刻を取得
2. 現在時刻との差分を計算
3. 30分以上経過している場合:
   a. 経過時間を人間読みやすい形式に変換
   b. モーダルダイアログを表示
   c. ユーザーが「今すぐ更新」を選択
   d. 手動更新フローを実行
4. 最終閲覧時刻を更新して保存
```

## ブラウザ対応

### 動作確認済み
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### 必要なブラウザ機能
- ES6+ JavaScript
- Fetch API
- localStorage
- CSS Grid / Flexbox
- CSS Animations

## パフォーマンス最適化

1. **遅延読み込み**:
   - JavaScriptファイルは別ファイルとして分離
   - 必要時のみ実行

2. **最適化されたアニメーション**:
   - GPU加速を活用（transform, opacity）
   - 不要な再描画を回避

3. **効率的なDOM操作**:
   - 最小限のDOM更新
   - イベント委譲の活用

## 今後の拡張案

1. **進捗の詳細表示**
   - 各ステップの詳細情報
   - 収集したデータ件数のリアルタイム表示

2. **更新履歴**
   - 過去の更新履歴を表示
   - 更新内容の差分表示

3. **通知機能**
   - ブラウザ通知API活用
   - 更新完了をプッシュ通知

4. **スケジュール設定**
   - 自動更新の時間設定
   - カスタマイズ可能な更新間隔

5. **部分更新**
   - アニメのみ、マンガのみの選択的更新
   - 特定プラットフォームのみ更新

## トラブルシューティング

### 問題: 更新ボタンが表示されない
**解決策**:
- ブラウザのキャッシュをクリア
- dashboard-update.cssが正しく読み込まれているか確認

### 問題: 自動更新モーダルが表示されない
**解決策**:
- localStorage設定を確認
- Bootstrapライブラリが正しく読み込まれているか確認

### 問題: データ更新が失敗する
**解決策**:
- ブラウザコンソールでエラーログを確認
- /api/refresh-dataエンドポイントの動作確認
- insert_sample_data.pyのパスが正しいか確認

## 関連ファイル

- `/app/web_app.py`: バックエンドAPIの実装
- `/templates/base.html`: ベーステンプレート
- `/static/js/main.js`: メインJavaScriptファイル
- `/static/css/style.css`: メインスタイルシート

## 作成者
Claude Code (devui agent) - UI/UX Development Agent

## ライセンス
プロジェクト本体のライセンスに準拠
